<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini TTS ä¸“ä¸šç‰ˆ</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23D4754E;stop-opacity:1' /%3E%3Cstop offset='50%25' style='stop-color:%23C86240;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%239B5D42;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='50' cy='50' r='48' fill='url(%23grad)'/%3E%3Cpath d='M35 38 Q50 28 65 38 L65 62 Q50 72 35 62 Z' fill='%23FFF9F0' opacity='0.95'/%3E%3Cellipse cx='50' cy='43' rx='9' ry='7' fill='url(%23grad)'/%3E%3C/svg%3E">
    <style>
        /* ========== CSS å˜é‡ç³»ç»Ÿ - ä¼˜é›…æš–è°ƒé…è‰² ========== */
        :root {
            /* ä¸»è‰²è°ƒ - Terracotta & Sienna é™¶åœŸè‰²ç³» */
            --primary-terracotta: #D4754E;
            --primary-sienna: #C86240;
            --accent-amber: #E8A87C;
            --accent-bronze: #9B5D42;
            
            /* è¾…åŠ©è‰² - æ¸©æš–ç±³è‰²ç³»ï¼ˆæ›´æœ‰è®¾è®¡æ„Ÿï¼‰ */
            --bg-primary: #F8F6F4;
            --bg-secondary: #EDE8E4;
            --bg-card: rgba(248, 246, 244, 0.88);
            --text-primary: #2D2424;
            --text-secondary: #6B5E5E;
            --border-color: rgba(212, 117, 78, 0.14);
            --shadow-sm: rgba(155, 93, 66, 0.09);
            --shadow-md: rgba(155, 93, 66, 0.14);
            --shadow-lg: rgba(155, 93, 66, 0.20);
            
            /* ç‚¹ç¼€è‰² */
            --sage-green: #8A9A8E;
            --cream: #FFF9F0;
            --charcoal: #3D3434;
            
            /* è¡¨é¢è‰²å±‚çº§ï¼ˆç»Ÿä¸€ç©ºç™½ä¸å¡ç‰‡çš„è§†è§‰ç³»ç»Ÿï¼‰ */
            --surface-1: rgba(248, 246, 244, 0.90);
            --surface-2: #F0EBE7;
            --surface-3: #E6DED8;
            --grid-line-color: rgba(61, 52, 52, 0.06);
            
            /* å¸ƒå±€ */
            --sidebar-width: 280px;
            --history-width: 280px;
            --header-height: 60px;
            --player-height: 84px;
            --player-height-collapsed: 56px;
            --border-radius: 20px;
            --border-radius-sm: 14px;
            
            /* åŠ¨ç”» */
            --transition-smooth: cubic-bezier(0.4, 0, 0.2, 1);
            --transition-bounce: cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        [data-theme="dark"] {
            --bg-primary: #1A1514;
            --bg-secondary: #2A2220;
            --bg-card: rgba(42, 34, 32, 0.85);
            --text-primary: #F5EDE8;
            --text-secondary: #B8ADA8;
            --border-color: rgba(212, 117, 78, 0.15);
            --shadow-sm: rgba(0, 0, 0, 0.25);
            --shadow-md: rgba(0, 0, 0, 0.35);
            --shadow-lg: rgba(0, 0, 0, 0.45);
            --cream: #2A2220;
            --charcoal: #F5EDE8;
            --surface-1: rgba(42, 34, 32, 0.88);
            --surface-2: #251E1C;
            --surface-3: #2E2624;
            --grid-line-color: rgba(245, 237, 232, 0.06);
        }
        
        /* ========== åŸºç¡€æ ·å¼ ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans SC', sans-serif;
            background: 
                radial-gradient(ellipse at top left, var(--cream) 0%, transparent 50%),
                radial-gradient(ellipse at bottom right, var(--bg-secondary) 0%, transparent 50%),
                linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            overflow: hidden;
            transition: background 0.5s var(--transition-smooth);
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 15% 25%, rgba(232, 168, 124, 0.04) 0%, transparent 40%),
                radial-gradient(circle at 85% 75%, rgba(138, 154, 142, 0.03) 0%, transparent 40%),
                radial-gradient(circle at 50% 50%, rgba(212, 117, 78, 0.02) 0%, transparent 60%);
            pointer-events: none;
            z-index: 0;
        }
        /* ç»†è…»ç½‘æ ¼çº¹ç†ï¼Œæå‡ç©ºç™½åŒºåŸŸçš„è®¾è®¡æ„Ÿ */
        body::after {
            content: '';
            position: fixed;
            inset: 0;
            pointer-events: none;
            background-image:
                repeating-linear-gradient(0deg, var(--grid-line-color) 0 1px, transparent 1px 24px),
                repeating-linear-gradient(90deg, var(--grid-line-color) 0 1px, transparent 1px 24px);
            z-index: 0;
        }
        
        /* ========== å¸ƒå±€å®¹å™¨ ========== */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            position: relative;
            z-index: 1;
        }
        
        .app-header {
            height: var(--header-height);
            background: var(--bg-card);
            backdrop-filter: blur(12px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            box-shadow: 0 1px 3px var(--shadow-sm);
            z-index: 100;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-terracotta) 0%, var(--primary-sienna) 50%, var(--accent-bronze) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.5px;
        }
        
        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        /* ========== ä¾§è¾¹æ  - éŸ³è‰²é€‰æ‹©å™¨ ========== */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--surface-1);
            backdrop-filter: blur(12px);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 2px 0 12px var(--shadow-sm);
        }
        
        .sidebar-header {
            padding: 1.5rem;
            background: linear-gradient(to bottom, transparent, var(--border-color) 100%);
            background-size: 100% 1px;
            background-position: bottom;
            background-repeat: no-repeat;
        }
        
        .sidebar-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }
        
        .voice-search {
            width: 100%;
            padding: 0.875rem 1.125rem;
            border: 2px solid transparent;
            border-radius: var(--border-radius-sm);
            font-size: 0.9rem;
            background: linear-gradient(to right, rgba(255, 255, 255, 0.5), rgba(255, 244, 230, 0.3));
            color: var(--text-primary);
            transition: all 0.3s var(--transition-smooth);
            box-shadow: inset 0 1px 2px var(--shadow-sm);
        }
        
        .voice-search:focus {
            outline: none;
            border-color: var(--primary-terracotta);
            box-shadow: 0 0 0 4px rgba(212, 117, 78, 0.12), inset 0 1px 2px var(--shadow-sm);
            background: rgba(255, 255, 255, 0.9);
        }

        /* æš—é»‘æ¨¡å¼è¾“å…¥ç±»ä¿®å¤ */
        [data-theme="dark"] .text-input,
        [data-theme="dark"] .form-input,
        [data-theme="dark"] .voice-search {
            background: linear-gradient(to bottom, rgba(245, 237, 232, 0.06), rgba(245, 237, 232, 0.04));
            border-color: rgba(245, 237, 232, 0.14);
            color: var(--text-primary);
            caret-color: var(--accent-amber);
        }
        [data-theme="dark"] .text-input:focus,
        [data-theme="dark"] .form-input:focus,
        [data-theme="dark"] .voice-search:focus {
            background: rgba(245, 237, 232, 0.12);
            border-color: var(--primary-terracotta);
            box-shadow: 0 0 0 4px rgba(212, 117, 78, 0.16), inset 0 1px 2px rgba(0,0,0,0.2);
        }
        [data-theme="dark"] .text-input::placeholder,
        [data-theme="dark"] .form-input::placeholder,
        [data-theme="dark"] .voice-search::placeholder {
            color: rgba(245, 237, 232, 0.6);
        }
        
        .voice-list {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .voice-category {
            margin-bottom: 1.5rem;
        }
        
        .category-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.25rem;
            background: linear-gradient(135deg, var(--primary-terracotta) 0%, var(--primary-sienna) 100%);
            color: var(--cream);
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 0.875rem;
            transition: all 0.3s var(--transition-smooth);
            box-shadow: 0 3px 12px var(--shadow-md);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .category-header:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 24px var(--shadow-lg);
            background: linear-gradient(135deg, var(--primary-sienna) 0%, var(--accent-bronze) 100%);
        }
        
        .category-header:active {
            transform: translateY(0);
        }
        
        .category-content {
            display: none;
            padding-left: 0.5rem;
        }
        
        .category-content.active {
            display: block;
        }

        .voice-item {
            padding: 0.875rem 1.125rem;
            margin: 0.375rem 0;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.3s var(--transition-smooth);
            position: relative;
            background: transparent;
        }
        
        .voice-item:hover {
            background: linear-gradient(to right, rgba(232, 168, 124, 0.15), transparent);
            border-color: rgba(212, 117, 78, 0.25);
            transform: translateX(3px);
        }
        
        .voice-item.selected {
            background: linear-gradient(135deg, rgba(232, 168, 124, 0.2) 0%, rgba(212, 117, 78, 0.1) 100%);
            border-color: var(--primary-terracotta);
            box-shadow: 0 4px 16px var(--shadow-md);
            transform: scale(1.02);
            border-width: 1.5px;
        }
        
        .voice-item-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .voice-icon {
            font-size: 1.1rem;
        }
        
        .voice-item-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 0.5rem;
        }
        .voice-item-meta .meta-left { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        
        .voice-tag {
            font-size: 0.75rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            background: var(--bg-primary);
            color: var(--text-secondary);
        }
        
        .favorite-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .voice-item:hover .favorite-btn,
        .favorite-btn.active {
            opacity: 1;
        }

        .preview-btn {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            background: rgba(0,0,0,0.04);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 6px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s, background 0.2s;
        }
        .voice-item:hover .preview-btn { opacity: 1; }
        .preview-btn:hover { background: rgba(0,0,0,0.06); }

        .preview-inline {
            background: rgba(0,0,0,0.04);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 999px;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            white-space: nowrap;
        }
        .preview-inline:hover { background: rgba(0,0,0,0.06); transform: translateY(-1px); }
        
        /* ========== ä¸­å¤®å·¥ä½œåŒº ========== */
        .workspace {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 2rem;
            overflow-y: auto;
        }
        
        .workspace-card {
            background: var(--surface-1);
            backdrop-filter: blur(12px);
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: 0 2px 20px var(--shadow-sm), 0 0 0 1px var(--border-color);
            margin-bottom: 1.5rem;
            transition: all 0.3s var(--transition-smooth);
        }
        
        .workspace-card:hover {
            box-shadow: 0 6px 36px var(--shadow-md), 0 0 0 1px rgba(212, 117, 78, 0.2);
            transform: translateY(-3px);
        }
        
        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
          margin-bottom: 1rem;
            color: var(--text-primary);
        }
        
        .textarea-container {
            position: relative;
        }
        
        .text-input {
            width: 100%;
            min-height: 200px;
            padding: 1.25rem;
            border: 2px solid transparent;
            border-radius: var(--border-radius-sm);
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0.5), rgba(255, 244, 230, 0.2));
            color: var(--text-primary);
            transition: background-color 0.25s var(--transition-smooth), border-color 0.25s var(--transition-smooth), box-shadow 0.25s var(--transition-smooth);
            box-shadow: inset 0 1px 3px var(--shadow-sm);
        }
        
        .text-input:focus {
            outline: none;
            border-color: var(--primary-terracotta);
            box-shadow: 0 0 0 4px rgba(212, 117, 78, 0.12), inset 0 1px 3px var(--shadow-sm);
            background: rgba(255, 255, 255, 0.95);
        }
        
        .text-meta {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .btn {
            padding: 0.875rem 2rem;
            border: none;
          border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s var(--transition-smooth);
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-terracotta) 0%, var(--primary-sienna) 100%);
            color: var(--cream);
            box-shadow: 0 4px 16px var(--shadow-md);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 28px var(--shadow-lg);
            background: linear-gradient(135deg, var(--primary-sienna) 0%, var(--accent-bronze) 100%);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1.5px solid var(--border-color);
            backdrop-filter: blur(8px);
        }
        
        .btn-secondary:hover {
            background: linear-gradient(135deg, rgba(232, 168, 124, 0.12), rgba(212, 117, 78, 0.08));
            border-color: var(--primary-terracotta);
            color: var(--primary-sienna);
        }
        
        /* ========== å³ä¾§å†å²é¢æ¿ ========== */
        .history-panel {
            width: var(--history-width);
            background: var(--surface-1);
            backdrop-filter: blur(12px);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: transform 0.3s var(--transition-smooth);
            box-shadow: -2px 0 12px var(--shadow-sm);
        }
        
        .history-panel.collapsed {
            transform: translateX(100%);
        }
        
        .panel-header {
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to bottom, transparent, var(--border-color) 100%);
            background-size: 100% 1px;
            background-position: bottom;
            background-repeat: no-repeat;
        }
        
        .panel-title {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .chip-btn {
            border: 1px solid var(--border-color);
            background: var(--surface-1);
            color: var(--text-primary);
            border-radius: 999px;
            padding: 0.35rem 0.65rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: auto;
            margin-right: 0.5rem;
        }
        .chip-btn:hover { transform: translateY(-1px); }
        .chip-btn.active { border-color: var(--primary-terracotta); color: var(--primary-sienna); }
        
        .panel-tabs {
            display: flex;
            padding: 0 1rem;
            background: linear-gradient(to bottom, transparent, var(--border-color) 100%);
            background-size: 100% 1px;
            background-position: bottom;
            background-repeat: no-repeat;
        }
        
        .tab {
            flex: 1;
            padding: 1rem;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.3s var(--transition-smooth);
        }
        
        .tab.active {
            color: var(--primary-terracotta);
            border-bottom-color: var(--primary-terracotta);
            font-weight: 600;
        }
        
        .tab:hover:not(.active) {
            color: var(--primary-sienna);
        }
        
        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .history-item, .favorite-item {
            padding: 1rem;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.5), rgba(255, 244, 230, 0.3));
            border-radius: var(--border-radius-sm);
            margin-bottom: 0.75rem;
            border: 1px solid transparent;
            transition: all 0.3s var(--transition-smooth);
            backdrop-filter: blur(8px);
        }
        
        .history-item:hover, .favorite-item:hover {
            border-color: rgba(212, 117, 78, 0.3);
            box-shadow: 0 6px 20px var(--shadow-md);
            transform: translateY(-2px);
        }
        
        .item-text {
            font-size: 0.9rem;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .item-meta {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }
        
        .item-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-small {
            padding: 0.4rem 0.8rem;
            font-size: 0.75rem;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            background: var(--bg-card);
            color: var(--text-primary);
            transition: all 0.3s;
        }
        
        .btn-small:hover {
            background: linear-gradient(135deg, var(--primary-terracotta), var(--primary-sienna));
            color: var(--cream);
            transform: translateY(-1px);
        }
        
        /* ========== éŸ³é¢‘æ’­æ”¾å™¨ ========== */
        .audio-player {
            height: var(--player-height);
            background: linear-gradient(135deg, rgba(45, 36, 36, 0.98) 0%, rgba(61, 52, 52, 0.98) 100%);
            backdrop-filter: blur(20px);
            padding: 1rem 1.25rem;
            display: none;
            flex-direction: column;
            gap: 0.75rem;
            box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.3);
            border-top: 1px solid rgba(212, 117, 78, 0.2);
            border-radius: 12px;
            position: static; /* ä¸å†è¦†ç›–é¡µé¢åº•éƒ¨å†…å®¹ */
            margin: 12px 12px 0 12px;
        }
        
        .audio-player.active {
            display: flex;
        }
        
        .waveform-wrapper {
            position: relative;
            width: 100%;
            height: 48px;
        }
        
        .player-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
            width: 100%;
        }
        
        .play-btn {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-terracotta) 0%, var(--primary-sienna) 100%);
            border: none;
            color: var(--cream);
            font-size: 1.3rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.25s var(--transition-smooth);
            box-shadow: 0 2px 12px rgba(212, 117, 78, 0.35);
            flex-shrink: 0;
        }
        
        .play-btn:hover {
            transform: scale(1.08);
            box-shadow: 0 4px 20px rgba(212, 117, 78, 0.45);
        }
        
        .play-btn:active {
            transform: scale(1.0);
        }
        
        .time-label {
            color: rgba(255, 255, 255, 0.85);
            font-size: 0.8rem;
            font-weight: 500;
            min-width: 42px;
            text-align: center;
            flex-shrink: 0;
        }
        
        .progress-container {
            flex: 1;
            display: flex;
            align-items: center;
        }
        
        .progress-bar {
            height: 5px;
            width: 100%;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 3px;
            cursor: pointer;
            position: relative;
            transition: height 0.2s;
        }
        
        .progress-bar:hover {
            height: 6px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-terracotta) 0%, var(--accent-amber) 100%);
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s linear;
            box-shadow: 0 0 10px rgba(212, 117, 78, 0.6);
            position: relative;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            right: -1px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background: var(--cream);
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .progress-bar:hover .progress-fill::after {
            opacity: 1;
        }
        
        .wave-tooltip {
            position: absolute;
            top: -32px;
            left: 0;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.75);
            color: #fff;
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 6px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s ease;
            white-space: nowrap;
        }
        
        .player-extra {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-shrink: 0;
        }
        
        .icon-control {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .icon-control:hover {
            background: rgba(255, 255, 255, 0.18);
            transform: scale(1.05);
        }
        
        .slider {
            width: 70px;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255, 255, 255, 0.18);
            border-radius: 2px;
            outline: none;
            cursor: pointer;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--cream);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s;
        }
        
        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }
        
        .speed-select {
            background: rgba(255, 255, 255, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.3rem 0.5rem;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            outline: none;
        }
        
        .speed-select:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* ========== å›¾æ ‡æŒ‰é’® ========== */
        .icon-btn {
            width: 42px;
            height: 42px;
            border-radius: 11px;
            border: 1px solid transparent;
            background: rgba(212, 117, 78, 0.1);
            color: var(--text-primary);
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s var(--transition-smooth);
            backdrop-filter: blur(4px);
        }
        
        .icon-btn:hover {
            background: linear-gradient(135deg, var(--primary-terracotta) 0%, var(--primary-sienna) 100%);
            color: var(--cream);
            border-color: transparent;
            transform: scale(1.08);
            box-shadow: 0 6px 20px var(--shadow-md);
        }
        
        .icon-btn:active {
            transform: scale(0.96);
        }
        
        .icon-btn.active {
            background: linear-gradient(135deg, var(--primary-terracotta) 0%, var(--primary-sienna) 100%);
            color: var(--cream);
            border-color: transparent;
        }
        
        /* ========== Toast é€šçŸ¥ ========== */
        .toast-container {
            position: fixed;
            top: calc(var(--header-height) + 0.5rem);
            right: 1rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .toast {
            background: var(--surface-1);
            backdrop-filter: blur(12px);
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius-sm);
            box-shadow: 0 8px 32px var(--shadow-lg);
            border-left: 4px solid var(--primary-terracotta);
            animation: slideIn 0.3s var(--transition-smooth);
            min-width: 320px;
            border: 1px solid var(--border-color);
            border-left-width: 4px;
        }

        .toast .close {
            margin-left: 0.75rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1rem;
        }
        
        .toast.success {
            border-left-color: var(--sage-green);
        }
        
        .toast.error {
            border-left-color: #D64545;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* ========== Modal ========== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1600;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: var(--surface-1);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius);
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px var(--shadow-lg), 0 0 0 1px var(--border-color);
        }
        
        .modal-header {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-right: 0.5rem;
        }
        
        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: rgba(212, 117, 78, 0.1);
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s var(--transition-smooth);
            line-height: 1;
        }
        
        .modal-close:hover {
            background: var(--primary-terracotta);
            color: var(--cream);
            transform: scale(1.1) rotate(90deg);
        }
        
        [data-theme="dark"] .modal-close {
            background: rgba(245, 237, 232, 0.15);
            color: var(--text-primary);
        }
        
        [data-theme="dark"] .modal-close:hover {
            background: var(--primary-terracotta);
            color: var(--cream);
        }
        
        .modal-body {
            margin-bottom: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .form-input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid transparent;
            border-radius: var(--border-radius-sm);
            font-size: 1rem;
            background: linear-gradient(to right, rgba(255, 255, 255, 0.5), rgba(255, 244, 230, 0.3));
            color: var(--text-primary);
            transition: all 0.3s var(--transition-smooth);
            box-shadow: inset 0 1px 2px var(--shadow-sm);
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-terracotta);
            box-shadow: 0 0 0 4px rgba(212, 117, 78, 0.12), inset 0 1px 2px var(--shadow-sm);
            background: rgba(255, 255, 255, 0.95);
        }
        
        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }
        
        /* ========== åŠ è½½åŠ¨ç”» ========== */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ========== æ³¢å½¢å¯è§†åŒ– ========== */
        .waveform-canvas {
            width: 100%;
            height: 100%;
            cursor: pointer;
            border-radius: 6px;
            transition: opacity 0.2s;
        }
        
        .waveform-canvas:hover {
            opacity: 0.9;
        }
        
        /* ========== å“åº”å¼è®¾è®¡ ========== */
        @media (max-width: 1024px) {
            .sidebar {
                position: absolute;
                left: 0;
                top: var(--header-height);
                height: calc(100vh - var(--header-height));
                z-index: 50;
                transform: translateX(-100%);
                transition: transform 0.3s var(--transition-smooth);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .history-panel {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .app-header {
                padding: 0 1rem;
            }
            
            .workspace {
                padding: 1rem;
            }
            
            .audio-player {
                padding: 0.75rem 1rem;
                height: 70px;
            }
            
            .waveform-wrapper {
                height: 24px;
            }
            
            .player-controls {
                gap: 0.5rem;
            }
            
            .play-btn {
                width: 36px;
                height: 36px;
                font-size: 1.1rem;
            }
            
            .time-label {
                font-size: 0.7rem;
                min-width: 36px;
            }
            
            .slider {
                width: 50px;
            }
            
            .speed-select {
                font-size: 0.7rem;
                padding: 0.2rem 0.4rem;
            }
        }
        
        /* ========== æ»šåŠ¨æ¡æ ·å¼ ========== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary-orange);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-gold);
        }
        
        /* ========== éšè—ç±» ========== */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <header class="app-header">
            <div class="logo">ğŸ™ï¸ Gemini TTS Pro</div>
            <div class="header-actions">
                <button class="icon-btn" id="toggleSidebar" title="éŸ³è‰²é€‰æ‹©å™¨">â˜°</button>
                <button class="icon-btn" id="historyToggleGlobal" title="æ‰“å¼€å†å²è®°å½•">ğŸ—‚</button>
                <button class="icon-btn" id="themeToggle" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ“</button>
                <button class="icon-btn" id="settingsBtn" title="è®¾ç½®">âš™ï¸</button>
                <button class="icon-btn" id="helpBtn" title="å¿«æ·é”®å¸®åŠ©">â“</button>
            </div>
        </header>
        
        <!-- ä¸»å†…å®¹åŒº -->
        <main class="main-content">
            <!-- å·¦ä¾§éŸ³è‰²é€‰æ‹©å™¨ -->
            <aside class="sidebar">
                <div class="sidebar-header">
                    <h2 class="sidebar-title">éŸ³è‰²é€‰æ‹©</h2>
                    <input type="text" class="voice-search" id="voiceSearch" placeholder="æœç´¢éŸ³è‰²...">
                </div>
                <div class="voice-list" id="voiceList">
                    <!-- éŸ³è‰²åˆ—è¡¨å°†é€šè¿‡ JS åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </aside>
            
            <!-- ä¸­å¤®å·¥ä½œåŒº -->
            <section class="workspace">
                <div class="workspace-card">
                    <h2 class="card-title">æ–‡æœ¬è¾“å…¥</h2>
                    <div class="textarea-container">
                        <textarea 
                            class="text-input" 
                            id="textInput" 
                            placeholder="åœ¨æ­¤è¾“å…¥è¦è½¬æ¢çš„æ–‡æœ¬...&#10;&#10;ğŸ’¡ æç¤ºï¼šå¯ä½¿ç”¨æ§åˆ¶è¯­å¥ï¼Œå¦‚ï¼š&#10;Say slowly and dramatically: è¿™æ˜¯ä¸€ä¸ªæˆå‰§æ€§çš„å¥å­ã€‚&#10;Say excitedly: å¤ªæ£’äº†ï¼"
                        ></textarea>
                        <div class="text-meta">
                            <span id="charCount">0 å­—ç¬¦</span>
                            <span id="estimatedTime"></span>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-primary" id="generateBtn">
                            <span id="generateBtnText">ç”Ÿæˆè¯­éŸ³</span>
                        </button>
                        <button class="btn btn-secondary" id="batchBtn">æ‰¹é‡ç”Ÿæˆ</button>
                        <button class="btn btn-secondary" id="saveToFavorites">ä¿å­˜åˆ°æ”¶è—</button>
                    </div>
                </div>
                
                <div class="workspace-card">
                    <h2 class="card-title">ğŸ’¡ ä½¿ç”¨æŠ€å·§</h2>
                    <ul style="list-style-position: inside; color: var(--text-secondary); line-height: 1.8;">
                        <li><strong>é€Ÿåº¦ï¼š</strong>ä½¿ç”¨ "Say quickly:" æˆ– "Say slowly:" æ§åˆ¶è¯­é€Ÿ</li>
                    <li><strong>è¯­æ°”ï¼š</strong>å¦‚ "Say cheerfully:", "Say in a whisper:", "Say dramatically:"</li>
                    <li><strong>æƒ…æ„Ÿï¼š</strong>å¦‚ "Say excitedly:", "Say calmly:", "Say mysteriously:"</li>
                        <li><strong>å¿«æ·é”®ï¼š</strong>Ctrl/Cmd + Enter ç”Ÿæˆï¼ŒSpace æ’­æ”¾/æš‚åœ</li>
                </ul>
            </div>
            </section>
            
            <!-- å³ä¾§å†å²é¢æ¿ -->
            <aside class="history-panel" id="historyPanel">
                <div class="panel-header">
                    <h2 class="panel-title">å†å²ä¸æ”¶è—</h2>
                    <button class="chip-btn" id="toggleDeletedBtn" title="æ˜¾ç¤º/éšè—å·²åˆ é™¤">ğŸ—‘ æ˜¾ç¤ºå·²åˆ é™¤</button>
                    <button class="icon-btn" id="toggleHistory" title="æ”¶èµ·">âœ•</button>
            </div>
                <div class="panel-tabs">
                    <button class="tab active" data-tab="history">å†å²</button>
                    <button class="tab" data-tab="favorites">æ”¶è—</button>
        </div>
                <div class="panel-content" id="historyContent">
                    <!-- å†å²è®°å½•å°†é€šè¿‡ JS åŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div class="panel-content hidden" id="favoritesContent">
                    <!-- æ”¶è—è®°å½•å°†é€šè¿‡ JS åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </aside>
        </main>
        
        <!-- éŸ³é¢‘æ’­æ”¾å™¨ -->
        <div class="audio-player" id="audioPlayer">
            <div class="player-controls">
                <button class="play-btn" id="playBtn">â–¶</button>
                <div class="time-label" id="currentTime">0:00</div>
                <div class="progress-container">
                    <div class="waveform-wrapper">
                        <canvas class="waveform-canvas" id="waveformCanvas"></canvas>
                        <div class="wave-tooltip" id="waveTooltip"></div>
            </div>
                </div>
                <div class="time-label" id="totalTime">0:00</div>
                <div class="player-extra">
                    <button class="icon-control" id="volumeBtn" title="éŸ³é‡">ğŸ”Š</button>
                    <input type="range" class="slider" id="volumeSlider" min="0" max="100" value="100">
                    <button class="icon-control" id="speedBtn" title="é€Ÿåº¦">âš¡</button>
                    <select id="speedSelect" class="speed-select">
                        <option value="0.5">0.5x</option>
                        <option value="0.75">0.75x</option>
                        <option value="1" selected>1.0x</option>
                        <option value="1.25">1.25x</option>
                        <option value="1.5">1.5x</option>
                        <option value="2">2.0x</option>
                    </select>
                    <button class="icon-control" id="downloadBtn" title="ä¸‹è½½">ğŸ’¾</button>
                </div>
            </div>
            <audio id="audioElement" style="display: none;"></audio>
        </div>

    <!-- Toast å®¹å™¨ -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- è®¾ç½® Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <span>è®¾ç½®</span>
                <button class="modal-close" onclick="document.getElementById('settingsModal').classList.remove('active')">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">API åŸºç¡€åœ°å€</label>
                    <input type="text" class="form-input" id="apiBaseUrl" value="https://generativelanguage.googleapis.com/v1beta">
                </div>
                <div class="form-group">
                    <label class="form-label">API å¯†é’¥</label>
                    <input type="password" class="form-input" id="apiKey" placeholder="è¾“å…¥æ‚¨çš„ Gemini API Key">
                </div>
                <div class="form-group">
                    <label class="form-label">æ¨¡å‹é€‰æ‹©</label>
                    <select class="form-input" id="modelSelect">
                        <option value="gemini-2.5-flash-preview-tts">Gemini 2.5 Flash TTS (å¿«é€Ÿ)</option>
                        <option value="gemini-2.5-pro-preview-tts">Gemini 2.5 Pro TTS (é«˜è´¨é‡)</option>
                    </select>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancelSettings">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="saveSettings">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- æ”¶è—ä¿å­˜ Modal -->
    <div class="modal-overlay" id="saveFavoriteModal">
        <div class="modal">
            <div class="modal-header">
                <span>ä¿å­˜åˆ°æ”¶è—</span>
                <button class="modal-close" onclick="document.getElementById('saveFavoriteModal').classList.remove('active')">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">æ”¶è—åç§°</label>
                    <input type="text" class="form-input" id="favoriteName" placeholder="ä¸ºè¿™ä¸ªé…ç½®å‘½å...">
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancelFavorite">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="confirmFavorite">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- å¸®åŠ© Modal -->
    <div class="modal-overlay" id="helpModal">
        <div class="modal">
            <div class="modal-header">
                <span>âŒ¨ï¸ å¿«æ·é”®</span>
                <button class="modal-close" onclick="document.getElementById('helpModal').classList.remove('active')">âœ•</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; gap: 1rem;">
                    <div><strong>Ctrl/Cmd + Enter</strong> - ç”Ÿæˆè¯­éŸ³</div>
                    <div><strong>Space</strong> - æ’­æ”¾/æš‚åœ</div>
                    <div><strong>Ctrl/Cmd + S</strong> - ä¿å­˜åˆ°æ”¶è—</div>
                    <div><strong>Ctrl/Cmd + K</strong> - æœç´¢éŸ³è‰²</div>
                    <div><strong>Esc</strong> - å…³é—­å¼¹çª—</div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" id="closeHelp">çŸ¥é“äº†</button>
            </div>
        </div>
    </div>

    <script>
        // ========== éŸ³è‰²æ•°æ®åº“ ==========
        const VOICE_DATABASE = {
            female: [
                { name: 'Leda', trait: 'Youthful', age: '20-30å²', desc: 'æ´»æ³¼å°‘å¥³éŸ³' },
                { name: 'Aoede', trait: 'Breezy', age: '20-30å²', desc: 'è½»å¿«å¥³å£°' },
                { name: 'Despina', trait: 'Smooth', age: '20-30å²', desc: 'æ¸©æŸ”å¥³å£°' },
                { name: 'Kore', trait: 'Firm', age: '30-45å²', desc: 'åšå®šå¥³å£°' },
                { name: 'Callirrhoe', trait: 'Easy-going', age: '30-45å²', desc: 'éšå’Œå¥³å£°' },
                { name: 'Autonoe', trait: 'Bright', age: '30-45å²', desc: 'æ˜äº®å¥³å£°' },
                { name: 'Erinome', trait: 'Clear', age: '30-45å²', desc: 'æ¸…æ™°å¥³å£°' },
                { name: 'Vindemiatrix', trait: 'Gentle', age: '30-45å²', desc: 'æ¸©æŸ”æˆç†Ÿå¥³å£°' },
                { name: 'Pulcherrima', trait: 'Forward', age: '35-50å²', desc: 'è‡ªä¿¡å¥³å£°' },
                { name: 'Laomedeia', trait: 'Upbeat', age: '35-50å²', desc: 'ç§¯æå¥³å£°' }
            ],
            male: [
                { name: 'Puck', trait: 'Upbeat', age: '20-30å²', desc: 'æ´»åŠ›ç”·å£°' },
                { name: 'Fenrir', trait: 'Excitable', age: '20-30å²', desc: 'æ¿€æƒ…ç”·å£°' },
                { name: 'Zephyr', trait: 'Bright', age: '20-30å²', desc: 'æ˜äº®ç”·å£°' },
                { name: 'Charon', trait: 'Informative', age: '30-45å²', desc: 'çŸ¥è¯†å‹ç”·å£°' },
                { name: 'Orus', trait: 'Firm', age: '30-45å²', desc: 'åšå®šç”·å£°' },
                { name: 'Enceladus', trait: 'Breathy', age: '30-45å²', desc: 'ç£æ€§ç”·å£°' },
                { name: 'Iapetus', trait: 'Clear', age: '30-45å²', desc: 'æ¸…æ™°ç”·å£°' },
                { name: 'Umbriel', trait: 'Easy-going', age: '30-45å²', desc: 'éšå’Œç”·å£°' },
                { name: 'Rasalgethi', trait: 'Informative', age: '40-60å²', desc: 'æ’­éŸ³å‘˜ç”·å£°' },
                { name: 'Alnilam', trait: 'Firm', age: '40-60å²', desc: 'å¨ä¸¥ç”·å£°' },
                { name: 'Gacrux', trait: 'Mature', age: '40-60å²', desc: 'æˆç†Ÿç”·å£°' },
                { name: 'Algenib', trait: 'Gravelly', age: '40-60å²', desc: 'æ²™å“‘ç”·å£°' }
            ],
            neutral: [
                { name: 'Algieba', trait: 'Smooth', age: 'é€šç”¨', desc: 'æŸ”å’Œä¸­æ€§éŸ³' },
                { name: 'Achernar', trait: 'Soft', age: 'é€šç”¨', desc: 'æ¸©æŸ”ä¸­æ€§éŸ³' },
                { name: 'Schedar', trait: 'Even', age: 'é€šç”¨', desc: 'å¹³ç¨³ä¸­æ€§éŸ³' },
                { name: 'Achird', trait: 'Friendly', age: 'é€šç”¨', desc: 'å‹å¥½ä¸­æ€§éŸ³' },
                { name: 'Zubenelgenubi', trait: 'Casual', age: 'é€šç”¨', desc: 'ä¼‘é—²ä¸­æ€§éŸ³' },
                { name: 'Sadachbia', trait: 'Lively', age: 'é€šç”¨', desc: 'æ´»æ³¼ä¸­æ€§éŸ³' },
                { name: 'Sadaltager', trait: 'Knowledgeable', age: 'é€šç”¨', desc: 'çŸ¥è¯†å‹ä¸­æ€§éŸ³' },
                { name: 'Sulafat', trait: 'Warm', age: 'é€šç”¨', desc: 'æ¸©æš–ä¸­æ€§éŸ³' }
            ]
        };
        
        // ========== çŠ¶æ€ç®¡ç† ==========
        const state = {
            selectedVoice: 'Puck',
            theme: localStorage.getItem('theme') || 'light',
            apiKey: localStorage.getItem('apiKey') || '',
            apiBaseUrl: localStorage.getItem('apiBaseUrl') || 'https://generativelanguage.googleapis.com/v1beta',
            model: localStorage.getItem('model') || 'gemini-2.5-flash-preview-tts',
            currentAudio: null,
            isPlaying: false,
            history: JSON.parse(localStorage.getItem('history') || '[]'),
            favorites: JSON.parse(localStorage.getItem('favorites') || '[]'),
            deletedHistory: JSON.parse(localStorage.getItem('deletedHistory') || '[]'),
            showDeleted: (localStorage.getItem('showDeleted') || 'false') === 'true'
        };

        // æ’¤é”€åˆ é™¤æ‰€éœ€
        let lastDeletedHistoryItem = null;
        
        // è¯•å¬éŸ³è‰²æ‰€éœ€
        let previewAudioUrl = null;
        let previewAudioEl = null;
        
        // ========== éŸ³é¢‘å¯è§†åŒ–å…¨å±€ ==========
        let audioCtx = null;
        let analyser = null;
        let sourceNode = null;
        let dataArray = null;
        let rafId = null;
        let isScrubbing = false;
        let wasPlayingBeforeScrub = false;

        // ========== åˆå§‹åŒ– ==========
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            initVoiceList();
            initEventListeners();
            initKeyboardShortcuts();
            loadSettings();
            renderHistory();
            renderFavorites();
            
            // é¦–æ¬¡è®¿é—®æç¤º
            if (!localStorage.getItem('visited')) {
                setTimeout(() => showToast('ğŸ‘‹ æ¬¢è¿ä½¿ç”¨ï¼æŒ‰ Ctrl+Enter å¿«é€Ÿç”Ÿæˆï¼Œç‚¹å‡» â“ æŸ¥çœ‹æ›´å¤šå¿«æ·é”®', 'success'), 500);
                localStorage.setItem('visited', 'true');
            }
            updateDeletedToggleBtn();
            // æ¢å¤å†å²é¢æ¿æŠ˜å çŠ¶æ€
            const savedCollapsed = (localStorage.getItem('historyPanelCollapsed') || 'false') === 'true';
            setHistoryCollapsed(savedCollapsed);
            if (state.showDeleted) renderDeleted();
            updateHistoryToggleBtnVisual();
        });
        
        // ========== ä¸»é¢˜åˆ‡æ¢ ==========
        function initTheme() {
            document.documentElement.setAttribute('data-theme', state.theme);
        }
        
        function toggleTheme() {
            state.theme = state.theme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', state.theme);
            localStorage.setItem('theme', state.theme);
            showToast(`å·²åˆ‡æ¢åˆ°${state.theme === 'light' ? 'æµ…è‰²' : 'æ·±è‰²'}æ¨¡å¼`, 'success');
        }
        
        // ========== éŸ³è‰²åˆ—è¡¨åˆå§‹åŒ– ==========
        function initVoiceList() {
            const voiceList = document.getElementById('voiceList');
            const categories = {
                female: { title: 'å¥³æ€§éŸ³è‰²', icon: 'ğŸ‘©â€ğŸ¤' },
                male: { title: 'ç”·æ€§éŸ³è‰²', icon: 'ğŸ‘¨â€ğŸ¤' },
                neutral: { title: 'ä¸­æ€§éŸ³è‰²', icon: 'ğŸ§‘â€ğŸ¤' }
            };
            
            Object.entries(categories).forEach(([key, {title, icon}]) => {
                const category = document.createElement('div');
                category.className = 'voice-category';
                category.innerHTML = `
                    <div class="category-header" data-category="${key}">
                        <span>${icon} ${title}</span>
                        <span>â–¼</span>
                    </div>
                    <div class="category-content active">
                        ${VOICE_DATABASE[key].map(voice => `
                            <div class="voice-item ${voice.name === state.selectedVoice ? 'selected' : ''}" data-voice="${voice.name}">
                                <div class="voice-item-name">
                                    <span class="voice-icon">${icon}</span>
                                    <span>${getVoiceEmoji(voice.trait)} ${voice.name}</span>
                                </div>
                                <div class="voice-item-meta">
                                    <div class="meta-left">
                                        <span class="voice-tag">${voice.age}</span>
                                        <span class="voice-tag">${voice.trait}</span>
                                        <span class="voice-tag">${voice.desc}</span>
                                    </div>
                                    <button class="preview-inline" data-voice="${voice.name}">ğŸ”Š è¯•å¬</button>
                                </div>
                                <button class="favorite-btn ${isFavoriteVoice(voice.name) ? 'active' : ''}" data-voice="${voice.name}">
                                    ${isFavoriteVoice(voice.name) ? 'â˜…' : 'â˜†'}
                                </button>
                            </div>
                        `).join('')}
                    </div>
                `;
                voiceList.appendChild(category);
            });
            
            // åˆ†ç±»æŠ˜å åŠŸèƒ½
            document.querySelectorAll('.category-header').forEach(header => {
                header.addEventListener('click', () => {
                    const content = header.nextElementSibling;
                    content.classList.toggle('active');
                });
            });
            
            // éŸ³è‰²é€‰æ‹©
            document.querySelectorAll('.voice-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('favorite-btn')) {
                        selectVoice(item.dataset.voice);
                    }
                });
            });
            
            // æ”¶è—éŸ³è‰²
            document.querySelectorAll('.favorite-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleFavoriteVoice(btn.dataset.voice);
                });
            });

            // è¯•å¬éŸ³è‰²ï¼ˆå†…è”æŒ‰é’®ï¼‰
            document.querySelectorAll('.preview-inline').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    previewVoice(btn.dataset.voice);
                });
            });
        }
        
        function selectVoice(voiceName) {
            document.querySelectorAll('.voice-item').forEach(item => {
                item.classList.remove('selected');
            });
            document.querySelector(`[data-voice="${voiceName}"]`).classList.add('selected');
            state.selectedVoice = voiceName;
            showToast(`å·²é€‰æ‹©éŸ³è‰²ï¼š${voiceName}`, 'success');
        }

        function getVoiceEmoji(trait) {
            const map = {
                'Bright': 'âœ¨',
                'Upbeat': 'ğŸµ',
                'Informative': 'ğŸ§ ',
                'Firm': 'ğŸ§±',
                'Excitable': 'ğŸ”¥',
                'Youthful': 'ğŸ£',
                'Breezy': 'ğŸŒ¬ï¸',
                'Easy-going': 'ğŸ˜Œ',
                'Breathy': 'ğŸ˜®\u200dğŸ’¨',
                'Clear': 'ğŸ”Š',
                'Smooth': 'ğŸ·',
                'Gravelly': 'ğŸª¨',
                'Mature': 'ğŸ©',
                'Soft': 'â˜ï¸',
                'Even': 'ğŸ“',
                'Friendly': 'ğŸ¤—',
                'Casual': 'ğŸ§¢',
                'Gentle': 'ğŸƒ',
                'Lively': 'âš¡',
                'Knowledgeable': 'ğŸ“š',
                'Warm': 'ğŸ”†'
            };
            return map[trait] || 'ğŸ™ï¸';
        }
        
        function isFavoriteVoice(voiceName) {
            return state.favorites.some(fav => fav.voice === voiceName);
        }
        
        function toggleFavoriteVoice(voiceName) {
            const btn = document.querySelector(`.favorite-btn[data-voice="${voiceName}"]`);
            const isFav = btn.classList.contains('active');
            
            if (isFav) {
                btn.classList.remove('active');
                btn.textContent = 'â˜†';
            } else {
                btn.classList.add('active');
                btn.textContent = 'â˜…';
            }
        }
        
        // ========== æœç´¢åŠŸèƒ½ ==========
        document.getElementById('voiceSearch').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            document.querySelectorAll('.voice-item').forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(query) ? 'block' : 'none';
            });
        });
        
        // ========== äº‹ä»¶ç›‘å¬ ==========
        function initEventListeners() {
            // ä¸»é¢˜åˆ‡æ¢
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            
            // ä¾§è¾¹æ åˆ‡æ¢
            document.getElementById('toggleSidebar').addEventListener('click', () => {
                document.querySelector('.sidebar').classList.toggle('active');
            });
            
            // å†å²é¢æ¿åˆ‡æ¢ï¼ˆé¢æ¿å†…å…³é—­æŒ‰é’® -> æŠ˜å ï¼‰
            document.getElementById('toggleHistory').addEventListener('click', () => {
                setHistoryCollapsed(true);
            });

            // é¡¶éƒ¨å†å²æŒ‰é’®ï¼ˆæ˜¾ç¤º/éšè—ï¼‰
            document.getElementById('historyToggleGlobal').addEventListener('click', () => {
                const panel = document.getElementById('historyPanel');
                const next = panel.classList.contains('collapsed') ? false : true;
                setHistoryCollapsed(next);
            });
            
            // æ˜¾ç¤º/éšè—å·²åˆ é™¤
            document.getElementById('toggleDeletedBtn').addEventListener('click', () => {
                state.showDeleted = !state.showDeleted;
                localStorage.setItem('showDeleted', state.showDeleted);
                updateDeletedToggleBtn();
                const activeTab = document.querySelector('.tab.active')?.dataset.tab;
                if (activeTab === 'history') {
                    if (state.showDeleted) renderDeleted(); else renderHistory();
                }
            });
            
            // ç”Ÿæˆè¯­éŸ³
            document.getElementById('generateBtn').addEventListener('click', generateSpeech);
            
            // æ‰¹é‡ç”Ÿæˆ
            document.getElementById('batchBtn').addEventListener('click', batchGenerate);
            
            // ä¿å­˜åˆ°æ”¶è—
            document.getElementById('saveToFavorites').addEventListener('click', openSaveFavoriteModal);
            
            // è®¾ç½®
            document.getElementById('settingsBtn').addEventListener('click', () => {
                document.getElementById('settingsModal').classList.add('active');
            });
            
            document.getElementById('cancelSettings').addEventListener('click', () => {
                document.getElementById('settingsModal').classList.remove('active');
            });
            
            document.getElementById('saveSettings').addEventListener('click', saveSettings);
            
            // å¸®åŠ©
            document.getElementById('helpBtn').addEventListener('click', () => {
                document.getElementById('helpModal').classList.add('active');
            });
            
            document.getElementById('closeHelp').addEventListener('click', () => {
                document.getElementById('helpModal').classList.remove('active');
            });
            
            // Tab åˆ‡æ¢
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    const tabName = tab.dataset.tab;
                    document.getElementById('historyContent').classList.toggle('hidden', tabName !== 'history');
                    document.getElementById('favoritesContent').classList.toggle('hidden', tabName !== 'favorites');
                });
            });
            
            // æ’­æ”¾æ§åˆ¶
            const playBtn = document.getElementById('playBtn');
            const audioElement = document.getElementById('audioElement');
            
            playBtn.addEventListener('click', togglePlay);
            
            audioElement.addEventListener('timeupdate', updateProgress);
            audioElement.addEventListener('ended', () => {
                state.isPlaying = false;
                playBtn.textContent = 'â–¶';
            });
            audioElement.addEventListener('play', () => { startWaveformDraw(); });
            audioElement.addEventListener('pause', () => { stopWaveformDraw(); });
            
            // è¿›åº¦æ¡å·²ç§»é™¤ï¼Œä½¿ç”¨æ³¢å½¢è¿›è¡Œå¯»å€
            
            // æ³¢å½¢äº¤äº’ï¼šç‚¹å‡»/æ‹–æ‹½å¯»å€ + tooltip
            const waveformCanvas = document.getElementById('waveformCanvas');
            const waveTooltip = document.getElementById('waveTooltip');
            const getTimeFromX = (x) => {
                const rect = waveformCanvas.getBoundingClientRect();
                const ratio = Math.min(Math.max((x - rect.left) / rect.width, 0), 1);
                return ratio * (audioElement.duration || 0);
            };
            const setTooltip = (x) => {
                const t = getTimeFromX(x);
                const rect = waveformCanvas.getBoundingClientRect();
                waveTooltip.style.left = `${x - rect.left}px`;
                waveTooltip.textContent = formatTime(t);
            };
            waveformCanvas.addEventListener('mouseenter', () => {
                waveTooltip.style.opacity = '1';
            });
            waveformCanvas.addEventListener('mouseleave', () => {
                waveTooltip.style.opacity = '0';
                if (isScrubbing) {
                    isScrubbing = false;
                    if (wasPlayingBeforeScrub) audioElement.play();
                }
            });
            waveformCanvas.addEventListener('mousemove', (e) => {
                setTooltip(e.clientX);
                if (isScrubbing) {
                    audioElement.currentTime = getTimeFromX(e.clientX);
                }
            });
            const startScrub = (clientX) => {
                wasPlayingBeforeScrub = !audioElement.paused;
                if (wasPlayingBeforeScrub) audioElement.pause();
                isScrubbing = true;
                audioElement.currentTime = getTimeFromX(clientX);
            };
            waveformCanvas.addEventListener('mousedown', (e) => startScrub(e.clientX));
            window.addEventListener('mouseup', () => {
                if (isScrubbing) {
                    isScrubbing = false;
                    if (wasPlayingBeforeScrub) audioElement.play();
                }
            });
            // è§¦æ§
            waveformCanvas.addEventListener('touchstart', (e) => {
                const touch = e.touches[0];
                startScrub(touch.clientX);
            }, { passive: true });
            waveformCanvas.addEventListener('touchmove', (e) => {
                const touch = e.touches[0];
                setTooltip(touch.clientX);
                if (isScrubbing) audioElement.currentTime = getTimeFromX(touch.clientX);
            }, { passive: true });
            window.addEventListener('touchend', () => {
                if (isScrubbing) {
                    isScrubbing = false;
                    if (wasPlayingBeforeScrub) audioElement.play();
                }
            });
            
            // éŸ³é‡æ§åˆ¶
            document.getElementById('volumeSlider').addEventListener('input', (e) => {
                audioElement.volume = e.target.value / 100;
            });
            
            // é€Ÿåº¦æ§åˆ¶
            document.getElementById('speedSelect').addEventListener('change', (e) => {
                audioElement.playbackRate = parseFloat(e.target.value);
            });
            
            // ä¸‹è½½
            document.getElementById('downloadBtn').addEventListener('click', downloadAudio);
            
            // å­—ç¬¦è®¡æ•°
            document.getElementById('textInput').addEventListener('input', updateCharCount);
            
            // Modal å…³é—­
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        overlay.classList.remove('active');
                    }
                });
            });
            
            // æ”¶è— Modal
            document.getElementById('cancelFavorite').addEventListener('click', () => {
                document.getElementById('saveFavoriteModal').classList.remove('active');
            });
            
            document.getElementById('confirmFavorite').addEventListener('click', saveFavorite);
        }

        function setHistoryCollapsed(collapsed) {
            const panel = document.getElementById('historyPanel');
            panel.classList.toggle('collapsed', collapsed);
            localStorage.setItem('historyPanelCollapsed', collapsed);
            updateHistoryToggleBtnVisual();
        }

        function updateHistoryToggleBtnVisual() {
            const btn = document.getElementById('historyToggleGlobal');
            const panel = document.getElementById('historyPanel');
            if (!btn || !panel) return;
            const collapsed = panel.classList.contains('collapsed');
            if (collapsed) {
                btn.classList.remove('active');
                btn.title = 'æ‰“å¼€å†å²è®°å½•';
            } else {
                btn.classList.add('active');
                btn.title = 'å…³é—­å†å²è®°å½•';
            }
        }
        
        function updateDeletedToggleBtn() {
            const btn = document.getElementById('toggleDeletedBtn');
            if (!btn) return;
            if (state.showDeleted) {
                btn.classList.add('active');
                btn.textContent = 'ğŸ—‚ éšè—å·²åˆ é™¤';
                btn.title = 'éšè—å·²åˆ é™¤è®°å½•';
            } else {
                btn.classList.remove('active');
                btn.textContent = 'ğŸ—‘ æ˜¾ç¤ºå·²åˆ é™¤';
                btn.title = 'æ˜¾ç¤ºå·²åˆ é™¤è®°å½•';
            }
        }
        
        // ========== å¿«æ·é”® ==========
        function initKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ctrl/Cmd + Enter: ç”Ÿæˆ
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    generateSpeech();
                }
                
                // Space: æ’­æ”¾/æš‚åœ
                if (e.key === ' ' && !e.target.matches('input, textarea')) {
                    e.preventDefault();
                    if (state.currentAudio) {
                        togglePlay();
                    }
                }
                
                // Ctrl/Cmd + S: ä¿å­˜åˆ°æ”¶è—
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    openSaveFavoriteModal();
                }
                
                // Ctrl/Cmd + K: æœç´¢éŸ³è‰²
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    document.getElementById('voiceSearch').focus();
                }
                
                // Esc: å…³é—­å¼¹çª—
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
                }
            });
        }
        
        // ========== TTS ç”Ÿæˆ ==========
        async function generateSpeech() {
            const text = document.getElementById('textInput').value.trim();
            
            if (!text) {
                showToast('è¯·è¾“å…¥æ–‡æœ¬', 'error');
                return;
            }

            if (!state.apiKey) {
                showToast('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API Key', 'error');
                document.getElementById('settingsModal').classList.add('active');
                return;
            }

            const btn = document.getElementById('generateBtn');
            const btnText = document.getElementById('generateBtnText');
            btn.disabled = true;
            btnText.innerHTML = '<span class="loading-spinner"></span> ç”Ÿæˆä¸­...';
            
            try {
                const audioUrl = await callTTSAPI(text, state.selectedVoice);
                playAudio(audioUrl);
                addToHistory(text, state.selectedVoice);
                showToast('ç”ŸæˆæˆåŠŸï¼', 'success');
            } catch (error) {
                showToast(`ç”Ÿæˆå¤±è´¥ï¼š${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btnText.textContent = 'ç”Ÿæˆè¯­éŸ³';
            }
        }
        
        async function callTTSAPI(text, voice) {
            const url = `${state.apiBaseUrl}/models/${state.model}:generateContent?key=${state.apiKey}`;
            
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text }] }],
                    generationConfig: {
                        responseModalities: ['AUDIO'],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: {
                                    voiceName: voice
                                }
                            }
                        }
                    }
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || `HTTP ${response.status}`);
            }
            
            const data = await response.json();
            const audioData = data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
            
            if (!audioData) {
                throw new Error('æœªæ‰¾åˆ°éŸ³é¢‘æ•°æ®');
            }
            
            // è½¬æ¢ä¸º WAV
            const pcmData = base64ToBlob(audioData);
            const wavHeader = createWavHeader(pcmData.size);
            const wavBlob = new Blob([wavHeader, pcmData], { type: 'audio/wav' });
            
            return URL.createObjectURL(wavBlob);
        }

        async function previewVoice(voice) {
            if (!state.apiKey) {
                showToast('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API Key', 'error');
                document.getElementById('settingsModal').classList.add('active');
                return;
            }
            try {
                const sample = 'ä½ å¥½ï¼Œè¿™æ˜¯ä¸€æ®µéŸ³è‰²è¯•å¬ã€‚';
                const url = `${state.apiBaseUrl}/models/${state.model}:generateContent?key=${state.apiKey}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: sample }] }],
                        generationConfig: {
                            responseModalities: ['AUDIO'],
                            speechConfig: {
                                voiceConfig: { prebuiltVoiceConfig: { voiceName: voice } }
                            }
                        }
                    })
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error?.message || `HTTP ${response.status}`);
                }
                const data = await response.json();
                const audioData = data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                if (!audioData) throw new Error('æœªè·å¾—éŸ³é¢‘æ•°æ®');
                const pcmData = base64ToBlob(audioData);
                const wavHeader = createWavHeader(pcmData.size);
                const wavBlob = new Blob([wavHeader, pcmData], { type: 'audio/wav' });
                if (previewAudioUrl) URL.revokeObjectURL(previewAudioUrl);
                previewAudioUrl = URL.createObjectURL(wavBlob);
                if (!previewAudioEl) previewAudioEl = new Audio();
                previewAudioEl.src = previewAudioUrl;
                previewAudioEl.play();
                showToast(`æ­£åœ¨è¯•å¬ï¼š${voice}`, 'success');
            } catch (e) {
                showToast(`è¯•å¬å¤±è´¥ï¼š${e.message}`, 'error');
            }
        }
        
        function base64ToBlob(base64) {
            const byteCharacters = atob(base64);
                const byteNumbers = new Array(byteCharacters.length);
                
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                
            return new Blob([new Uint8Array(byteNumbers)]);
        }

        function createWavHeader(dataLength, sampleRate = 24000, numChannels = 1, bitsPerSample = 16) {
            const buffer = new ArrayBuffer(44);
            const view = new DataView(buffer);

            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };
            
            writeString(0, 'RIFF');
            view.setUint32(4, 36 + dataLength, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * numChannels * bitsPerSample / 8, true);
            view.setUint16(32, numChannels * bitsPerSample / 8, true);
            view.setUint16(34, bitsPerSample, true);
            writeString(36, 'data');
            view.setUint32(40, dataLength, true);

            return new Uint8Array(buffer);
        }

        // ========== æ‰¹é‡ç”Ÿæˆ ==========
        async function batchGenerate() {
            const text = document.getElementById('textInput').value.trim();
            const lines = text.split('\n').filter(line => line.trim());
            
            if (lines.length < 2) {
                showToast('è¯·è¾“å…¥å¤šè¡Œæ–‡æœ¬è¿›è¡Œæ‰¹é‡ç”Ÿæˆ', 'error');
                return;
            }
            
            if (!confirm(`å°†ç”Ÿæˆ ${lines.length} ä¸ªéŸ³é¢‘æ–‡ä»¶ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ`)) {
                return;
            }
            
            const btn = document.getElementById('batchBtn');
            btn.disabled = true;
            
            let success = 0;
            for (let i = 0; i < lines.length; i++) {
                try {
                    showToast(`æ­£åœ¨ç”Ÿæˆ ${i + 1}/${lines.length}...`, 'success');
                    await callTTSAPI(lines[i], state.selectedVoice);
                    success++;
                } catch (error) {
                    console.error(error);
                }
            }
            
            btn.disabled = false;
            showToast(`æ‰¹é‡ç”Ÿæˆå®Œæˆï¼æˆåŠŸ ${success}/${lines.length}`, 'success');
        }
        
        // ========== éŸ³é¢‘æ’­æ”¾ ==========
        function playAudio(audioUrl) {
            const audioElement = document.getElementById('audioElement');
            const player = document.getElementById('audioPlayer');
            
            if (state.currentAudio) {
                URL.revokeObjectURL(state.currentAudio);
            }
            
            state.currentAudio = audioUrl;
            audioElement.src = audioUrl;
            player.classList.add('active');
            
            audioElement.play();
            state.isPlaying = true;
            document.getElementById('playBtn').textContent = 'â¸';
            
            startWaveformDraw();
        }
        
        function togglePlay() {
            const audioElement = document.getElementById('audioElement');
            const playBtn = document.getElementById('playBtn');
            
            if (state.isPlaying) {
                audioElement.pause();
                playBtn.textContent = 'â–¶';
            } else {
                audioElement.play();
                playBtn.textContent = 'â¸';
            }
            
            state.isPlaying = !state.isPlaying;
        }
        
        function updateProgress() {
            const audioElement = document.getElementById('audioElement');
            if (!audioElement.duration) return;
            document.getElementById('currentTime').textContent = formatTime(audioElement.currentTime);
            document.getElementById('totalTime').textContent = formatTime(audioElement.duration);
        }
        
        function seekAudio(e) {
            const audioElement = document.getElementById('audioElement');
            const progressBar = document.getElementById('progressBar');
            const percent = e.offsetX / progressBar.offsetWidth;
            audioElement.currentTime = percent * audioElement.duration;
        }
        
        function formatTime(seconds) {
            if (!seconds || isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        function downloadAudio() {
            if (!state.currentAudio) return;
            
            const a = document.createElement('a');
            a.href = state.currentAudio;
            a.download = `tts_${Date.now()}.wav`;
            a.click();
            
            showToast('å¼€å§‹ä¸‹è½½', 'success');
        }
        
        // ========== æ³¢å½¢å¯è§†åŒ– ==========
        function ensureAnalyser() {
            if (audioCtx) return;
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const audioElement = document.getElementById('audioElement');
                sourceNode = audioCtx.createMediaElementSource(audioElement);
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 1024;
                const bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);
                sourceNode.connect(analyser);
                analyser.connect(audioCtx.destination);
            } catch (e) {
                console.warn('AudioContext åˆå§‹åŒ–å¤±è´¥ï¼Œä½¿ç”¨é™çº§æ³¢å½¢', e);
            }
        }

        function startWaveformDraw() {
            ensureAnalyser();
            const canvas = document.getElementById('waveformCanvas');
            const ctx = canvas.getContext('2d');
            cancelAnimationFrame(rafId);

            const render = () => {
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                if (!analyser || !dataArray) {
                    // é™çº§ï¼šç®€å•æ¡å½¢åŠ¨ç”»
                    const barWidth = 2;
                    const gap = 2;
                    const barCount = Math.floor(canvas.width / (barWidth + gap));
                    for (let i = 0; i < barCount; i++) {
                        const height = Math.random() * canvas.height * 0.8 + 2;
                        const x = i * (barWidth + gap);
                        const y = (canvas.height - height) / 2;
                        const grad = ctx.createLinearGradient(0, y, 0, y + height);
                        grad.addColorStop(0, getComputedStyle(document.documentElement).getPropertyValue('--primary-terracotta') || '#D4754E');
                        grad.addColorStop(1, getComputedStyle(document.documentElement).getPropertyValue('--accent-amber') || '#E8A87C');
                        ctx.fillStyle = grad;
                        ctx.fillRect(x, y, barWidth, height);
                    }
                } else {
                    analyser.getByteTimeDomainData(dataArray);
                    const barCount = Math.min(180, Math.floor(canvas.width / 4));
                    const step = Math.max(1, Math.floor(dataArray.length / barCount));
                    for (let i = 0; i < barCount; i++) {
                        const v = dataArray[i * step] / 128.0;
                        const h = Math.max(2, Math.abs(v - 1) * canvas.height * 0.9);
                        const x = i * 4;
                        const y = (canvas.height - h) / 2;
                        const grad = ctx.createLinearGradient(0, y, 0, y + h);
                        grad.addColorStop(0, getComputedStyle(document.documentElement).getPropertyValue('--primary-terracotta') || '#D4754E');
                        grad.addColorStop(1, getComputedStyle(document.documentElement).getPropertyValue('--accent-amber') || '#E8A87C');
                        ctx.fillStyle = grad;
                        ctx.fillRect(x, y, 2, h);
                    }
                }
                rafId = requestAnimationFrame(render);
            };
            rafId = requestAnimationFrame(render);
        }

        function stopWaveformDraw() {
            if (rafId) cancelAnimationFrame(rafId);
        }
        
        // ========== å†å²è®°å½• ==========
        function addToHistory(text, voice) {
            const item = {
                id: Date.now(),
                text: text,  // ä¿å­˜å®Œæ•´æ–‡æœ¬
                voice,
                timestamp: new Date().toLocaleString('zh-CN')
            };
            
            state.history.unshift(item);
            state.history = state.history.slice(0, 100);
            localStorage.setItem('history', JSON.stringify(state.history));
            renderHistory();
        }
        
        function renderHistory() {
            const container = document.getElementById('historyContent');
            
            if (!state.history || state.history.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">æš‚æ— å†å²è®°å½•</p>';
                return;
            }
            
            container.innerHTML = state.history.map(item => `
                <div class="history-item">
                    <div class="item-text">${item.text.substring(0, 100)}${item.text.length > 100 ? '...' : ''}</div>
                    <div class="item-meta">éŸ³è‰²: ${item.voice} Â· ${item.timestamp}</div>
                    <div class="item-actions">
                        <button class="btn-small" onclick="applyHistory(${item.id})">åº”ç”¨</button>
                        <button class="btn-small" onclick="deleteHistory(${item.id})">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        function renderDeleted() {
            const container = document.getElementById('historyContent');
            if (!state.deletedHistory || state.deletedHistory.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">æš‚æ— å·²åˆ é™¤è®°å½•</p>';
                return;
            }
            container.innerHTML = state.deletedHistory.map(item => `
                <div class="history-item">
                    <div class="item-text">${item.text.substring(0, 100)}${item.text.length > 100 ? '...' : ''}</div>
                    <div class="item-meta">éŸ³è‰²: ${item.voice} Â· ${item.timestamp}</div>
                    <div class="item-actions">
                        <button class="btn-small" onclick="restoreDeleted(${item.id})">æ¢å¤</button>
                        <button class="btn-small" onclick="purgeDeleted(${item.id})">å½»åº•åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }
        
        function applyHistory(id) {
            const item = state.history.find(h => h.id === id);
            if (item) {
                document.getElementById('textInput').value = item.text;
                selectVoice(item.voice);
                showToast('å·²åº”ç”¨å†å²è®°å½•', 'success');
            }
        }
        
        function deleteHistory(id) {
            const idx = state.history.findIndex(h => h.id === id);
            if (idx !== -1) {
                lastDeletedHistoryItem = state.history[idx];
                state.history.splice(idx, 1);
                // æ¨å…¥å·²åˆ é™¤
                state.deletedHistory.unshift(lastDeletedHistoryItem);
                localStorage.setItem('history', JSON.stringify(state.history));
                localStorage.setItem('deletedHistory', JSON.stringify(state.deletedHistory));
                renderHistory();
                showToastAction('å·²åˆ é™¤', 'æ’¤é”€', () => {
                    if (lastDeletedHistoryItem) {
                        // ä»å·²åˆ é™¤ç§»é™¤ï¼Œå›åˆ°å†å²
                        state.deletedHistory = state.deletedHistory.filter(i => i.id !== lastDeletedHistoryItem.id);
                        state.history.unshift(lastDeletedHistoryItem);
                        localStorage.setItem('history', JSON.stringify(state.history));
                        localStorage.setItem('deletedHistory', JSON.stringify(state.deletedHistory));
                        renderHistory();
                        lastDeletedHistoryItem = null;
                    }
                }, 'success');
            }
        }

        function restoreDeleted(id) {
            const idx = state.deletedHistory.findIndex(h => h.id === id);
            if (idx !== -1) {
                const item = state.deletedHistory[idx];
                state.deletedHistory.splice(idx, 1);
                state.history.unshift(item);
                localStorage.setItem('history', JSON.stringify(state.history));
                localStorage.setItem('deletedHistory', JSON.stringify(state.deletedHistory));
                renderDeleted();
            }
        }

        function purgeDeleted(id) {
            state.deletedHistory = state.deletedHistory.filter(h => h.id !== id);
            localStorage.setItem('deletedHistory', JSON.stringify(state.deletedHistory));
            renderDeleted();
        }
        
        // ========== æ”¶è—åŠŸèƒ½ ==========
        function openSaveFavoriteModal() {
            const text = document.getElementById('textInput').value.trim();
            if (!text) {
                showToast('è¯·å…ˆè¾“å…¥æ–‡æœ¬', 'error');
                return;
            }
            
            document.getElementById('saveFavoriteModal').classList.add('active');
            document.getElementById('favoriteName').value = '';
            document.getElementById('favoriteName').focus();
        }
        
        function saveFavorite() {
            const name = document.getElementById('favoriteName').value.trim();
            const text = document.getElementById('textInput').value.trim();
            
            if (!name) {
                showToast('è¯·è¾“å…¥æ”¶è—åç§°', 'error');
                return;
            }
            
            const item = {
                id: Date.now(),
                name,
                text,
                voice: state.selectedVoice,
                timestamp: new Date().toLocaleString('zh-CN')
            };
            
            state.favorites.unshift(item);
            localStorage.setItem('favorites', JSON.stringify(state.favorites));
            renderFavorites();
            
            document.getElementById('saveFavoriteModal').classList.remove('active');
            showToast('ä¿å­˜æˆåŠŸï¼', 'success');
        }
        
        function renderFavorites() {
            const container = document.getElementById('favoritesContent');
            
            if (state.favorites.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">æš‚æ— æ”¶è—</p>';
                return;
            }
            
            container.innerHTML = state.favorites.map(item => `
                <div class="favorite-item">
                    <div style="font-weight: 600; margin-bottom: 0.5rem;">${item.name}</div>
                    <div class="item-text">${item.text}</div>
                    <div class="item-meta">éŸ³è‰²: ${item.voice}</div>
                    <div class="item-actions">
                        <button class="btn-small" onclick="applyFavorite(${item.id})">åº”ç”¨</button>
                        <button class="btn-small" onclick="deleteFavorite(${item.id})">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }
        
        function applyFavorite(id) {
            const item = state.favorites.find(f => f.id === id);
            if (item) {
                document.getElementById('textInput').value = item.text;
                selectVoice(item.voice);
                showToast('å·²åº”ç”¨æ”¶è—é…ç½®', 'success');
            }
        }
        
        function deleteFavorite(id) {
            state.favorites = state.favorites.filter(f => f.id !== id);
            localStorage.setItem('favorites', JSON.stringify(state.favorites));
            renderFavorites();
            showToast('å·²åˆ é™¤', 'success');
        }
        
        // ========== è®¾ç½® ==========
        function loadSettings() {
            document.getElementById('apiKey').value = state.apiKey;
            document.getElementById('apiBaseUrl').value = state.apiBaseUrl;
            document.getElementById('modelSelect').value = state.model;
        }
        
        function saveSettings() {
            state.apiKey = document.getElementById('apiKey').value.trim();
            state.apiBaseUrl = document.getElementById('apiBaseUrl').value.trim();
            state.model = document.getElementById('modelSelect').value;
            
            localStorage.setItem('apiKey', state.apiKey);
            localStorage.setItem('apiBaseUrl', state.apiBaseUrl);
            localStorage.setItem('model', state.model);
            
            document.getElementById('settingsModal').classList.remove('active');
            showToast('è®¾ç½®å·²ä¿å­˜', 'success');
        }
        
        // ========== å·¥å…·å‡½æ•° ==========
        function updateCharCount() {
            const text = document.getElementById('textInput').value;
            const count = text.length;
            document.getElementById('charCount').textContent = `${count} å­—ç¬¦`;
            
            if (count > 0) {
                const estimatedSeconds = Math.ceil(count / 10);
                document.getElementById('estimatedTime').textContent = `é¢„è®¡ ${estimatedSeconds} ç§’`;
            } else {
                document.getElementById('estimatedTime').textContent = '';
            }
        }
        
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const content = document.createElement('span');
            content.textContent = message;
            const close = document.createElement('button');
            close.className = 'close';
            close.textContent = 'âœ•';
            close.addEventListener('click', () => toast.remove());
            toast.appendChild(content);
            toast.appendChild(close);
            container.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.style.animation = 'slideIn 0.3s reverse';
                    setTimeout(() => toast.remove(), 300);
                }
            }, 3000);
        }

        function showToastAction(message, actionText, actionFn, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const content = document.createElement('span');
            content.textContent = message;
            const actionBtn = document.createElement('button');
            actionBtn.className = 'close';
            actionBtn.textContent = actionText;
            actionBtn.style.fontWeight = '600';
            actionBtn.style.color = 'var(--primary-terracotta)';
            actionBtn.addEventListener('click', () => { actionFn(); toast.remove(); });
            const close = document.createElement('button');
            close.className = 'close';
            close.textContent = 'âœ•';
            close.addEventListener('click', () => toast.remove());
            toast.appendChild(content);
            toast.appendChild(actionBtn);
            toast.appendChild(close);
            container.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.style.animation = 'slideIn 0.3s reverse';
                    setTimeout(() => toast.remove(), 300);
                }
            }, 4000);
        }
        
        // æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (state.currentAudio) {
                URL.revokeObjectURL(state.currentAudio);
            }
        });
    </script>
</body>
</html>
