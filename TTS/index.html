<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini TTS ‰∏ì‰∏öÁâà</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23D4754E;stop-opacity:1' /%3E%3Cstop offset='50%25' style='stop-color:%23C86240;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%239B5D42;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='50' cy='50' r='48' fill='url(%23grad)'/%3E%3Cpath d='M35 38 Q50 28 65 38 L65 62 Q50 72 35 62 Z' fill='%23FFF9F0' opacity='0.95'/%3E%3Cellipse cx='50' cy='43' rx='9' ry='7' fill='url(%23grad)'/%3E%3C/svg%3E">
    <style>
        /* ========== CSS ÂèòÈáèÁ≥ªÁªü - ‰ºòÈõÖÊöñË∞ÉÈÖçËâ≤ ========== */
        :root {
            /* ‰∏ªËâ≤Ë∞É - Terracotta & Sienna Èô∂ÂúüËâ≤Á≥ª */
            --primary-terracotta: #D4754E;
            --primary-sienna: #C86240;
            --accent-amber: #E8A87C;
            --accent-bronze: #9B5D42;
            
            /* ËæÖÂä©Ëâ≤ - Ê∏©ÊöñÁ±≥Ëâ≤Á≥ªÔºàÊõ¥ÊúâËÆæËÆ°ÊÑüÔºâ */
            --bg-primary: #F8F6F4;
            --bg-secondary: #EDE8E4;
            --bg-card: rgba(248, 246, 244, 0.88);
            --text-primary: #2D2424;
            --text-secondary: #6B5E5E;
            --border-color: rgba(212, 117, 78, 0.14);
            --shadow-sm: rgba(155, 93, 66, 0.09);
            --shadow-md: rgba(155, 93, 66, 0.14);
            --shadow-lg: rgba(155, 93, 66, 0.20);
            
            /* ÁÇπÁºÄËâ≤ */
            --sage-green: #8A9A8E;
            --cream: #FFF9F0;
            --charcoal: #3D3434;
            
            /* Ë°®Èù¢Ëâ≤Â±ÇÁ∫ßÔºàÁªü‰∏ÄÁ©∫ÁôΩ‰∏éÂç°ÁâáÁöÑËßÜËßâÁ≥ªÁªüÔºâ */
            --surface-1: rgba(248, 246, 244, 0.90);
            --surface-2: #F0EBE7;
            --surface-3: #E6DED8;
            --grid-line-color: rgba(61, 52, 52, 0.06);
            --wave-line-color: rgba(45, 36, 36, 0.9);
            
            /* Â∏ÉÂ±Ä */
            --sidebar-width: 280px;
            --history-width: 280px;
            --header-height: 60px;
            --player-height: 84px;
            --player-height-collapsed: 56px;
            --border-radius: 20px;
            --border-radius-sm: 14px;
            
            /* Âä®Áîª */
            --transition-smooth: cubic-bezier(0.4, 0, 0.2, 1);
            --transition-bounce: cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        [data-theme="dark"] {
            --bg-primary: #1A1514;
            --bg-secondary: #2A2220;
            --bg-card: rgba(42, 34, 32, 0.85);
            --text-primary: #F5EDE8;
            --text-secondary: #B8ADA8;
            --border-color: rgba(212, 117, 78, 0.15);
            --shadow-sm: rgba(0, 0, 0, 0.25);
            --shadow-md: rgba(0, 0, 0, 0.35);
            --shadow-lg: rgba(0, 0, 0, 0.45);
            --cream: #2A2220;
            --charcoal: #F5EDE8;
            --surface-1: rgba(42, 34, 32, 0.88);
            --surface-2: #251E1C;
            --surface-3: #2E2624;
            --grid-line-color: rgba(245, 237, 232, 0.06);
            --wave-line-color: rgba(255, 255, 255, 0.9);
        }
        
        /* ========== Âü∫Á°ÄÊ†∑Âºè ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans SC', sans-serif;
            background: 
                radial-gradient(ellipse at top left, var(--cream) 0%, transparent 50%),
                radial-gradient(ellipse at bottom right, var(--bg-secondary) 0%, transparent 50%),
                linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            overflow: hidden;
            transition: background 0.5s var(--transition-smooth);
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 15% 25%, rgba(232, 168, 124, 0.04) 0%, transparent 40%),
                radial-gradient(circle at 85% 75%, rgba(138, 154, 142, 0.03) 0%, transparent 40%),
                radial-gradient(circle at 50% 50%, rgba(212, 117, 78, 0.02) 0%, transparent 60%);
            pointer-events: none;
            z-index: 0;
        }
        /* ÁªÜËÖªÁΩëÊ†ºÁ∫πÁêÜÔºåÊèêÂçáÁ©∫ÁôΩÂå∫ÂüüÁöÑËÆæËÆ°ÊÑü */
        body::after {
            content: '';
            position: fixed;
            inset: 0;
            pointer-events: none;
            background-image:
                repeating-linear-gradient(0deg, var(--grid-line-color) 0 1px, transparent 1px 24px),
                repeating-linear-gradient(90deg, var(--grid-line-color) 0 1px, transparent 1px 24px);
            z-index: 0;
        }
        
        /* ========== Â∏ÉÂ±ÄÂÆπÂô® ========== */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            position: relative;
            z-index: 1;
        }
        
        .app-header {
            height: var(--header-height);
            background: var(--bg-card);
            backdrop-filter: blur(12px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            box-shadow: 0 1px 3px var(--shadow-sm);
            z-index: 100;
        }
        
.header-left { display: flex; align-items: center; gap: 0.75rem; }

.logo {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-terracotta) 0%, var(--primary-sienna) 50%, var(--accent-bronze) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.5px;
        }
        
        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        .header-actions .chip-btn { margin: 0; }
        
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        /* ========== ‰æßËæπÊ†è - Èü≥Ëâ≤ÈÄâÊã©Âô® ========== */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--surface-1);
            backdrop-filter: blur(12px);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 2px 0 12px var(--shadow-sm);
        }
        .sidebar.collapsed { display: none; }
        
        .sidebar-header {
            padding: 1.5rem;
            background: linear-gradient(to bottom, transparent, var(--border-color) 100%);
            background-size: 100% 1px;
            background-position: bottom;
            background-repeat: no-repeat;
        }
        
        .sidebar-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }
        
        .voice-search {
            width: 100%;
            padding: 0.875rem 1.125rem;
            border: 2px solid transparent;
            border-radius: var(--border-radius-sm);
            font-size: 0.9rem;
            background: linear-gradient(to right, rgba(255, 255, 255, 0.5), rgba(255, 244, 230, 0.3));
            color: var(--text-primary);
            transition: all 0.3s var(--transition-smooth);
            box-shadow: inset 0 1px 2px var(--shadow-sm);
        }
        
        .voice-search:focus {
            outline: none;
            border-color: var(--primary-terracotta);
            box-shadow: 0 0 0 4px rgba(212, 117, 78, 0.12), inset 0 1px 2px var(--shadow-sm);
            background: rgba(255, 255, 255, 0.9);
        }

        /* ÊöóÈªëÊ®°ÂºèËæìÂÖ•Á±ª‰øÆÂ§ç */
        [data-theme="dark"] .text-input,
        [data-theme="dark"] .form-input,
        [data-theme="dark"] .voice-search {
            background: linear-gradient(to bottom, rgba(245, 237, 232, 0.06), rgba(245, 237, 232, 0.04));
            border-color: rgba(245, 237, 232, 0.14);
            color: var(--text-primary);
            caret-color: var(--accent-amber);
        }
        [data-theme="dark"] .text-input:focus,
        [data-theme="dark"] .form-input:focus,
        [data-theme="dark"] .voice-search:focus {
            background: rgba(245, 237, 232, 0.12);
            border-color: var(--primary-terracotta);
            box-shadow: 0 0 0 4px rgba(212, 117, 78, 0.16), inset 0 1px 2px rgba(0,0,0,0.2);
        }
        [data-theme="dark"] .text-input::placeholder,
        [data-theme="dark"] .form-input::placeholder,
        [data-theme="dark"] .voice-search::placeholder {
            color: rgba(245, 237, 232, 0.6);
        }
        
        .voice-list {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .voice-category {
            margin-bottom: 1.5rem;
        }
        
        .category-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.25rem;
            background: linear-gradient(135deg, var(--primary-terracotta) 0%, var(--primary-sienna) 100%);
            color: var(--cream);
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 0.875rem;
            transition: all 0.3s var(--transition-smooth);
            box-shadow: 0 3px 12px var(--shadow-md);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .category-header:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 24px var(--shadow-lg);
            background: linear-gradient(135deg, var(--primary-sienna) 0%, var(--accent-bronze) 100%);
        }
        
        .category-header:active {
            transform: translateY(0);
        }
        
        .category-arrow {
            transition: transform 0.3s var(--transition-smooth);
            display: inline-block;
        }
        
        .category-header.collapsed .category-arrow {
            transform: rotate(-90deg);
        }
        
        .category-content {
            display: none;
            padding-left: 0.5rem;
            overflow: hidden;
            transition: max-height 0.3s var(--transition-smooth);
        }
        
        .category-content.active {
            display: block;
        }

        .voice-item {
            padding: 0.875rem 1.125rem;
            margin: 0.375rem 0;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.3s var(--transition-smooth);
            position: relative;
            background: transparent;
        }
        
        .voice-item:hover {
            background: linear-gradient(to right, rgba(232, 168, 124, 0.15), transparent);
            border-color: rgba(212, 117, 78, 0.25);
            transform: translateX(3px);
        }
        
        .voice-item.selected {
            background: linear-gradient(135deg, rgba(232, 168, 124, 0.2) 0%, rgba(212, 117, 78, 0.1) 100%);
            border-color: var(--primary-terracotta);
            box-shadow: 0 4px 16px var(--shadow-md);
            transform: scale(1.02);
            border-width: 1.5px;
        }
        
        .voice-item-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .voice-icon {
            font-size: 1.1rem;
        }
        
        .voice-item-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 0.5rem;
        }
        .voice-item-meta .meta-left { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        
        .voice-tag {
            font-size: 0.75rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            background: var(--bg-primary);
            color: var(--text-secondary);
        }
        
        .favorite-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .voice-item:hover .favorite-btn,
        .favorite-btn.active {
            opacity: 1;
        }

        .preview-btn {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            background: rgba(0,0,0,0.04);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 6px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s, background 0.2s;
        }
        .voice-item:hover .preview-btn { opacity: 1; }
        .preview-btn:hover { background: rgba(0,0,0,0.06); }

        .preview-inline {
            background: rgba(0,0,0,0.04);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 999px;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            white-space: nowrap;
        }
        .preview-inline:hover { background: rgba(0,0,0,0.06); transform: translateY(-1px); }
        
        /* Â§öÈÄâÊ®°Âºè */
        .multi-select-mode .sidebar-header {
            background: linear-gradient(135deg, rgba(212, 117, 78, 0.1), rgba(232, 168, 124, 0.08));
        }
        
        .voice-checkbox {
            position: absolute;
            top: 0.75rem;
            left: 0.75rem;
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary-terracotta);
            display: none;
        }
        
        .multi-select-mode .voice-checkbox {
            display: block;
        }
        
        .multi-select-mode .voice-item {
            padding-left: 2.5rem;
        }
        
        .multi-count {
            display: none;
            background: linear-gradient(135deg, var(--primary-terracotta), var(--primary-sienna));
            color: var(--cream);
            padding: 0.4rem 0.8rem;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }
        
        .multi-select-mode .multi-count {
            display: inline-block;
        }
        
        /* ÂØπÊØîÂàóË°® - ÈõÜÊàêÂà∞Êí≠ÊîæÂô®ÂÜÖ */
        .compare-playlist {
            display: none;
            padding: 0.75rem 1.25rem 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        }
        
        [data-theme="dark"] .compare-playlist {
            border-bottom-color: rgba(255, 255, 255, 0.1);
        }
        
        .compare-playlist.active {
            display: block;
        }
        
        .compare-playlist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        
        .compare-playlist-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .compare-playlist-controls {
            display: flex;
            gap: 0.4rem;
            align-items: center;
        }
        
        .compare-list {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 0.5rem;
            scroll-behavior: smooth;
        }
        
        .compare-list::-webkit-scrollbar {
            height: 4px;
        }
        
        .compare-list::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 2px;
        }
        
        .compare-list::-webkit-scrollbar-thumb {
            background: linear-gradient(90deg, var(--primary-terracotta), var(--primary-sienna));
            border-radius: 2px;
        }
        
        .compare-item {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 244, 230, 0.7));
            border-radius: 10px;
            padding: 0.6rem 0.8rem;
            min-width: 140px;
            max-width: 160px;
            flex-shrink: 0;
            border: 1.5px solid transparent;
            transition: all 0.25s var(--transition-smooth);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        [data-theme="dark"] .compare-item {
            background: linear-gradient(135deg, rgba(42, 34, 32, 0.9), rgba(37, 30, 28, 0.8));
        }
        
        .compare-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--primary-terracotta), var(--accent-amber));
            opacity: 0;
            transition: opacity 0.25s;
        }
        
        .compare-item:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 4px 12px var(--shadow-md);
            border-color: rgba(212, 117, 78, 0.4);
        }
        
        .compare-item:hover::before {
            opacity: 1;
        }
        
        .compare-item.playing {
            border-color: var(--primary-terracotta);
            box-shadow: 0 4px 16px var(--shadow-lg);
            background: linear-gradient(135deg, rgba(232, 168, 124, 0.25), rgba(212, 117, 78, 0.15));
        }
        
        .compare-item.playing::before {
            opacity: 1;
            height: 3px;
        }
        
        .compare-item.playing::after {
            content: '‚ñ∂';
            position: absolute;
            bottom: 0.4rem;
            right: 0.5rem;
            font-size: 0.7rem;
            color: var(--primary-terracotta);
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        .compare-item-download {
            position: absolute;
            top: 0.4rem;
            right: 0.4rem;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: none;
            background: rgba(0, 0, 0, 0.1);
            color: var(--text-secondary);
            font-size: 0.7rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.2s;
            z-index: 10;
        }
        
        .compare-item:hover .compare-item-download {
            opacity: 1;
        }
        
        .compare-item-download:hover {
            background: linear-gradient(135deg, var(--primary-terracotta), var(--primary-sienna));
            color: var(--cream);
            transform: scale(1.1);
        }
        
        [data-theme="dark"] .compare-item-download {
            background: rgba(255, 255, 255, 0.15);
            color: var(--text-primary);
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .compare-voice-name {
            font-weight: 700;
            font-size: 0.9rem;
            color: var(--text-primary);
            margin-bottom: 0.3rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .compare-voice-meta {
            font-size: 0.7rem;
            color: var(--text-secondary);
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
        }
        
        .compare-voice-trait {
            display: inline-block;
            padding: 0.15rem 0.4rem;
            background: rgba(212, 117, 78, 0.15);
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 500;
            color: var(--primary-sienna);
            width: fit-content;
        }
        
        .audio-player.has-playlist {
            height: auto;
            min-height: 200px;
            max-height: 320px;
        }
        
        .player-empty-state {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.85rem;
            padding: 0;
            opacity: 0.6;
            min-height: 0;
        }
        
        .player-empty-state.hidden {
            display: none;
        }
        
        /* ÂΩìÊòæÁ§∫Á©∫Áä∂ÊÄÅÊó∂ÔºåÈöêËóèÊí≠ÊîæÊéßÂà∂ */
        .audio-player:not(.has-content) .player-controls {
            display: none;
        }
        
        /* ÊúâÂÜÖÂÆπÊó∂ÊòæÁ§∫Êí≠ÊîæÊéßÂà∂ */
        .audio-player.has-content {
            min-height: var(--player-height);
        }
        
        .audio-player.has-content .player-controls {
            display: flex;
        }
        
        .audio-player.has-content .player-empty-state {
            display: none;
        }
        
        /* ========== ‰∏≠Â§ÆÂ∑•‰ΩúÂå∫ ========== */
        .workspace {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 2rem;
            overflow-y: auto;
        }
        
        .workspace-card {
            background: var(--surface-1);
            backdrop-filter: blur(12px);
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: 0 2px 20px var(--shadow-sm), 0 0 0 1px var(--border-color);
            margin-bottom: 1.5rem;
            transition: all 0.3s var(--transition-smooth);
        }
        
        .workspace-card:hover {
            box-shadow: 0 6px 36px var(--shadow-md), 0 0 0 1px rgba(212, 117, 78, 0.2);
            transform: translateY(-3px);
        }
        
        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
          margin-bottom: 1rem;
            color: var(--text-primary);
        }
        
        .textarea-container {
            position: relative;
        }
        
        .text-input {
            width: 100%;
            min-height: 200px;
            padding: 1.25rem;
            border: 2px solid transparent;
            border-radius: var(--border-radius-sm);
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0.5), rgba(255, 244, 230, 0.2));
            color: var(--text-primary);
            transition: background-color 0.25s var(--transition-smooth), border-color 0.25s var(--transition-smooth), box-shadow 0.25s var(--transition-smooth);
            box-shadow: inset 0 1px 3px var(--shadow-sm);
        }
        
        .text-input:focus {
            outline: none;
            border-color: var(--primary-terracotta);
            box-shadow: 0 0 0 4px rgba(212, 117, 78, 0.12), inset 0 1px 3px var(--shadow-sm);
            background: rgba(255, 255, 255, 0.95);
        }
        
        .text-meta {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .btn {
            padding: 0.875rem 2rem;
            border: none;
          border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s var(--transition-smooth);
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-terracotta) 0%, var(--primary-sienna) 100%);
            color: var(--cream);
            box-shadow: 0 4px 16px var(--shadow-md);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 28px var(--shadow-lg);
            background: linear-gradient(135deg, var(--primary-sienna) 0%, var(--accent-bronze) 100%);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1.5px solid var(--border-color);
            backdrop-filter: blur(8px);
        }
        
        .btn-secondary:hover {
            background: linear-gradient(135deg, rgba(232, 168, 124, 0.12), rgba(212, 117, 78, 0.08));
            border-color: var(--primary-terracotta);
            color: var(--primary-sienna);
        }
        
        /* ========== Âè≥‰æßÂéÜÂè≤Èù¢Êùø ========== */
        .history-panel {
            width: var(--history-width);
            background: var(--surface-1);
            backdrop-filter: blur(12px);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: transform 0.3s var(--transition-smooth);
            box-shadow: -2px 0 12px var(--shadow-sm);
        }
        
        .history-panel.collapsed {
            transform: translateX(100%);
        }
        
        .panel-header {
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to bottom, transparent, var(--border-color) 100%);
            background-size: 100% 1px;
            background-position: bottom;
            background-repeat: no-repeat;
        }
        
        .panel-title {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .chip-btn {
            border: 1px solid var(--border-color);
            background: var(--surface-1);
            color: var(--text-primary);
            border-radius: 999px;
            padding: 0.35rem 0.65rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: auto;
            margin-right: 0.5rem;
        }
        .chip-btn:hover { transform: translateY(-1px); }
        .chip-btn.active { border-color: var(--primary-terracotta); color: var(--primary-sienna); }
        
        .panel-tabs {
            display: flex;
            padding: 0 1rem;
            background: linear-gradient(to bottom, transparent, var(--border-color) 100%);
            background-size: 100% 1px;
            background-position: bottom;
            background-repeat: no-repeat;
        }
        
        .tab {
            flex: 1;
            padding: 1rem;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.3s var(--transition-smooth);
        }
        
        .tab.active {
            color: var(--primary-terracotta);
            border-bottom-color: var(--primary-terracotta);
            font-weight: 600;
        }
        
        .tab:hover:not(.active) {
            color: var(--primary-sienna);
        }
        
        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .history-item, .favorite-item {
            padding: 1rem;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.5), rgba(255, 244, 230, 0.3));
            border-radius: var(--border-radius-sm);
            margin-bottom: 0.75rem;
            border: 1px solid transparent;
            transition: all 0.3s var(--transition-smooth);
            backdrop-filter: blur(8px);
        }
        
        .history-item:hover, .favorite-item:hover {
            border-color: rgba(212, 117, 78, 0.3);
            box-shadow: 0 6px 20px var(--shadow-md);
            transform: translateY(-2px);
        }
        
        .item-text {
            font-size: 0.9rem;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .item-meta {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }
        
        .item-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-small {
            padding: 0.4rem 0.8rem;
            font-size: 0.75rem;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            background: var(--bg-card);
            color: var(--text-primary);
            transition: all 0.3s;
        }
        
        .btn-small:hover {
            background: linear-gradient(135deg, var(--primary-terracotta), var(--primary-sienna));
            color: var(--cream);
            transform: translateY(-1px);
        }
        
        /* ========== Èü≥È¢ëÊí≠ÊîæÂô® ========== */
        .audio-player {
            min-height: 60px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 246, 244, 0.95) 100%);
            -webkit-backdrop-filter: blur(14px);
            backdrop-filter: blur(14px);
            padding: 1rem 1.25rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 0.75rem;
            box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.12);
            border-top: 1px solid rgba(0, 0, 0, 0.06);
            border-radius: 12px;
            position: static;
            margin: 12px 12px 12px 12px;
            color: var(--text-primary);
        }

        [data-theme="dark"] .audio-player {
            background: linear-gradient(135deg, rgba(45, 36, 36, 0.98) 0%, rgba(61, 52, 52, 0.98) 100%);
            box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.3);
            border-top: 1px solid rgba(212, 117, 78, 0.2);
            color: #fff;
        }
        
        .waveform-wrapper {
            position: relative;
            width: 100%;
            height: 48px;
        }
        
        .player-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
            width: 100%;
        }
        
        .play-btn {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-terracotta) 0%, var(--primary-sienna) 100%);
            border: none;
            color: var(--cream);
            font-size: 1.3rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.25s var(--transition-smooth);
            box-shadow: 0 2px 12px rgba(212, 117, 78, 0.35);
            flex-shrink: 0;
        }
        
        .play-btn:hover {
            transform: scale(1.08);
            box-shadow: 0 4px 20px rgba(212, 117, 78, 0.45);
        }
        
        .play-btn:active {
            transform: scale(1.0);
        }
        
        .time-label {
            color: var(--text-primary);
            font-size: 0.8rem;
            font-weight: 500;
            min-width: 42px;
            text-align: center;
            flex-shrink: 0;
        }
        [data-theme="dark"] .audio-player .time-label { color: rgba(255,255,255,0.85); }
        
        .progress-container {
            flex: 1;
            display: flex;
            align-items: center;
        }
        
        .progress-bar {
            height: 5px;
            width: 100%;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 3px;
            cursor: pointer;
            position: relative;
            transition: height 0.2s;
        }
        
        .progress-bar:hover {
            height: 6px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-terracotta) 0%, var(--accent-amber) 100%);
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s linear;
            box-shadow: 0 0 10px rgba(212, 117, 78, 0.6);
            position: relative;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            right: -1px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background: var(--cream);
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .progress-bar:hover .progress-fill::after {
            opacity: 1;
        }
        
        .wave-tooltip {
            position: absolute;
            top: -32px;
            left: 0;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.75);
            color: #fff;
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 6px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s ease;
            white-space: nowrap;
        }
        
        .player-extra {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-shrink: 0;
        }

        .speed-group { position: relative; }
        .speed-menu {
            position: absolute;
            bottom: 120%;
            right: 0;
            display: none;
            min-width: 120px;
            background: rgba(255, 255, 255, 0.92);
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(0,0,0,0.08);
            border-radius: 12px;
            padding: 6px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            z-index: 50;
            color: var(--text-primary);
        }
        [data-theme="dark"] .speed-menu {
            background: rgba(20, 16, 15, 0.94);
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 10px 30px rgba(0,0,0,0.45);
            color: #fff;
        }
        .speed-menu.visible { display: block; }
        .speed-item {
            width: 100%;
            text-align: left;
            padding: 6px 10px;
            color: inherit;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        .speed-item:hover { background: rgba(0,0,0,0.06); }
        .speed-item.active { background: rgba(0,0,0,0.08); font-weight: 600; }
        [data-theme="dark"] .speed-item:hover { background: rgba(255,255,255,0.12); }
        [data-theme="dark"] .speed-item.active { background: rgba(255,255,255,0.16); }
        
        .icon-control {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: rgba(0, 0, 0, 0.06);
            color: var(--text-primary);
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .icon-control:hover {
            background: rgba(0, 0, 0, 0.1);
            transform: scale(1.05);
        }
        
        .icon-control.active {
            background: linear-gradient(135deg, var(--primary-terracotta), var(--primary-sienna));
            color: var(--cream);
        }
        
        [data-theme="dark"] .audio-player .icon-control { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.85); }
        [data-theme="dark"] .audio-player .icon-control:hover { background: rgba(255,255,255,0.18); }
        [data-theme="dark"] .audio-player .icon-control.active {
            background: linear-gradient(135deg, var(--primary-terracotta), var(--primary-sienna));
            color: var(--cream);
        }
        
        .slider {
            width: 70px;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 2px;
            outline: none;
            cursor: pointer;
        }
        
        [data-theme="dark"] .audio-player .slider {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-terracotta), var(--primary-sienna));
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s;
        }
        
        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.25);
            box-shadow: 0 3px 12px rgba(212, 117, 78, 0.5);
        }
        
        .speed-select {
            background: rgba(255, 255, 255, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.25);
            color: var(--cream);
            padding: 0.35rem 0.6rem;
            border-radius: 10px;
            font-size: 0.8rem;
            cursor: pointer;
            outline: none;
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
        }
        .speed-select:hover { background: rgba(255, 255, 255, 0.18); }
        
        /* ========== ÂõæÊ†áÊåâÈíÆ ========== */
        .icon-btn {
            width: 42px;
            height: 42px;
            border-radius: 11px;
            border: 1px solid transparent;
            background: rgba(212, 117, 78, 0.1);
            color: var(--text-primary);
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s var(--transition-smooth);
            backdrop-filter: blur(4px);
        }
        
        .icon-btn:hover {
            background: linear-gradient(135deg, var(--primary-terracotta) 0%, var(--primary-sienna) 100%);
            color: var(--cream);
            border-color: transparent;
            transform: scale(1.08);
            box-shadow: 0 6px 20px var(--shadow-md);
        }
        
        .icon-btn:active {
            transform: scale(0.96);
        }
        
        .icon-btn.active {
            background: linear-gradient(135deg, var(--primary-terracotta) 0%, var(--primary-sienna) 100%);
            color: var(--cream);
            border-color: transparent;
        }
        
        /* ========== Toast ÈÄöÁü• ========== */
        .toast-container {
            position: fixed;
            top: calc(var(--header-height) + 0.5rem);
            right: 1rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .toast {
            background: var(--surface-1);
            backdrop-filter: blur(12px);
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius-sm);
            box-shadow: 0 8px 32px var(--shadow-lg);
            border-left: 4px solid var(--primary-terracotta);
            animation: slideIn 0.3s var(--transition-smooth);
            min-width: 320px;
            border: 1px solid var(--border-color);
            border-left-width: 4px;
        }

        .toast .close {
            margin-left: 0.75rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1rem;
        }
        
        .toast.success {
            border-left-color: var(--sage-green);
        }
        
        .toast.error {
            border-left-color: #D64545;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* ========== Modal ========== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1600;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: var(--surface-1);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius);
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px var(--shadow-lg), 0 0 0 1px var(--border-color);
        }
        
        .modal-header {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-right: 0.5rem;
        }
        
        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: rgba(212, 117, 78, 0.1);
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s var(--transition-smooth);
            line-height: 1;
        }
        
        .modal-close:hover {
            background: var(--primary-terracotta);
            color: var(--cream);
            transform: scale(1.1) rotate(90deg);
        }
        
        [data-theme="dark"] .modal-close {
            background: rgba(245, 237, 232, 0.15);
            color: var(--text-primary);
        }
        
        [data-theme="dark"] .modal-close:hover {
            background: var(--primary-terracotta);
            color: var(--cream);
        }
        
        .modal-body {
            margin-bottom: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .form-input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid transparent;
            border-radius: var(--border-radius-sm);
            font-size: 1rem;
            background: linear-gradient(to right, rgba(255, 255, 255, 0.5), rgba(255, 244, 230, 0.3));
            color: var(--text-primary);
            transition: all 0.3s var(--transition-smooth);
            box-shadow: inset 0 1px 2px var(--shadow-sm);
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-terracotta);
            box-shadow: 0 0 0 4px rgba(212, 117, 78, 0.12), inset 0 1px 2px var(--shadow-sm);
            background: rgba(255, 255, 255, 0.95);
        }
        
        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }
        
        /* ========== Âä†ËΩΩÂä®Áîª ========== */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ========== Ê≥¢ÂΩ¢ÂèØËßÜÂåñ ========== */
        .waveform-canvas {
            width: 100%;
            height: 100%;
            cursor: pointer;
            border-radius: 6px;
            transition: opacity 0.2s;
        }
        
        .waveform-canvas:hover {
            opacity: 0.9;
        }
        
        /* ========== ÂìçÂ∫îÂºèËÆæËÆ° ========== */
        @media (max-width: 1024px) {
            .sidebar {
                position: absolute;
                left: 0;
                top: var(--header-height);
                height: calc(100vh - var(--header-height));
                z-index: 50;
                transform: translateX(-100%);
                transition: transform 0.3s var(--transition-smooth);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .history-panel {
                display: none;
            }
            
            .compare-panel {
                width: 100%;
            }
        }

        @media (max-width: 768px) {
            .app-header {
                padding: 0 1rem;
            }
            
            .workspace {
                padding: 1rem;
            }
            
            .audio-player {
                padding: 0.75rem 1rem;
                min-height: 50px;
                margin: 8px 8px 8px 8px;
            }
            
            .audio-player.has-content {
                min-height: 70px;
            }
            
            .waveform-wrapper {
                height: 24px;
            }
            
            .player-controls {
                gap: 0.5rem;
            }
            
            .play-btn {
                width: 36px;
                height: 36px;
                font-size: 1.1rem;
            }
            
            .time-label {
                font-size: 0.7rem;
                min-width: 36px;
            }
            
            .slider {
                width: 50px;
            }
            
            .icon-control {
                width: 28px;
                height: 28px;
                font-size: 0.9rem;
            }
            
            .chip-btn {
                font-size: 0.75rem;
                padding: 0.3rem 0.55rem;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .compare-item {
                min-width: 120px;
                max-width: 140px;
            }
            
            .compare-playlist-controls {
                flex-wrap: wrap;
            }
        }
        
        /* ========== ÊªöÂä®Êù°Ê†∑Âºè ========== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary-terracotta), var(--primary-sienna));
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, var(--primary-sienna), var(--accent-bronze));
        }
        
        /* ========== ÈöêËóèÁ±ª ========== */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- È°∂ÈÉ®ÂØºËà™ -->
        <header class="app-header">
            <div class="header-left">
                <button class="icon-btn" id="toggleSidebar" title="Èü≥Ëâ≤ÈÄâÊã©Âô®">‚ò∞</button>
                <div class="logo">üéôÔ∏è Gemini TTS Pro</div>
            </div>
            <div class="header-actions">
                <button class="chip-btn" id="compareToggleGlobal" title="ÂØπÊØîÂàóË°®" style="display: none;">üé≠ Êí≠ÊîæÂàóË°®</button>
                <button class="chip-btn" id="historyToggleGlobal" title="ÊâìÂºÄÂéÜÂè≤ËÆ∞ÂΩï">üìú ÂéÜÂè≤</button>
                <button class="icon-btn" id="themeToggle" title="ÂàáÊç¢‰∏ªÈ¢ò">üåì</button>
                <button class="icon-btn" id="settingsBtn" title="ËÆæÁΩÆ">‚öôÔ∏è</button>
                <button class="icon-btn" id="helpBtn" title="Âø´Êç∑ÈîÆÂ∏ÆÂä©">üí°</button>
            </div>
        </header>
        
        <!-- ‰∏ªÂÜÖÂÆπÂå∫ -->
        <main class="main-content">
            <!-- Â∑¶‰æßÈü≥Ëâ≤ÈÄâÊã©Âô® -->
            <aside class="sidebar" id="voiceSidebar">
                <div class="sidebar-header">
                    <h2 class="sidebar-title">Èü≥Ëâ≤ÈÄâÊã©</h2>
                    <span class="multi-count" id="multiCount">Â∑≤ÈÄâ 0 ‰∏™</span>
                    <input type="text" class="voice-search" id="voiceSearch" placeholder="ÊêúÁ¥¢Èü≥Ëâ≤...">
                </div>
                <div class="voice-list" id="voiceList">
                    <!-- Èü≥Ëâ≤ÂàóË°®Â∞ÜÈÄöËøá JS Âä®ÊÄÅÁîüÊàê -->
                </div>
            </aside>
            
            <!-- ‰∏≠Â§ÆÂ∑•‰ΩúÂå∫ -->
            <section class="workspace">
                <div class="workspace-card">
                    <h2 class="card-title">ÊñáÊú¨ËæìÂÖ•</h2>
                    <div class="textarea-container">
                        <textarea 
                            class="text-input" 
                            id="textInput" 
                            placeholder="Âú®Ê≠§ËæìÂÖ•Ë¶ÅËΩ¨Êç¢ÁöÑÊñáÊú¨...&#10;&#10;üí° ÊèêÁ§∫ÔºöÂèØ‰ΩøÁî®ÊéßÂà∂ËØ≠Âè•ÔºåÂ¶ÇÔºö&#10;Say slowly and dramatically: ËøôÊòØ‰∏Ä‰∏™ÊàèÂâßÊÄßÁöÑÂè•Â≠ê„ÄÇ&#10;Say excitedly: Â§™Ê£í‰∫ÜÔºÅ"
                        ></textarea>
                        <div class="text-meta">
                            <span id="charCount">0 Â≠óÁ¨¶</span>
                            <span id="estimatedTime"></span>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-primary" id="generateBtn">
                            <span id="generateBtnText">ÁîüÊàêËØ≠Èü≥</span>
                        </button>
                        <button class="btn btn-secondary" id="multiVoiceBtn">üé≠ Â§öÈü≥Ëâ≤ÂØπÊØî</button>
                        <button class="btn btn-secondary" id="saveToFavorites">‰øùÂ≠òÂà∞Êî∂Ëóè</button>
                    </div>
                </div>
                
                <div class="workspace-card">
                    <h2 class="card-title">üí° ‰ΩøÁî®ÊäÄÂ∑ß</h2>
                    <ul style="list-style-position: inside; color: var(--text-secondary); line-height: 1.8;">
                        <li><strong>ÈÄüÂ∫¶Ôºö</strong>‰ΩøÁî® "Say quickly:" Êàñ "Say slowly:" ÊéßÂà∂ËØ≠ÈÄü</li>
                        <li><strong>ËØ≠Ê∞îÔºö</strong>Â¶Ç "Say cheerfully:", "Say in a whisper:", "Say dramatically:"</li>
                        <li><strong>ÊÉÖÊÑüÔºö</strong>Â¶Ç "Say excitedly:", "Say calmly:", "Say mysteriously:"</li>
                        <li><strong>Âø´Êç∑ÈîÆÔºö</strong>Ctrl/Cmd + Enter ÁîüÊàêÔºåSpace Êí≠Êîæ/ÊöÇÂÅúÔºå‚Üê ‚Üí ÂàáÊç¢Èü≥Ëâ≤Ôºåüí° Êü•ÁúãÂÆåÊï¥Âø´Êç∑ÈîÆ</li>
                        <li><strong>Â§öÈü≥Ëâ≤ÂØπÊØîÔºö</strong>ÁÇπÂáª"üé≠ Â§öÈü≥Ëâ≤ÂØπÊØî"ÔºåÂãæÈÄâ2‰∏™‰ª•‰∏äÈü≥Ëâ≤ÊâπÈáèÁîüÊàêÂØπÊØî</li>
                        <li><strong>Êí≠ÊîæÂô®Ôºö</strong>È°µÈù¢Â∫ïÈÉ®Êí≠ÊîæÂô®ÂßãÁªàÂèØËßÅÔºåÊîØÊåÅÊ≥¢ÂΩ¢ÂèØËßÜÂåñÂíåÂÆåÊï¥Êí≠ÊîæÂàóË°®ÊéßÂà∂</li>
                        <li><strong>ÂÜÖÂ≠òÁÆ°ÁêÜÔºö</strong>ÂÖ≥Èó≠È°µÈù¢Ëá™Âä®Ê∏ÖÁêÜÔºåÊàñÂú®ËÆæÁΩÆ‰∏≠ÊâãÂä®Ê∏ÖÁêÜÁºìÂ≠ò</li>
                    </ul>
                </div>
            </section>
            
            <!-- Âè≥‰æßÂéÜÂè≤Èù¢Êùø -->
            <aside class="history-panel" id="historyPanel">
                <div class="panel-header">
                    <h2 class="panel-title">ÂéÜÂè≤‰∏éÊî∂Ëóè</h2>
                    <button class="chip-btn" id="toggleDeletedBtn" title="ÊòæÁ§∫/ÈöêËóèÂ∑≤Âà†Èô§">üóë ÊòæÁ§∫Â∑≤Âà†Èô§</button>
                    <button class="icon-btn" id="toggleHistory" title="Êî∂Ëµ∑">‚úï</button>
            </div>
                <div class="panel-tabs">
                    <button class="tab active" data-tab="history">ÂéÜÂè≤</button>
                    <button class="tab" data-tab="favorites">Êî∂Ëóè</button>
        </div>
                <div class="panel-content" id="historyContent">
                    <!-- ÂéÜÂè≤ËÆ∞ÂΩïÂ∞ÜÈÄöËøá JS Âä®ÊÄÅÁîüÊàê -->
                </div>
                <div class="panel-content hidden" id="favoritesContent">
                    <!-- Êî∂ËóèËÆ∞ÂΩïÂ∞ÜÈÄöËøá JS Âä®ÊÄÅÁîüÊàê -->
                </div>
            </aside>
        </main>
        
        <!-- Èü≥È¢ëÊí≠ÊîæÂô® -->
        <div class="audio-player" id="audioPlayer">
            <!-- Á©∫Áä∂ÊÄÅÊèêÁ§∫ -->
            <div class="player-empty-state" id="playerEmptyState">
                <span>üéôÔ∏è</span>
                <span>ÊöÇÊó†Èü≥È¢ëÔºåËæìÂÖ•ÊñáÊú¨ÂêéÁÇπÂáª"ÁîüÊàêËØ≠Èü≥"ÂºÄÂßã‰ΩøÁî®</span>
            </div>
            
            <!-- ÂØπÊØîÊí≠ÊîæÂàóË°®ÔºàÈõÜÊàêÂú®Êí≠ÊîæÂô®ÂÜÖÔºâ -->
            <div class="compare-playlist" id="comparePlaylist">
                <div class="compare-playlist-header">
                    <div class="compare-playlist-title">
                        <span>üé≠ Èü≥Ëâ≤ÂØπÊØî</span>
                        <span id="comparePosition" style="font-size: 0.75rem; color: var(--text-secondary); font-weight: 400;"></span>
                    </div>
                    <div class="compare-playlist-controls">
                        <button class="icon-control" id="playModeBtnCompare" title="Êí≠ÊîæÊ®°ÂºèÔºöÈ°∫Â∫è" onclick="togglePlayMode()" style="font-size: 0.85rem; width: 28px; height: 28px;">‚ñ∂Ô∏è</button>
                        <button class="icon-control" id="prevCompareBtn" title="‰∏ä‰∏Ä‰∏™" onclick="playPrevCompare()" style="font-size: 0.85rem; width: 28px; height: 28px;">‚èÆ</button>
                        <button class="icon-control" id="nextCompareBtn" title="‰∏ã‰∏Ä‰∏™" onclick="playNextCompare()" style="font-size: 0.85rem; width: 28px; height: 28px;">‚è≠</button>
                        <button class="btn-small" id="downloadAllCompare" style="font-size: 0.7rem; padding: 0.3rem 0.6rem;">üì¶ ÂÖ®ÈÉ®</button>
                        <button class="icon-control" onclick="closeComparePlaylist()" style="font-size: 0.85rem; width: 28px; height: 28px;">‚úï</button>
                    </div>
                </div>
                <div class="compare-list" id="compareList">
                    <!-- ÂØπÊØîÁªìÊûúÂ∞ÜÂä®ÊÄÅÁîüÊàê -->
                </div>
            </div>
            
            <div class="player-controls">
                <button class="play-btn" id="playBtn">‚ñ∂</button>
                <div class="time-label" id="currentTime">0:00</div>
                <div class="progress-container">
                    <div class="waveform-wrapper">
                        <canvas class="waveform-canvas" id="waveformCanvas"></canvas>
                        <div class="wave-tooltip" id="waveTooltip"></div>
                    </div>
                </div>
                <div class="time-label" id="totalTime">0:00</div>
                <div class="player-extra">
                    <button class="icon-control" id="volumeBtn" title="Èü≥Èáè">üîâ</button>
                    <input type="range" class="slider" id="volumeSlider" min="0" max="100" value="100">
                    <div class="speed-group">
                        <button class="icon-control" id="speedBtn" title="ÂÄçÈÄü">‚ö°</button>
                        <div class="speed-menu" id="speedMenu">
                            <button class="speed-item" data-speed="0.5">0.5x</button>
                            <button class="speed-item" data-speed="0.75">0.75x</button>
                            <button class="speed-item" data-speed="1">1.0x</button>
                            <button class="speed-item" data-speed="1.25">1.25x</button>
                            <button class="speed-item" data-speed="1.5">1.5x</button>
                            <button class="speed-item" data-speed="2">2.0x</button>
                        </div>
                    </div>
                    <button class="icon-control" id="loopBtn" title="Âæ™ÁéØÔºöÂÖ≥">üîÅ</button>
                    <button class="icon-control" id="downloadBtn" title="‰∏ãËΩΩ">‚¨áÔ∏è</button>
                </div>
            </div>
            <audio id="audioElement" style="display: none;"></audio>
        </div>
    
    <!-- Toast ÂÆπÂô® -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- ËÆæÁΩÆ Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <span>ËÆæÁΩÆ</span>
                <button class="modal-close" onclick="document.getElementById('settingsModal').classList.remove('active')">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">API Âü∫Á°ÄÂú∞ÂùÄ</label>
                    <input type="text" class="form-input" id="apiBaseUrl" value="https://generativelanguage.googleapis.com/v1beta">
                </div>
                <div class="form-group">
                    <label class="form-label">API ÂØÜÈí•</label>
                    <input type="password" class="form-input" id="apiKey" placeholder="ËæìÂÖ•ÊÇ®ÁöÑ Gemini API Key">
                </div>
                <div class="form-group">
                    <label class="form-label">Ê®°ÂûãÈÄâÊã©</label>
                    <select class="form-input" id="modelSelect">
                        <option value="gemini-2.5-flash-preview-tts">Gemini 2.5 Flash TTS (Âø´ÈÄü)</option>
                        <option value="gemini-2.5-pro-preview-tts">Gemini 2.5 Pro TTS (È´òË¥®Èáè)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">ÂÜÖÂ≠òÁÆ°ÁêÜ</label>
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem; padding: 0.5rem; background: rgba(212, 117, 78, 0.1); border-radius: 8px;">
                        üìä ÂΩìÂâçÁºìÂ≠òÔºö<span id="cacheStatus">0 ‰∏™Èü≥È¢ë</span>
                    </div>
                    <button class="btn btn-secondary" style="width: 100%;" id="clearCacheBtn">üóëÔ∏è Ê∏ÖÁêÜÈü≥È¢ëÁºìÂ≠ò</button>
                    <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.5rem;">
                        Ê∏ÖÁêÜÂΩìÂâçÁîüÊàêÁöÑÊâÄÊúâÈü≥È¢ëÔºåÈáäÊîæÂÜÖÂ≠ò
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancelSettings">ÂèñÊ∂à</button>
                <button class="btn btn-primary" id="saveSettings">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>
    
    <!-- Êî∂Ëóè‰øùÂ≠ò Modal -->
    <div class="modal-overlay" id="saveFavoriteModal">
        <div class="modal">
            <div class="modal-header">
                <span>‰øùÂ≠òÂà∞Êî∂Ëóè</span>
                <button class="modal-close" onclick="document.getElementById('saveFavoriteModal').classList.remove('active')">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Êî∂ËóèÂêçÁß∞</label>
                    <input type="text" class="form-input" id="favoriteName" placeholder="‰∏∫Ëøô‰∏™ÈÖçÁΩÆÂëΩÂêç...">
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancelFavorite">ÂèñÊ∂à</button>
                <button class="btn btn-primary" id="confirmFavorite">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>
    
    <!-- Â∏ÆÂä© Modal -->
    <div class="modal-overlay" id="helpModal">
        <div class="modal">
            <div class="modal-header">
                <span>‚å®Ô∏è Âø´Êç∑ÈîÆ</span>
                <button class="modal-close" onclick="document.getElementById('helpModal').classList.remove('active')">‚úï</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; gap: 0.75rem; line-height: 1.6;">
                    <div style="font-weight: 600; color: var(--primary-terracotta); margin-top: 0.5rem;">‚å®Ô∏è Âü∫Á°ÄÊìç‰Ωú</div>
                    <div><strong>Ctrl/Cmd + Enter</strong> - ÁîüÊàêËØ≠Èü≥</div>
                    <div><strong>Space</strong> - Êí≠Êîæ/ÊöÇÂÅú</div>
                    <div><strong>Ctrl/Cmd + S</strong> - ‰øùÂ≠òÂà∞Êî∂Ëóè</div>
                    <div><strong>Ctrl/Cmd + K</strong> - ÊêúÁ¥¢Èü≥Ëâ≤</div>
                    
                    <div style="font-weight: 600; color: var(--primary-terracotta); margin-top: 0.5rem;">üéµ Êí≠ÊîæÂàóË°®ÊéßÂà∂</div>
                    <div><strong>‚Üê Â∑¶ÁÆ≠Â§¥</strong> - Êí≠Êîæ‰∏ä‰∏Ä‰∏™Èü≥Ëâ≤ÔºàËá™Âä®Âæ™ÁéØÔºâ</div>
                    <div><strong>‚Üí Âè≥ÁÆ≠Â§¥</strong> - Êí≠Êîæ‰∏ã‰∏Ä‰∏™Èü≥Ëâ≤ÔºàËá™Âä®Âæ™ÁéØÔºâ</div>
                    <div><strong>L</strong> - ÂàáÊç¢Êí≠ÊîæÊ®°ÂºèÔºà‚ñ∂Ô∏èÈ°∫Â∫è / üîÅÂæ™ÁéØ / üîÄÈöèÊú∫Ôºâ</div>
                    <div><strong>ÁÇπÂáªÂç°Áâá</strong> - Áõ¥Êé•Êí≠ÊîæËØ•Èü≥Ëâ≤</div>
                    <div><strong>hoverÂç°Áâá ‚Üí ‚¨á</strong> - Âø´ÈÄü‰∏ãËΩΩÂçï‰∏™Èü≥Ëâ≤</div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.3rem;">
                        üí° Êí≠ÊîæÊ®°ÂºèÔºöÈ°∫Â∫èÊ®°ÂºèÊí≠ÊîæÂÆåÂÅúÊ≠¢ÔºåÂæ™ÁéØÊ®°ÂºèËá™Âä®ÈáçÂ§çÔºåÈöèÊú∫Ê®°ÂºèÈöèÊú∫ÈÄâÊã©
                    </div>
                    
                    <div style="font-weight: 600; color: var(--primary-terracotta); margin-top: 0.5rem;">üé≠ È´òÁ∫ßÂäüËÉΩ</div>
                    <div><strong>ÁÇπÂáªÊ≥¢ÂΩ¢</strong> - Âø´ÈÄüË∑≥ËΩ¨Êí≠Êîæ‰ΩçÁΩÆ</div>
                    <div><strong>ÊãñÂä®Ê≥¢ÂΩ¢</strong> - Á≤æÁ°ÆÂÆö‰ΩçÊó∂Èó¥ÁÇπ</div>
                    <div><strong>ÁÇπÂáª"üé≠ Â§öÈü≥Ëâ≤ÂØπÊØî"</strong> - ËøõÂÖ•Â§öÈÄâÊ®°ÂºèÔºåÂãæÈÄâÈü≥Ëâ≤ÊâπÈáèÁîüÊàê</div>
                    
                    <div style="font-weight: 600; color: var(--primary-terracotta); margin-top: 0.5rem;">‚öôÔ∏è ÁïåÈù¢ÊéßÂà∂</div>
                    <div><strong>Esc</strong> - ÂÖ≥Èó≠ÂºπÁ™ó/ËèúÂçï</div>
                    <div><strong>Â∑¶‰∏äËßí ‚ò∞</strong> - ÊòæÁ§∫/ÈöêËóèÈü≥Ëâ≤Èù¢Êùø</div>
                    <div><strong>Âè≥‰∏äËßí üìú ÂéÜÂè≤</strong> - ÊòæÁ§∫/ÈöêËóèÂéÜÂè≤Èù¢Êùø</div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" id="closeHelp">Áü•ÈÅì‰∫Ü</button>
            </div>
        </div>
    </div>

    <script>
        // ========== Èü≥Ëâ≤Êï∞ÊçÆÂ∫ì ==========
        const VOICE_DATABASE = {
            female: [
                { name: 'Leda', trait: 'Youthful', age: '20-30Â≤Å', desc: 'Ê¥ªÊ≥ºÂ∞ëÂ•≥Èü≥' },
                { name: 'Aoede', trait: 'Breezy', age: '20-30Â≤Å', desc: 'ËΩªÂø´Â•≥Â£∞' },
                { name: 'Despina', trait: 'Smooth', age: '20-30Â≤Å', desc: 'Ê∏©ÊüîÂ•≥Â£∞' },
                { name: 'Kore', trait: 'Firm', age: '30-45Â≤Å', desc: 'ÂùöÂÆöÂ•≥Â£∞' },
                { name: 'Callirrhoe', trait: 'Easy-going', age: '30-45Â≤Å', desc: 'ÈöèÂíåÂ•≥Â£∞' },
                { name: 'Autonoe', trait: 'Bright', age: '30-45Â≤Å', desc: 'Êòé‰∫ÆÂ•≥Â£∞' },
                { name: 'Erinome', trait: 'Clear', age: '30-45Â≤Å', desc: 'Ê∏ÖÊô∞Â•≥Â£∞' },
                { name: 'Vindemiatrix', trait: 'Gentle', age: '30-45Â≤Å', desc: 'Ê∏©ÊüîÊàêÁÜüÂ•≥Â£∞' },
                { name: 'Pulcherrima', trait: 'Forward', age: '35-50Â≤Å', desc: 'Ëá™‰ø°Â•≥Â£∞' },
                { name: 'Laomedeia', trait: 'Upbeat', age: '35-50Â≤Å', desc: 'ÁßØÊûÅÂ•≥Â£∞' }
            ],
            male: [
                { name: 'Puck', trait: 'Upbeat', age: '20-30Â≤Å', desc: 'Ê¥ªÂäõÁî∑Â£∞' },
                { name: 'Fenrir', trait: 'Excitable', age: '20-30Â≤Å', desc: 'ÊøÄÊÉÖÁî∑Â£∞' },
                { name: 'Zephyr', trait: 'Bright', age: '20-30Â≤Å', desc: 'Êòé‰∫ÆÁî∑Â£∞' },
                { name: 'Charon', trait: 'Informative', age: '30-45Â≤Å', desc: 'Áü•ËØÜÂûãÁî∑Â£∞' },
                { name: 'Orus', trait: 'Firm', age: '30-45Â≤Å', desc: 'ÂùöÂÆöÁî∑Â£∞' },
                { name: 'Enceladus', trait: 'Breathy', age: '30-45Â≤Å', desc: 'Á£ÅÊÄßÁî∑Â£∞' },
                { name: 'Iapetus', trait: 'Clear', age: '30-45Â≤Å', desc: 'Ê∏ÖÊô∞Áî∑Â£∞' },
                { name: 'Umbriel', trait: 'Easy-going', age: '30-45Â≤Å', desc: 'ÈöèÂíåÁî∑Â£∞' },
                { name: 'Rasalgethi', trait: 'Informative', age: '40-60Â≤Å', desc: 'Êí≠Èü≥ÂëòÁî∑Â£∞' },
                { name: 'Alnilam', trait: 'Firm', age: '40-60Â≤Å', desc: 'Â®Å‰∏•Áî∑Â£∞' },
                { name: 'Gacrux', trait: 'Mature', age: '40-60Â≤Å', desc: 'ÊàêÁÜüÁî∑Â£∞' },
                { name: 'Algenib', trait: 'Gravelly', age: '40-60Â≤Å', desc: 'Ê≤ôÂìëÁî∑Â£∞' }
            ],
            neutral: [
                { name: 'Algieba', trait: 'Smooth', age: 'ÈÄöÁî®', desc: 'ÊüîÂíå‰∏≠ÊÄßÈü≥' },
                { name: 'Achernar', trait: 'Soft', age: 'ÈÄöÁî®', desc: 'Ê∏©Êüî‰∏≠ÊÄßÈü≥' },
                { name: 'Schedar', trait: 'Even', age: 'ÈÄöÁî®', desc: 'Âπ≥Á®≥‰∏≠ÊÄßÈü≥' },
                { name: 'Achird', trait: 'Friendly', age: 'ÈÄöÁî®', desc: 'ÂèãÂ•Ω‰∏≠ÊÄßÈü≥' },
                { name: 'Zubenelgenubi', trait: 'Casual', age: 'ÈÄöÁî®', desc: '‰ºëÈó≤‰∏≠ÊÄßÈü≥' },
                { name: 'Sadachbia', trait: 'Lively', age: 'ÈÄöÁî®', desc: 'Ê¥ªÊ≥º‰∏≠ÊÄßÈü≥' },
                { name: 'Sadaltager', trait: 'Knowledgeable', age: 'ÈÄöÁî®', desc: 'Áü•ËØÜÂûã‰∏≠ÊÄßÈü≥' },
                { name: 'Sulafat', trait: 'Warm', age: 'ÈÄöÁî®', desc: 'Ê∏©Êöñ‰∏≠ÊÄßÈü≥' }
            ]
        };
        
        // ========== Áä∂ÊÄÅÁÆ°ÁêÜ ==========
        const state = {
            selectedVoice: 'Puck',
            theme: localStorage.getItem('theme') || 'light',
            apiKey: localStorage.getItem('apiKey') || '',
            apiBaseUrl: localStorage.getItem('apiBaseUrl') || 'https://generativelanguage.googleapis.com/v1beta',
            model: localStorage.getItem('model') || 'gemini-2.5-flash-preview-tts',
            currentAudio: null,
            isPlaying: false,
            history: JSON.parse(localStorage.getItem('history') || '[]'),
            favorites: JSON.parse(localStorage.getItem('favorites') || '[]'),
            deletedHistory: JSON.parse(localStorage.getItem('deletedHistory') || '[]'),
            showDeleted: (localStorage.getItem('showDeleted') || 'false') === 'true',
            waveformBins: null,
            multiSelectMode: false,
            selectedVoices: new Set(),
            compareResults: [],
            // Êí≠ÊîæÂàóË°®Áä∂ÊÄÅ
            currentCompareIndex: -1,
            playMode: 'order', // 'order', 'loop', 'random'
            comparePanelCollapsed: true,
            // ÊèêÈÜíÁä∂ÊÄÅ
            singleVoiceWarned: false,
            multiVoiceWarned: false
        };

        // Êí§ÈîÄÂà†Èô§ÊâÄÈúÄ
        let lastDeletedHistoryItem = null;
        
        // ËØïÂê¨Èü≥Ëâ≤ÊâÄÈúÄ
        let previewAudioUrl = null;
        let previewAudioEl = null;
        
        // ========== Èü≥È¢ëÂèØËßÜÂåñÂÖ®Â±Ä ==========
        let audioCtx = null;
        let analyser = null;
        let sourceNode = null;
        let dataArray = null;
        let rafId = null;
        let isScrubbing = false;
        let wasPlayingBeforeScrub = false;

        // ========== ÂàùÂßãÂåñ ==========
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            initVoiceList();
            initEventListeners();
            initKeyboardShortcuts();
            loadSettings();
            renderHistory();
            renderFavorites();
            
            // ÂàùÂßãÂåñÊí≠ÊîæÊ®°ÂºèÊåâÈíÆ
            const playModeBtn = document.getElementById('playModeBtnCompare');
            if (playModeBtn) {
                playModeBtn.textContent = '‚ñ∂Ô∏è';
                playModeBtn.title = 'Êí≠ÊîæÊ®°ÂºèÔºöÈ°∫Â∫èÊí≠ÊîæÔºàÊí≠ÊîæÂÆåÂÅúÊ≠¢Ôºâ';
            }
            
            // È¶ñÊ¨°ËÆøÈóÆÊèêÁ§∫
            if (!localStorage.getItem('visited')) {
                setTimeout(() => showToast('üëã Ê¨¢Ëøé‰ΩøÁî®ÔºÅÊåâ Ctrl+Enter Âø´ÈÄüÁîüÊàêÔºåÁÇπÂáª üí° Êü•ÁúãÊõ¥Â§öÂø´Êç∑ÈîÆ', 'success'), 500);
                localStorage.setItem('visited', 'true');
            }
            updateDeletedToggleBtn();
            // ÊÅ¢Â§çÂéÜÂè≤Èù¢ÊùøÊäòÂè†Áä∂ÊÄÅ
            const savedCollapsed = (localStorage.getItem('historyPanelCollapsed') || 'false') === 'true';
            setHistoryCollapsed(savedCollapsed);
            // ÊÅ¢Â§ç‰æßËæπÊ†èÊäòÂè†Áä∂ÊÄÅ
            const sidebarCollapsed = (localStorage.getItem('sidebarCollapsed') || 'false') === 'true';
            setSidebarCollapsed(sidebarCollapsed);
            if (state.showDeleted) renderDeleted();
            updateHistoryToggleBtnVisual();
            updateSidebarToggleBtnVisual();
            updateCompareToggleBtn();
        });
        
        // ========== ‰∏ªÈ¢òÂàáÊç¢ ==========
        function initTheme() {
            document.documentElement.setAttribute('data-theme', state.theme);
        }
        
        function toggleTheme() {
            state.theme = state.theme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', state.theme);
            localStorage.setItem('theme', state.theme);
        }
        
        // ========== Èü≥Ëâ≤ÂàóË°®ÂàùÂßãÂåñ ==========
        function initVoiceList() {
            const voiceList = document.getElementById('voiceList');
            const categories = {
                female: { title: 'Â•≥ÊÄßÈü≥Ëâ≤', icon: 'üë©‚Äçüé§' },
                male: { title: 'Áî∑ÊÄßÈü≥Ëâ≤', icon: 'üë®‚Äçüé§' },
                neutral: { title: '‰∏≠ÊÄßÈü≥Ëâ≤', icon: 'üßë‚Äçüé§' }
            };
            
            Object.entries(categories).forEach(([key, {title, icon}]) => {
                const category = document.createElement('div');
                category.className = 'voice-category';
                category.innerHTML = `
                    <div class="category-header" data-category="${key}">
                        <span>${icon} ${title}</span>
                        <span class="category-arrow">‚ñº</span>
                    </div>
                    <div class="category-content active">
                        ${VOICE_DATABASE[key].map(voice => `
                            <div class="voice-item ${voice.name === state.selectedVoice ? 'selected' : ''}" data-voice="${voice.name}">
                                <input type="checkbox" class="voice-checkbox" data-voice="${voice.name}">
                                <div class="voice-item-name">
                                    <span class="voice-icon">${icon}</span>
                                    <span>${getVoiceEmoji(voice.trait)} ${voice.name}</span>
                                </div>
                                <div class="voice-item-meta">
                                    <div class="meta-left">
                                        <span class="voice-tag">${voice.age}</span>
                                        <span class="voice-tag">${voice.trait}</span>
                                        <span class="voice-tag">${voice.desc}</span>
                                    </div>
                                    <button class="preview-inline" data-voice="${voice.name}">üîä ËØïÂê¨</button>
                                </div>
                                <button class="favorite-btn ${isFavoriteVoice(voice.name) ? 'active' : ''}" data-voice="${voice.name}">
                                    ${isFavoriteVoice(voice.name) ? '‚òÖ' : '‚òÜ'}
                                </button>
                            </div>
                        `).join('')}
                    </div>
                `;
                voiceList.appendChild(category);
            });
            
            // ÂàÜÁ±ªÊäòÂè†ÂäüËÉΩ
            document.querySelectorAll('.category-header').forEach(header => {
                header.addEventListener('click', () => {
                    const content = header.nextElementSibling;
                    const isActive = content.classList.contains('active');
                    
                    // ÂàáÊç¢ÂÜÖÂÆπÊòæÁ§∫
                    content.classList.toggle('active');
                    
                    // ÂàáÊç¢ÁÆ≠Â§¥ÊñπÂêë
                    header.classList.toggle('collapsed', isActive);
                });
            });
            
            // Èü≥Ëâ≤ÈÄâÊã©
            document.querySelectorAll('.voice-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÊåâÈíÆÔºå‰∏çÂ§ÑÁêÜ
                    if (e.target.classList.contains('favorite-btn') || 
                        e.target.classList.contains('preview-inline') ||
                        e.target.classList.contains('voice-checkbox')) {
                        return;
                    }
                    
                    // Â§öÈÄâÊ®°ÂºèÔºöÂàáÊç¢Â§çÈÄâÊ°Ü
                    if (state.multiSelectMode) {
                        const checkbox = item.querySelector('.voice-checkbox');
                        if (checkbox) {
                            checkbox.checked = !checkbox.checked;
                            checkbox.dispatchEvent(new Event('change'));
                        }
                    } else {
                        // ÂçïÈÄâÊ®°ÂºèÔºöÈÄâÊã©Èü≥Ëâ≤
                        selectVoice(item.dataset.voice);
                    }
                });
            });
            
            // Êî∂ËóèÈü≥Ëâ≤
            document.querySelectorAll('.favorite-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleFavoriteVoice(btn.dataset.voice);
                });
            });

            // ËØïÂê¨Èü≥Ëâ≤ÔºàÂÜÖËÅîÊåâÈíÆÔºâ
            document.querySelectorAll('.preview-inline').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    previewVoice(btn.dataset.voice);
                });
            });
            
            // Â§çÈÄâÊ°ÜÂ§ÑÁêÜ
            document.querySelectorAll('.voice-checkbox').forEach(cb => {
                cb.addEventListener('change', (e) => {
                    e.stopPropagation();
                    const voice = cb.dataset.voice;
                    if (cb.checked) {
                        state.selectedVoices.add(voice);
                    } else {
                        state.selectedVoices.delete(voice);
                    }
                    state.multiVoiceWarned = false; // ÈáçÁΩÆË≠¶ÂëäÁä∂ÊÄÅ
                    updateMultiCount();
                });
            });
        }
        
        function updateMultiCount() {
            const count = state.selectedVoices.size;
            const el = document.getElementById('multiCount');
            if (el) el.textContent = `Â∑≤ÈÄâ ${count} ‰∏™`;
        }
        
        function selectVoice(voiceName) {
            document.querySelectorAll('.voice-item').forEach(item => {
                item.classList.remove('selected');
            });
            document.querySelector(`[data-voice="${voiceName}"]`).classList.add('selected');
            state.selectedVoice = voiceName;
            state.singleVoiceWarned = false; // ÈáçÁΩÆË≠¶ÂëäÁä∂ÊÄÅ
            showToast(`Â∑≤ÈÄâÊã©Èü≥Ëâ≤Ôºö${voiceName}`, 'success');
        }

        function getVoiceEmoji(trait) {
            const map = {
                'Bright': '‚ú®',
                'Upbeat': 'üéµ',
                'Informative': 'üß†',
                'Firm': 'üß±',
                'Excitable': 'üî•',
                'Youthful': 'üê£',
                'Breezy': 'üå¨Ô∏è',
                'Easy-going': 'üòå',
                'Breathy': 'üòÆ\u200düí®',
                'Clear': 'üîä',
                'Smooth': 'üé∑',
                'Gravelly': 'ü™®',
                'Mature': 'üé©',
                'Soft': '‚òÅÔ∏è',
                'Even': 'üìè',
                'Friendly': 'ü§ó',
                'Casual': 'üß¢',
                'Gentle': 'üçÉ',
                'Lively': '‚ö°',
                'Knowledgeable': 'üìö',
                'Warm': 'üîÜ'
            };
            return map[trait] || 'üéôÔ∏è';
        }
        
        function isFavoriteVoice(voiceName) {
            return state.favorites.some(fav => fav.voice === voiceName);
        }
        
        function toggleFavoriteVoice(voiceName) {
            const btn = document.querySelector(`.favorite-btn[data-voice="${voiceName}"]`);
            const isFav = btn.classList.contains('active');
            
            if (isFav) {
                btn.classList.remove('active');
                btn.textContent = '‚òÜ';
            } else {
                btn.classList.add('active');
                btn.textContent = '‚òÖ';
            }
        }
        
        // ========== ÊêúÁ¥¢ÂäüËÉΩ ==========
        document.getElementById('voiceSearch').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            document.querySelectorAll('.voice-item').forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(query) ? 'block' : 'none';
            });
        });
        
        // ========== ‰∫ã‰ª∂ÁõëÂê¨ ==========
        function initEventListeners() {
            // ‰∏ªÈ¢òÂàáÊç¢
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            
            // ‰æßËæπÊ†èÂàáÊç¢ÔºàÂÖ®Â±ÄÊåâÈíÆÔºâ
            document.getElementById('toggleSidebar').addEventListener('click', () => {
                const sidebar = document.querySelector('.sidebar');
                const collapsed = sidebar.classList.contains('collapsed');
                setSidebarCollapsed(!collapsed);
            });
            
            // ÂéÜÂè≤Èù¢ÊùøÂàáÊç¢ÔºàÈù¢ÊùøÂÜÖÂÖ≥Èó≠ÊåâÈíÆ -> ÊäòÂè†Ôºâ
            document.getElementById('toggleHistory').addEventListener('click', () => {
                setHistoryCollapsed(true);
            });

            // È°∂ÈÉ®ÂéÜÂè≤ÊåâÈíÆÔºàÊòæÁ§∫/ÈöêËóèÔºâ
            document.getElementById('historyToggleGlobal').addEventListener('click', () => {
                const panel = document.getElementById('historyPanel');
                const next = panel.classList.contains('collapsed') ? false : true;
                setHistoryCollapsed(next);
            });
            
            // È°∂ÈÉ®ÂØπÊØîÂàóË°®ÊåâÈíÆ
            document.getElementById('compareToggleGlobal').addEventListener('click', () => {
                toggleComparePlaylist();
            });
            
            // ÊòæÁ§∫/ÈöêËóèÂ∑≤Âà†Èô§
            document.getElementById('toggleDeletedBtn').addEventListener('click', () => {
                state.showDeleted = !state.showDeleted;
                localStorage.setItem('showDeleted', state.showDeleted);
                updateDeletedToggleBtn();
                const activeTab = document.querySelector('.tab.active')?.dataset.tab;
                if (activeTab === 'history') {
                    if (state.showDeleted) renderDeleted(); else renderHistory();
                }
            });
            
            // ÁîüÊàêËØ≠Èü≥
            document.getElementById('generateBtn').addEventListener('click', generateSpeech);
            
            // Â§öÈü≥Ëâ≤ÂØπÊØî
            document.getElementById('multiVoiceBtn').addEventListener('click', () => {
                if (state.multiSelectMode) {
                    generateMultiVoiceCompare();
                } else {
                    toggleMultiVoiceMode();
                }
            });
            
            // ‰øùÂ≠òÂà∞Êî∂Ëóè
            document.getElementById('saveToFavorites').addEventListener('click', openSaveFavoriteModal);
            
            // ËÆæÁΩÆ
            document.getElementById('settingsBtn').addEventListener('click', () => {
                document.getElementById('settingsModal').classList.add('active');
                updateCacheStatus();
            });
            
            document.getElementById('cancelSettings').addEventListener('click', () => {
                document.getElementById('settingsModal').classList.remove('active');
            });
            
            document.getElementById('saveSettings').addEventListener('click', saveSettings);
            
            // Ê∏ÖÁêÜÁºìÂ≠ò
            document.getElementById('clearCacheBtn').addEventListener('click', () => {
                const audioCount = (state.currentAudio ? 1 : 0) + 
                                   (state.compareResults?.length || 0) + 
                                   (previewAudioUrl ? 1 : 0);
                
                if (audioCount === 0) {
                    showToast('ÂΩìÂâçÊ≤°ÊúâÈü≥È¢ëÁºìÂ≠ò', 'success');
                    return;
                }
                
                if (confirm(`Â∞ÜÊ∏ÖÁêÜ ${audioCount} ‰∏™Èü≥È¢ëÁºìÂ≠òÔºåÊòØÂê¶ÁªßÁª≠Ôºü`)) {
                    cleanupAudioResources();
                    const player = document.getElementById('audioPlayer');
                    const comparePlaylist = document.getElementById('comparePlaylist');
                    if (comparePlaylist) {
                        comparePlaylist.classList.remove('active');
                    }
                    if (player) {
                        player.classList.remove('has-playlist');
                    }
                    showToast(`Â∑≤Ê∏ÖÁêÜ ${audioCount} ‰∏™Èü≥È¢ëÁºìÂ≠ò`, 'success');
                }
            });
            
            // Â∏ÆÂä©
            document.getElementById('helpBtn').addEventListener('click', () => {
                document.getElementById('helpModal').classList.add('active');
            });
            
            document.getElementById('closeHelp').addEventListener('click', () => {
                document.getElementById('helpModal').classList.remove('active');
            });
            
            // Tab ÂàáÊç¢
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    const tabName = tab.dataset.tab;
                    document.getElementById('historyContent').classList.toggle('hidden', tabName !== 'history');
                    document.getElementById('favoritesContent').classList.toggle('hidden', tabName !== 'favorites');
                });
            });
            
            // Êí≠ÊîæÊéßÂà∂
            const playBtn = document.getElementById('playBtn');
            const audioElement = document.getElementById('audioElement');
            
            playBtn.addEventListener('click', togglePlay);
            
            audioElement.addEventListener('timeupdate', updateProgress);
            audioElement.addEventListener('ended', () => {
                state.isPlaying = false;
                playBtn.textContent = '‚ñ∂';
                // Ëá™Âä®Êí≠Êîæ‰∏ã‰∏Ä‰∏™ÔºàÂ¶ÇÊûúÂú®Êí≠ÊîæÂàóË°®‰∏≠Ôºâ
                handleAudioEnded();
            });
            audioElement.addEventListener('play', () => { startWaveformDraw(); });
            audioElement.addEventListener('pause', () => { stopWaveformDraw(); });
            
            // ËøõÂ∫¶Êù°Â∑≤ÁßªÈô§Ôºå‰ΩøÁî®Ê≥¢ÂΩ¢ËøõË°åÂØªÂùÄ
            
            // Ê≥¢ÂΩ¢‰∫§‰∫íÔºöÁÇπÂáª/ÊãñÊãΩÂØªÂùÄ + tooltip
            const waveformCanvas = document.getElementById('waveformCanvas');
            const waveTooltip = document.getElementById('waveTooltip');
            const getTimeFromX = (x) => {
                const rect = waveformCanvas.getBoundingClientRect();
                const ratio = Math.min(Math.max((x - rect.left) / rect.width, 0), 1);
                return ratio * (audioElement.duration || 0);
            };
            const setTooltip = (x) => {
                const t = getTimeFromX(x);
                const rect = waveformCanvas.getBoundingClientRect();
                waveTooltip.style.left = `${x - rect.left}px`;
                waveTooltip.textContent = formatTime(t);
            };
            waveformCanvas.addEventListener('mouseenter', () => {
                waveTooltip.style.opacity = '1';
            });
            waveformCanvas.addEventListener('mouseleave', () => {
                waveTooltip.style.opacity = '0';
                if (isScrubbing) {
                    isScrubbing = false;
                    if (wasPlayingBeforeScrub) audioElement.play();
                }
            });
            waveformCanvas.addEventListener('mousemove', (e) => {
                setTooltip(e.clientX);
                if (isScrubbing) {
                    audioElement.currentTime = getTimeFromX(e.clientX);
                }
            });
            const startScrub = (clientX) => {
                wasPlayingBeforeScrub = !audioElement.paused;
                if (wasPlayingBeforeScrub) audioElement.pause();
                isScrubbing = true;
                audioElement.currentTime = getTimeFromX(clientX);
            };
            waveformCanvas.addEventListener('mousedown', (e) => startScrub(e.clientX));
            window.addEventListener('mouseup', () => {
                if (isScrubbing) {
                    isScrubbing = false;
                    if (wasPlayingBeforeScrub) audioElement.play();
                }
            });
            // Ëß¶Êéß
            waveformCanvas.addEventListener('touchstart', (e) => {
                const touch = e.touches[0];
                startScrub(touch.clientX);
            }, { passive: true });
            waveformCanvas.addEventListener('touchmove', (e) => {
                const touch = e.touches[0];
                setTooltip(touch.clientX);
                if (isScrubbing) audioElement.currentTime = getTimeFromX(touch.clientX);
            }, { passive: true });
            window.addEventListener('touchend', () => {
                if (isScrubbing) {
                    isScrubbing = false;
                    if (wasPlayingBeforeScrub) audioElement.play();
                }
            });
            
            // Èü≥ÈáèÊéßÂà∂
            document.getElementById('volumeSlider').addEventListener('input', (e) => {
                audioElement.volume = e.target.value / 100;
            });
            
            // ÈÄüÂ∫¶ÊéßÂà∂Ôºà‰∏ãÊãâ + Èó™ÁîµÊåâÈíÆÂæ™ÁéØÔºâ
            const speedBtn = document.getElementById('speedBtn');
            const speedMenu = document.getElementById('speedMenu');
            const speedItems = () => Array.from(document.querySelectorAll('#speedMenu .speed-item'));
            const speeds = [0.5, 0.75, 1, 1.25, 1.5, 2];
            const applySpeed = (val) => {
                const v = parseFloat(val);
                audioElement.playbackRate = v;
                if (previewAudioEl) previewAudioEl.playbackRate = v;
                speedBtn.title = `ÂÄçÈÄüÔºö${v.toFixed(2).replace(/\.00$/, '')}x`;
                // È´ò‰∫ÆÂΩìÂâçÈÄâÈ°π
                speedItems().forEach(it => {
                    const m = parseFloat(it.getAttribute('data-speed'));
                    it.classList.toggle('active', m === v);
                });
            };
            // ÈªòËÆ§1x
            applySpeed(1);
            // ÊâìÂºÄ/ÂÖ≥Èó≠ËèúÂçï
            speedBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                speedMenu.classList.toggle('visible');
            });
            // ËèúÂçïÈ°π
            speedItems().forEach(item => {
                item.addEventListener('click', (e) => {
                    const s = e.currentTarget.getAttribute('data-speed');
                    applySpeed(s);
                    speedMenu.classList.remove('visible');
                });
            });
            // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠
            document.addEventListener('click', (e) => {
                if (!speedMenu.contains(e.target) && e.target !== speedBtn) {
                    speedMenu.classList.remove('visible');
                }
            });
            // EscÂÖ≥Èó≠
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') speedMenu.classList.remove('visible');
            });

            // Âæ™ÁéØÊéßÂà∂
            const loopBtn = document.getElementById('loopBtn');
            loopBtn.addEventListener('click', () => {
                audioElement.loop = !audioElement.loop;
                loopBtn.classList.toggle('active', audioElement.loop);
                loopBtn.title = audioElement.loop ? 'Âæ™ÁéØÔºöÂºÄ' : 'Âæ™ÁéØÔºöÂÖ≥';
            });
            
            // ‰∏ãËΩΩ
            document.getElementById('downloadBtn').addEventListener('click', downloadAudio);
            
            // ‰∏ãËΩΩÂÖ®ÈÉ®ÂØπÊØî
            document.getElementById('downloadAllCompare').addEventListener('click', downloadAllCompare);
            
            // Â≠óÁ¨¶ËÆ°Êï∞
            document.getElementById('textInput').addEventListener('input', updateCharCount);
            
            // Modal ÂÖ≥Èó≠
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        overlay.classList.remove('active');
                    }
                });
            });
            
            // Êî∂Ëóè Modal
            document.getElementById('cancelFavorite').addEventListener('click', () => {
                document.getElementById('saveFavoriteModal').classList.remove('active');
            });
            
            document.getElementById('confirmFavorite').addEventListener('click', saveFavorite);
        }

        function setSidebarCollapsed(collapsed) {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('collapsed', collapsed);
            localStorage.setItem('sidebarCollapsed', collapsed);
            updateSidebarToggleBtnVisual();
        }
        function updateSidebarToggleBtnVisual() {
            const btn = document.getElementById('toggleSidebar');
            const sidebar = document.querySelector('.sidebar');
            if (!btn || !sidebar) return;
            const collapsed = sidebar.classList.contains('collapsed');
            if (collapsed) { btn.classList.remove('active'); btn.title = 'ÊâìÂºÄÈü≥Ëâ≤ÈÄâÊã©Âô®'; }
            else { btn.classList.add('active'); btn.title = 'ÂÖ≥Èó≠Èü≥Ëâ≤ÈÄâÊã©Âô®'; }
        }

        function setHistoryCollapsed(collapsed) {
            const panel = document.getElementById('historyPanel');
            panel.classList.toggle('collapsed', collapsed);
            localStorage.setItem('historyPanelCollapsed', collapsed);
            updateHistoryToggleBtnVisual();
        }

        function updateHistoryToggleBtnVisual() {
            const btn = document.getElementById('historyToggleGlobal');
            const panel = document.getElementById('historyPanel');
            if (!btn || !panel) return;
            const collapsed = panel.classList.contains('collapsed');
            if (collapsed) {
                btn.classList.remove('active');
                btn.title = 'ÊâìÂºÄÂéÜÂè≤ËÆ∞ÂΩï';
                btn.textContent = 'üìú ÂéÜÂè≤';
                } else {
                btn.classList.add('active');
                btn.title = 'ÂÖ≥Èó≠ÂéÜÂè≤ËÆ∞ÂΩï';
                btn.textContent = 'üìÅ Êî∂Ëµ∑';
            }
        }
        
        function updateDeletedToggleBtn() {
            const btn = document.getElementById('toggleDeletedBtn');
            if (!btn) return;
            if (state.showDeleted) {
                btn.classList.add('active');
                btn.textContent = 'üóÇ ÈöêËóèÂ∑≤Âà†Èô§';
                btn.title = 'ÈöêËóèÂ∑≤Âà†Èô§ËÆ∞ÂΩï';
            } else {
                btn.classList.remove('active');
                btn.textContent = 'üóë ÊòæÁ§∫Â∑≤Âà†Èô§';
                btn.title = 'ÊòæÁ§∫Â∑≤Âà†Èô§ËÆ∞ÂΩï';
            }
        }
        
        // ========== Âø´Êç∑ÈîÆ ==========
        function initKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ctrl/Cmd + Enter: ÁîüÊàê
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    generateSpeech();
                }
                
                // Space: Êí≠Êîæ/ÊöÇÂÅúÔºàÊéíÈô§ËæìÂÖ•Ê°ÜÂíåÊêúÁ¥¢Ê°ÜÔºâ
                if (e.key === ' ' && !e.target.matches('input, textarea, [contenteditable="true"]')) {
                    e.preventDefault();
                    if (state.currentAudio || state.compareResults.length > 0) {
                        togglePlay();
                    }
                }
                
                // Ctrl/Cmd + S: ‰øùÂ≠òÂà∞Êî∂Ëóè
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    openSaveFavoriteModal();
                }
                
                // Ctrl/Cmd + K: ÊêúÁ¥¢Èü≥Ëâ≤
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    document.getElementById('voiceSearch').focus();
                }
                
                // Â∑¶ÁÆ≠Â§¥: ‰∏ä‰∏Ä‰∏™ÔºàÊí≠ÊîæÂàóË°®Ôºâ
                if (e.key === 'ArrowLeft' && !e.target.matches('input, textarea')) {
                    e.preventDefault();
                    if (state.compareResults.length > 0) {
                        playPrevCompare();
                    }
                }
                
                // Âè≥ÁÆ≠Â§¥: ‰∏ã‰∏Ä‰∏™ÔºàÊí≠ÊîæÂàóË°®Ôºâ
                if (e.key === 'ArrowRight' && !e.target.matches('input, textarea')) {
                    e.preventDefault();
                    if (state.compareResults.length > 0) {
                        playNextCompare();
                    }
                }
                
                // L: ÂàáÊç¢Âæ™ÁéØÊ®°Âºè
                if (e.key === 'l' && !e.target.matches('input, textarea')) {
                    if (state.compareResults.length > 0) {
                        togglePlayMode();
                    }
                }
                
                // Esc: ÂÖ≥Èó≠ÂºπÁ™ó
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
                }
            });
        }
        
        // ========== TTS ÁîüÊàê ==========
        async function generateSpeech() {
            const text = document.getElementById('textInput').value.trim();
            
            if (!text) {
                showToast('ËØ∑ËæìÂÖ•ÊñáÊú¨', 'error');
                return;
            }

            if (!state.apiKey) {
                showToast('ËØ∑ÂÖàÂú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆ API Key', 'error');
                document.getElementById('settingsModal').classList.add('active');
                return;
            }
            
            // Ê£ÄÊü•ÊòØÂê¶ÈÄâÊã©‰∫ÜÈü≥Ëâ≤
            if (!state.selectedVoice) {
                if (!state.singleVoiceWarned) {
                    // Á¨¨‰∏ÄÊ¨°ÁÇπÂáªÔºöÊèêÈÜíÁî®Êà∑
                    state.singleVoiceWarned = true;
                    showToast('üí° Êú™ÈÄâÊã©Èü≥Ëâ≤ÔºåËØ∑ÂÖàÂú®Â∑¶‰æßÈÄâÊã©Èü≥Ëâ≤ÔºåÊàñÂÜçÊ¨°ÁÇπÂáªÂ∞ÜÈöèÊú∫ÈÄâÊã©‰∏Ä‰∏™Â•≥ÊÄßÈü≥Ëâ≤', 'error');
                    return;
                } else {
                    // Á¨¨‰∫åÊ¨°ÁÇπÂáªÔºöÈöèÊú∫ÈÄâÊã©Â•≥ÊÄßÈü≥Ëâ≤
                    const femaleVoices = VOICE_DATABASE.female;
                    const randomVoice = femaleVoices[Math.floor(Math.random() * femaleVoices.length)];
                    selectVoice(randomVoice.name);
                    showToast(`Â∑≤ÈöèÊú∫ÈÄâÊã©Èü≥Ëâ≤Ôºö${randomVoice.name} (${randomVoice.trait}, ${randomVoice.age})`, 'success');
                    state.singleVoiceWarned = false; // ÈáçÁΩÆÁä∂ÊÄÅ
                    // ‰∏çË¶ÅreturnÔºåÁªßÁª≠ÊâßË°åÁîüÊàê
                }
            } else {
                // ÊúâÈÄâÊã©Èü≥Ëâ≤ÂàôÈáçÁΩÆË≠¶ÂëäÁä∂ÊÄÅ
                state.singleVoiceWarned = false;
            }

            const btn = document.getElementById('generateBtn');
            const btnText = document.getElementById('generateBtnText');
            btn.disabled = true;
            btnText.innerHTML = '<span class="loading-spinner"></span> ÁîüÊàê‰∏≠...';
            
            try {
                const { audioUrl, wavBlob } = await callTTSAPI(text, state.selectedVoice);
                playAudio(audioUrl, wavBlob);
                addToHistory(text, state.selectedVoice);
                showToast('ÁîüÊàêÊàêÂäüÔºÅ', 'success');
                updateCacheStatus();
            } catch (error) {
                showToast(`ÁîüÊàêÂ§±Ë¥•Ôºö${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btnText.textContent = 'ÁîüÊàêËØ≠Èü≥';
            }
        }
        
        async function callTTSAPI(text, voice) {
            const url = `${state.apiBaseUrl}/models/${state.model}:generateContent?key=${state.apiKey}`;
            
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text }] }],
                    generationConfig: {
                        responseModalities: ['AUDIO'],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: {
                                    voiceName: voice
                                }
                            }
                        }
                    }
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || `HTTP ${response.status}`);
            }
            
            const data = await response.json();
            const audioData = data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
            
            if (!audioData) {
                throw new Error('Êú™ÊâæÂà∞Èü≥È¢ëÊï∞ÊçÆ');
            }
            
            // ËΩ¨Êç¢‰∏∫ WAV
            const pcmData = base64ToBlob(audioData);
            const wavHeader = createWavHeader(pcmData.size);
            const wavBlob = new Blob([wavHeader, pcmData], { type: 'audio/wav' });
            
            return { audioUrl: URL.createObjectURL(wavBlob), wavBlob };
        }

        async function previewVoice(voice) {
            if (!state.apiKey) {
                showToast('ËØ∑ÂÖàÂú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆ API Key', 'error');
                document.getElementById('settingsModal').classList.add('active');
                return;
            }
            
            // ÂÅúÊ≠¢‰πãÂâçÁöÑËØïÂê¨Âπ∂Ê∏ÖÁêÜ
            if (previewAudioEl) {
                previewAudioEl.pause();
                previewAudioEl.currentTime = 0;
            }
            if (previewAudioUrl) {
                URL.revokeObjectURL(previewAudioUrl);
                previewAudioUrl = null;
            }
            
            try {
                const sample = '‰Ω†Â•ΩÔºåËøôÊòØ‰∏ÄÊÆµÈü≥Ëâ≤ËØïÂê¨„ÄÇ';
                const url = `${state.apiBaseUrl}/models/${state.model}:generateContent?key=${state.apiKey}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: sample }] }],
                        generationConfig: {
                            responseModalities: ['AUDIO'],
                            speechConfig: {
                                voiceConfig: { prebuiltVoiceConfig: { voiceName: voice } }
                            }
                        }
                    })
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error?.message || `HTTP ${response.status}`);
                }
                const data = await response.json();
                const audioData = data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                if (!audioData) throw new Error('Êú™Ëé∑ÂæóÈü≥È¢ëÊï∞ÊçÆ');
                const pcmData = base64ToBlob(audioData);
                const wavHeader = createWavHeader(pcmData.size);
                const wavBlob = new Blob([wavHeader, pcmData], { type: 'audio/wav' });
                previewAudioUrl = URL.createObjectURL(wavBlob);
                if (!previewAudioEl) previewAudioEl = new Audio();
                previewAudioEl.src = previewAudioUrl;
                previewAudioEl.play();
                showToast(`Ê≠£Âú®ËØïÂê¨Ôºö${voice}`, 'success');
            } catch (e) {
                showToast(`ËØïÂê¨Â§±Ë¥•Ôºö${e.message}`, 'error');
            }
        }
        
        function base64ToBlob(base64) {
            const byteCharacters = atob(base64);
                const byteNumbers = new Array(byteCharacters.length);
                
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                
            return new Blob([new Uint8Array(byteNumbers)]);
        }

        function createWavHeader(dataLength, sampleRate = 24000, numChannels = 1, bitsPerSample = 16) {
            const buffer = new ArrayBuffer(44);
            const view = new DataView(buffer);

            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };
            
            writeString(0, 'RIFF');
            view.setUint32(4, 36 + dataLength, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * numChannels * bitsPerSample / 8, true);
            view.setUint16(32, numChannels * bitsPerSample / 8, true);
            view.setUint16(34, bitsPerSample, true);
            writeString(36, 'data');
            view.setUint32(40, dataLength, true);

            return new Uint8Array(buffer);
        }

        // ========== Â§öÈü≥Ëâ≤ÂØπÊØî ==========
        function toggleMultiVoiceMode() {
            state.multiSelectMode = !state.multiSelectMode;
            const sidebar = document.getElementById('voiceSidebar');
            const btn = document.getElementById('multiVoiceBtn');
            
            if (state.multiSelectMode) {
                sidebar.classList.add('multi-select-mode');
                btn.textContent = '‚úì ÂºÄÂßãÂØπÊØîÁîüÊàê';
                btn.classList.add('btn-primary');
                btn.classList.remove('btn-secondary');
                showToast('üí° ËØ∑ÂãæÈÄâ2‰∏™‰ª•‰∏äÈü≥Ëâ≤ËøõË°åÂØπÊØî', 'success');
            } else {
                sidebar.classList.remove('multi-select-mode');
                btn.textContent = 'üé≠ Â§öÈü≥Ëâ≤ÂØπÊØî';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
                // Ê∏ÖÁ©∫ÈÄâÊã©
                state.selectedVoices.clear();
                document.querySelectorAll('.voice-checkbox').forEach(cb => cb.checked = false);
                updateMultiCount();
            }
        }
        
        async function generateMultiVoiceCompare() {
            const text = document.getElementById('textInput').value.trim();
            
            if (!text) {
                showToast('ËØ∑ËæìÂÖ•ÊñáÊú¨', 'error');
                return;
            }
            
            if (state.selectedVoices.size === 0) {
                if (!state.multiVoiceWarned) {
                    // Á¨¨‰∏ÄÊ¨°ÁÇπÂáªÔºöÊèêÈÜíÁî®Êà∑
                    state.multiVoiceWarned = true;
                    showToast('üí° ËØ∑ÂÖàÂãæÈÄâ2‰∏™‰ª•‰∏äÈü≥Ëâ≤ËøõË°åÂØπÊØîÔºåÊàñÂÜçÊ¨°ÁÇπÂáªÂ∞ÜËá™Âä®ÈÄâÊã©3‰∏™Êé®ËçêÈü≥Ëâ≤', 'error');
                    return;
                } else {
                    // Á¨¨‰∫åÊ¨°ÁÇπÂáªÔºöÈöèÊú∫ÈÄâÊã©3‰∏™Èü≥Ëâ≤Ôºà2Â•≥1Áî∑Ôºâ
                    const femaleVoices = VOICE_DATABASE.female;
                    const maleVoices = VOICE_DATABASE.male;
                    
                    // ÈöèÊú∫ÈÄâÊã©2‰∏™Â•≥ÊÄßÈü≥Ëâ≤
                    const shuffledFemale = [...femaleVoices].sort(() => Math.random() - 0.5);
                    const selectedFemale = shuffledFemale.slice(0, 2);
                    
                    // ÈöèÊú∫ÈÄâÊã©1‰∏™Áî∑ÊÄßÈü≥Ëâ≤
                    const randomMale = maleVoices[Math.floor(Math.random() * maleVoices.length)];
                    
                    const defaultVoices = [...selectedFemale.map(v => v.name), randomMale.name];
                    
                    defaultVoices.forEach(voice => {
                        const checkbox = document.querySelector(`.voice-checkbox[data-voice="${voice}"]`);
                        if (checkbox) {
                            checkbox.checked = true;
                            state.selectedVoices.add(voice);
                        }
                    });
                    updateMultiCount();
                    
                    const voiceNames = defaultVoices.join(', ');
                    showToast(`Â∑≤ÈöèÊú∫ÈÄâÊã©3‰∏™Èü≥Ëâ≤Ôºö${voiceNames}ÔºåÂèØÈáçÊñ∞ÂãæÈÄâÂêéÂÜçÊ¨°ÁîüÊàê`, 'success');
                    state.multiVoiceWarned = false; // ÈáçÁΩÆÁä∂ÊÄÅ
                    // ‰∏çË¶ÅreturnÔºåÁªßÁª≠ÊâßË°åÁîüÊàê
                }
            } else {
                // ÊúâÂãæÈÄâÈü≥Ëâ≤ÂàôÈáçÁΩÆË≠¶ÂëäÁä∂ÊÄÅ
                state.multiVoiceWarned = false;
            }
            
            if (!state.apiKey) {
                showToast('ËØ∑ÂÖàÂú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆ API Key', 'error');
                document.getElementById('settingsModal').classList.add('active');
                return;
            }
            
            const voices = Array.from(state.selectedVoices);
            const btn = document.getElementById('multiVoiceBtn');
            btn.disabled = true;
            btn.textContent = `Âπ∂ÂèëÁîüÊàê‰∏≠ (${voices.length})...`;
            
            // Ê∏ÖÁêÜÊóßÁöÑÂØπÊØîÈü≥È¢ë
            if (state.compareResults && state.compareResults.length > 0) {
                state.compareResults.forEach(item => {
                    if (item.audioUrl) {
                        URL.revokeObjectURL(item.audioUrl);
                    }
                });
            }
            
            state.compareResults = [];
            state.currentCompareIndex = -1;
            
            // Âπ∂ÂèëÁîüÊàêÊâÄÊúâÈü≥Ëâ≤
            showToast(`Ê≠£Âú®Âπ∂ÂèëÁîüÊàê ${voices.length} ‰∏™Èü≥Ëâ≤...`, 'success');
            
            const promises = voices.map(async (voice) => {
                try {
                    const { audioUrl, wavBlob } = await callTTSAPI(text, voice);
                    return {
                        voice,
                        audioUrl,
                        wavBlob,
                        text,
                        success: true
                    };
                } catch (error) {
                    console.error(`${voice} ÁîüÊàêÂ§±Ë¥•:`, error);
                    return {
                        voice,
                        error: error.message,
                        success: false
                    };
                }
            });
            
            const results = await Promise.all(promises);
            
            // Âè™‰øùÁïôÊàêÂäüÁöÑÁªìÊûú
            state.compareResults = results.filter(r => r.success);
            const failed = results.filter(r => !r.success);
            
            btn.disabled = false;
            toggleMultiVoiceMode(); // ÈÄÄÂá∫Â§öÈÄâÊ®°Âºè
            
            if (state.compareResults.length > 0) {
                // Ê∑ªÂä†Âà∞ÂéÜÂè≤ËÆ∞ÂΩï
                const successVoices = state.compareResults.map(r => r.voice);
                addToHistory(text, successVoices[0], true, successVoices);
                
                showComparePlaylist();
                updateCacheStatus();
                const msg = failed.length > 0 
                    ? `ÊàêÂäü ${state.compareResults.length} ‰∏™ÔºåÂ§±Ë¥• ${failed.length} ‰∏™`
                    : `ÊàêÂäüÁîüÊàê ${state.compareResults.length} ‰∏™Èü≥Ëâ≤ÁâàÊú¨`;
                showToast(msg, 'success');
            } else {
                showToast('ÊâÄÊúâÈü≥Ëâ≤ÁîüÊàêÂ§±Ë¥•', 'error');
            }
        }
        
        function showComparePlaylist() {
            const playlist = document.getElementById('comparePlaylist');
            const list = document.getElementById('compareList');
            const player = document.getElementById('audioPlayer');
            
            // Ê†áËÆ∞Êí≠ÊîæÂô®ÊúâÂÜÖÂÆπ
            if (player) {
                player.classList.add('has-content');
            }
            
            // Ëé∑ÂèñÈü≥Ëâ≤ËØ¶ÁªÜ‰ø°ÊÅØ
            const getVoiceDetails = (voiceName) => {
                for (const [category, voices] of Object.entries(VOICE_DATABASE)) {
                    const voice = voices.find(v => v.name === voiceName);
                    if (voice) return voice;
                }
                return null;
            };
            
            list.innerHTML = state.compareResults.map((item, idx) => {
                const voiceDetails = getVoiceDetails(item.voice);
                return `
                    <div class="compare-item" id="compare-${idx}" onclick="playCompareItem(${idx})">
                        <button class="compare-item-download" onclick="event.stopPropagation(); downloadCompareItem(${idx})" title="‰∏ãËΩΩÊ≠§Èü≥Ëâ≤">‚¨á</button>
                        <div class="compare-voice-name">
                            ${getVoiceIcon(item.voice)}
                            ${item.voice}
                        </div>
                        <div class="compare-voice-meta">
                            ${voiceDetails ? `
                                <span class="compare-voice-trait">${voiceDetails.trait}</span>
                                <span style="font-size: 0.65rem;">${voiceDetails.age}</span>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            playlist.classList.add('active');
            player.classList.add('has-playlist');
            updateCompareToggleBtn();
            updateComparePosition();
            
            // Ëá™Âä®Êí≠ÊîæÁ¨¨‰∏Ä‰∏™Èü≥Ëâ≤
            if (state.compareResults.length > 0) {
                // Á°Æ‰øùÁ¥¢ÂºïÊ≠£Á°ÆÂàùÂßãÂåñ
                state.currentCompareIndex = 0;
                setTimeout(() => {
                    playCompareItem(0);
                }, 300);
            }
        }
        
        function getVoiceIcon(voiceName) {
            for (const [category, voices] of Object.entries(VOICE_DATABASE)) {
                const voice = voices.find(v => v.name === voiceName);
                if (voice) {
                    if (category === 'female') return 'üë©‚Äçüé§';
                    if (category === 'male') return 'üë®‚Äçüé§';
                    return 'üßë‚Äçüé§';
                }
            }
            return 'üé§';
        }
        
        function playCompareItem(idx) {
            const item = state.compareResults[idx];
            if (!item || !item.audioUrl) {
                console.error('Êó†ÊïàÁöÑÈü≥È¢ëÈ°π', idx, item);
                showToast('Èü≥È¢ëÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑ÈáçÊñ∞ÁîüÊàê', 'error');
                return;
            }
            
            console.log(`Êí≠ÊîæÂØπÊØîÈü≥È¢ë ${idx}:`, item.voice, item.audioUrl.substring(0, 50));
            
            state.currentCompareIndex = idx;
            
            // È´ò‰∫ÆÂΩìÂâçÊí≠Êîæ
            document.querySelectorAll('.compare-item').forEach((el, i) => {
                el.classList.toggle('playing', i === idx);
            });
            
            // ÊªöÂä®Âà∞ÂΩìÂâçÊí≠ÊîæÈ°π
            const compareList = document.getElementById('compareList');
            const currentItem = compareList.children[idx];
            if (currentItem) {
                currentItem.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
            
            playAudio(item.audioUrl, item.wavBlob);
            updateComparePosition();
        }
        
        function downloadCompareItem(idx) {
            const item = state.compareResults[idx];
            if (!item || !item.audioUrl) {
                showToast('Èü≥È¢ëÊñá‰ª∂‰∏çÂèØÁî®', 'error');
                return;
            }
            
            const a = document.createElement('a');
            a.href = item.audioUrl;
            a.download = `${item.voice}_${Date.now()}.wav`;
            a.click();
            showToast(`Ê≠£Âú®‰∏ãËΩΩÔºö${item.voice}`, 'success');
        }
        
        function downloadAllCompare() {
            if (state.compareResults.length === 0) {
                showToast('Ê≤°ÊúâÂèØ‰∏ãËΩΩÁöÑÂÜÖÂÆπ', 'error');
                return;
            }
            
            showToast(`ÂºÄÂßã‰∏ãËΩΩ ${state.compareResults.length} ‰∏™Êñá‰ª∂...`, 'success');
            
            state.compareResults.forEach((item, i) => {
                setTimeout(() => {
                    const a = document.createElement('a');
                    a.href = item.audioUrl;
                    a.download = `${item.voice}_ÂØπÊØî_${Date.now()}.wav`;
                    a.click();
                }, i * 300); // Âª∂Ëøü‰∏ãËΩΩÈÅøÂÖçÊµèËßàÂô®ÈòªÊ≠¢
            });
        }
        
        function closeComparePlaylist() {
            const playlist = document.getElementById('comparePlaylist');
            const player = document.getElementById('audioPlayer');
            playlist.classList.remove('active');
            player.classList.remove('has-playlist');
            updateCompareToggleBtn();
            
            // Ê≥®ÊÑèÔºö‰∏çÊ∏ÖÁêÜÂØπÊØîÈü≥È¢ëÔºå‰øùÁïô‰ª•‰æøÁî®Êà∑ÈáçÊñ∞ÊâìÂºÄÁªßÁª≠Êí≠Êîæ
            // Èü≥È¢ë‰ºöÂú®‰ª•‰∏ãÊó∂Êú∫Ê∏ÖÁêÜÔºö
            // 1. ÁîüÊàêÊñ∞ÁöÑÂØπÊØîÂàóË°®Êó∂
            // 2. Áî®Êà∑ÊâãÂä®Ê∏ÖÁêÜÁºìÂ≠òÊó∂
            // 3. È°µÈù¢ÂÖ≥Èó≠Êó∂
        }
        
        // ÂàáÊç¢ÂØπÊØîÊí≠ÊîæÂàóË°®ÊòæÁ§∫/ÈöêËóè
        function toggleComparePlaylist() {
            const playlist = document.getElementById('comparePlaylist');
            if (playlist.classList.contains('active')) {
                closeComparePlaylist();
            } else {
                if (state.compareResults.length > 0) {
                    showComparePlaylist();
                } else {
                    showToast('ÊöÇÊó†ÂØπÊØîÂàóË°®', 'error');
                }
            }
        }
        
        // Êí≠Êîæ‰∏ä‰∏Ä‰∏™
        function playPrevCompare() {
            if (state.compareResults.length === 0) return;
            
            if (state.currentCompareIndex <= 0) {
                // Âú®Á¨¨‰∏Ä‰∏™ÊàñÊó†ÊïàÁ¥¢ÂºïÊó∂ÔºåÂæ™ÁéØÂà∞ÊúÄÂêé‰∏Ä‰∏™
                state.currentCompareIndex = state.compareResults.length - 1;
            } else {
                state.currentCompareIndex--;
            }
            
            playCompareItem(state.currentCompareIndex);
        }
        
        // Êí≠Êîæ‰∏ã‰∏Ä‰∏™
        function playNextCompare() {
            if (state.compareResults.length === 0) return;
            
            if (state.playMode === 'random') {
                // ÈöèÊú∫Ê®°Âºè
                const randomIndex = Math.floor(Math.random() * state.compareResults.length);
                state.currentCompareIndex = randomIndex;
            } else {
                // È°∫Â∫è/Âæ™ÁéØÊ®°Âºè
                if (state.currentCompareIndex >= state.compareResults.length - 1) {
                    // Âà∞ËææÊúÄÂêé‰∏Ä‰∏™ÔºåÂæ™ÁéØÂõûÁ¨¨‰∏Ä‰∏™
                    state.currentCompareIndex = 0;
                } else {
                    state.currentCompareIndex++;
                }
            }
            
            playCompareItem(state.currentCompareIndex);
        }
        
        // ÂàáÊç¢Êí≠ÊîæÊ®°Âºè
        function togglePlayMode() {
            const modes = ['order', 'loop', 'random'];
            const currentIndex = modes.indexOf(state.playMode);
            const nextIndex = (currentIndex + 1) % modes.length;
            state.playMode = modes[nextIndex];
            
            const btn = document.getElementById('playModeBtnCompare');
            const modeIcons = {
                'order': '‚ñ∂Ô∏è',
                'loop': 'üîÅ',
                'random': 'üîÄ'
            };
            const modeNames = {
                'order': 'È°∫Â∫èÊí≠Êîæ',
                'loop': 'Ëá™Âä®Âæ™ÁéØ',
                'random': 'ÈöèÊú∫Êí≠Êîæ'
            };
            const modeDesc = {
                'order': 'Êí≠ÊîæÂÆåÊúÄÂêé‰∏Ä‰∏™ÂêéÂÅúÊ≠¢ÔºåÂèØÊâãÂä®ÁªßÁª≠',
                'loop': 'Êí≠ÊîæÂÆåÊúÄÂêé‰∏Ä‰∏™ÂêéËá™Âä®Âæ™ÁéØ',
                'random': 'ÈöèÊú∫ÈÄâÊã©‰∏ã‰∏Ä‰∏™Èü≥Ëâ≤Êí≠Êîæ'
            };
            
            btn.textContent = modeIcons[state.playMode];
            btn.title = `Êí≠ÊîæÊ®°ÂºèÔºö${modeNames[state.playMode]}`;
            btn.classList.toggle('active', state.playMode !== 'order');
            
            showToast(`${modeNames[state.playMode]}Ôºö${modeDesc[state.playMode]}`, 'success');
        }
        
        // Èü≥È¢ëÊí≠ÊîæÁªìÊùüÊó∂ÁöÑÂ§ÑÁêÜ
        function handleAudioEnded() {
            // Â¶ÇÊûúÂΩìÂâçÂú®Êí≠ÊîæÂØπÊØîÂàóË°®‰∏≠ÁöÑÊüê‰∏ÄÈ°π
            if (state.currentCompareIndex >= 0 && state.compareResults.length > 0) {
                const isLastItem = state.currentCompareIndex >= state.compareResults.length - 1;
                
                // Âæ™ÁéØÊ®°ÂºèÊàñÈöèÊú∫Ê®°ÂºèÔºöÂßãÁªàËá™Âä®Êí≠Êîæ‰∏ã‰∏Ä‰∏™
                // È°∫Â∫èÊ®°ÂºèÔºöÂè™Êúâ‰∏çÊòØÊúÄÂêé‰∏Ä‰∏™Êó∂ÊâçËá™Âä®Êí≠Êîæ
                if (state.playMode === 'loop' || state.playMode === 'random' || !isLastItem) {
                    setTimeout(() => {
                        playNextCompare();
                    }, 500);
                } else {
                    // È°∫Â∫èÊ®°ÂºèÊí≠ÊîæÂÆåÊúÄÂêé‰∏Ä‰∏™ÔºöÂÅúÊ≠¢Ôºå‰ΩÜ‰øùÊåÅÂèØÊìç‰Ωú
                    showToast('‚úÖ Â∑≤Êí≠ÊîæÂÆåÊâÄÊúâÈü≥Ëâ≤ÔºåÁÇπÂáªÂç°Áâá„ÄÅ"‰∏ä‰∏Ä‰∏™"Êàñ"‰∏ã‰∏Ä‰∏™"ÁªßÁª≠Êí≠Êîæ', 'success');
                }
            }
        }
        
        // Êõ¥Êñ∞ÂØπÊØîÂàóË°®ÂàáÊç¢ÊåâÈíÆÁä∂ÊÄÅ
        function updateCompareToggleBtn() {
            const btn = document.getElementById('compareToggleGlobal');
            if (!btn) return;
            
            if (state.compareResults.length > 0) {
                btn.style.display = 'inline-block';
                btn.textContent = `üé≠ Êí≠ÊîæÂàóË°® (${state.compareResults.length})`;
                const playlist = document.getElementById('comparePlaylist');
                btn.classList.toggle('active', playlist && playlist.classList.contains('active'));
            } else {
                btn.style.display = 'none';
            }
        }
        
        // Êõ¥Êñ∞Êí≠Êîæ‰ΩçÁΩÆÊòæÁ§∫
        function updateComparePosition() {
            const el = document.getElementById('comparePosition');
            if (!el) return;
            
            if (state.currentCompareIndex >= 0 && state.compareResults.length > 0) {
                el.textContent = `(${state.currentCompareIndex + 1}/${state.compareResults.length})`;
            } else {
                el.textContent = state.compareResults.length > 0 ? `(${state.compareResults.length} ‰∏™Èü≥Ëâ≤)` : '';
            }
        }
        
        // ========== Èü≥È¢ëÊí≠Êîæ ==========
        async function playAudio(audioUrl, wavBlob) {
            const audioElement = document.getElementById('audioElement');
            const player = document.getElementById('audioPlayer');
            
            // Ê†áËÆ∞Êí≠ÊîæÂô®ÊúâÂÜÖÂÆπ
            if (player) {
                player.classList.add('has-content');
            }
            
            // Ê∏ÖÁêÜÊóßÈü≥È¢ëÔºàÂè™Âú®‰∏çÊòØÂØπÊØîÂàóË°®‰∏≠ÁöÑÈü≥È¢ëÊó∂Ê∏ÖÁêÜÔºâ
            if (state.currentAudio && state.currentAudio !== audioUrl) {
                // Ê£ÄÊü•ÊòØÂê¶ÊòØÂØπÊØîÂàóË°®‰∏≠ÁöÑÈü≥È¢ë
                const isCompareAudio = state.compareResults.some(r => r.audioUrl === state.currentAudio);
                if (!isCompareAudio) {
                    URL.revokeObjectURL(state.currentAudio);
                }
            }
            
            state.currentAudio = audioUrl;
            audioElement.src = audioUrl;
            
            console.log('Êí≠ÊîæÈü≥È¢ë:', audioUrl.substring(0, 50), '...'); // Ë∞ÉËØï‰ø°ÊÅØ
            
            // È¢ÑËÆ°ÁÆóÊï¥ËΩ®Ê≥¢ÂΩ¢
            state.waveformBins = null;
            if (wavBlob) {
                try { await computeWaveformFromBlob(wavBlob); } catch(e) { console.warn('waveform È¢ÑËÆ°ÁÆóÂ§±Ë¥•', e); }
            }
            
            // Á°Æ‰øùÈü≥È¢ëÂä†ËΩΩÂÆåÊàêÂêéÂÜçÊí≠Êîæ
            try {
                await audioElement.play();
                state.isPlaying = true;
                document.getElementById('playBtn').textContent = '‚è∏';
                startWaveformDraw();
            } catch (e) {
                console.error('Êí≠ÊîæÂ§±Ë¥•:', e);
                showToast('Êí≠ÊîæÂ§±Ë¥•ÔºåËØ∑ÈáçËØï', 'error');
                state.isPlaying = false;
                document.getElementById('playBtn').textContent = '‚ñ∂';
            }
        }
        
        function togglePlay() {
            const audioElement = document.getElementById('audioElement');
            const playBtn = document.getElementById('playBtn');
            
            if (state.isPlaying) {
                audioElement.pause();
                playBtn.textContent = '‚ñ∂';
            } else {
                audioElement.play();
                playBtn.textContent = '‚è∏';
            }
            
            state.isPlaying = !state.isPlaying;
        }
        
        function updateProgress() {
            const audioElement = document.getElementById('audioElement');
            if (!audioElement.duration) return;
            document.getElementById('currentTime').textContent = formatTime(audioElement.currentTime);
            document.getElementById('totalTime').textContent = formatTime(audioElement.duration);
        }
        
        function seekAudio(e) {
            const audioElement = document.getElementById('audioElement');
            const progressBar = document.getElementById('progressBar');
            const percent = e.offsetX / progressBar.offsetWidth;
            audioElement.currentTime = percent * audioElement.duration;
        }
        
        function formatTime(seconds) {
            if (!seconds || isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        function downloadAudio() {
            if (!state.currentAudio) return;
            
            const a = document.createElement('a');
            a.href = state.currentAudio;
            a.download = `tts_${Date.now()}.wav`;
            a.click();
            
            showToast('ÂºÄÂßã‰∏ãËΩΩ', 'success');
        }
        
        // ========== Ê≥¢ÂΩ¢ÂèØËßÜÂåñ ==========
        function ensureAnalyser() {
            if (audioCtx) return;
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const audioElement = document.getElementById('audioElement');
                sourceNode = audioCtx.createMediaElementSource(audioElement);
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 1024;
                const bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);
                sourceNode.connect(analyser);
                analyser.connect(audioCtx.destination);
            } catch (e) {
                console.warn('AudioContext ÂàùÂßãÂåñÂ§±Ë¥•Ôºå‰ΩøÁî®ÈôçÁ∫ßÊ≥¢ÂΩ¢', e);
            }
        }

        async function computeWaveformFromBlob(wavBlob) {
            try {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const arr = await wavBlob.arrayBuffer();
                const buffer = await audioCtx.decodeAudioData(arr.slice(0));
                const channelData = buffer.numberOfChannels > 1
                  ? mixDownChannels(buffer)
                  : buffer.getChannelData(0);
                const canvas = document.getElementById('waveformCanvas');
                const targetBins = Math.max(200, Math.min(1200, Math.floor(canvas.offsetWidth)));
                state.waveformBins = computeBins(channelData, targetBins);
            } catch (e) {
                console.warn('decodeAudioData Â§±Ë¥•', e);
            }
        }

        function mixDownChannels(buffer) {
            const len = buffer.length;
            const mixed = new Float32Array(len);
            for (let ch = 0; ch < buffer.numberOfChannels; ch++) {
                const data = buffer.getChannelData(ch);
                for (let i = 0; i < len; i++) mixed[i] += data[i];
            }
            for (let i = 0; i < len; i++) mixed[i] /= buffer.numberOfChannels;
            return mixed;
        }

        function computeBins(data, bins) {
            const len = data.length;
            const step = Math.floor(len / bins);
            const out = new Float32Array(bins);
            for (let i = 0; i < bins; i++) {
                const start = i * step;
                const end = i === bins - 1 ? len : start + step;
                let min = 1.0, max = -1.0;
                for (let j = start; j < end; j++) {
                    const v = data[j];
                    if (v < min) min = v;
                    if (v > max) max = v;
                }
                const amp = Math.max(Math.abs(min), Math.abs(max));
                out[i] = amp;
            }
            return out;
        }

        function startWaveformDraw() {
            ensureAnalyser();
            const canvas = document.getElementById('waveformCanvas');
            const ctx = canvas.getContext('2d');
            cancelAnimationFrame(rafId);

            const render = () => {
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                if (state.waveformBins && state.waveformBins.length) {
                    const bins = state.waveformBins;
                    const bw = canvas.width / bins.length;
                    for (let i = 0; i < bins.length; i++) {
                        const h = Math.max(2, bins[i] * canvas.height * 0.9);
                        const x = i * bw;
                        const y = (canvas.height - h) / 2;
                        const grad = ctx.createLinearGradient(0, y, 0, y + h);
                        grad.addColorStop(0, getComputedStyle(document.documentElement).getPropertyValue('--primary-terracotta') || '#D4754E');
                        grad.addColorStop(1, getComputedStyle(document.documentElement).getPropertyValue('--accent-amber') || '#E8A87C');
                        ctx.fillStyle = grad;
                        ctx.fillRect(x, y, Math.max(1, bw - 0.5), h);
                    }
                } else if (analyser && dataArray) {
                    // ÈôçÁ∫ßÔºöÁÆÄÂçïÊù°ÂΩ¢Âä®Áîª
                    const barWidth = 2;
                    const gap = 2;
                    const barCount = Math.floor(canvas.width / (barWidth + gap));
                    for (let i = 0; i < barCount; i++) {
                        const height = Math.random() * canvas.height * 0.8 + 2;
                        const x = i * (barWidth + gap);
                        const y = (canvas.height - height) / 2;
                        const grad = ctx.createLinearGradient(0, y, 0, y + height);
                        grad.addColorStop(0, getComputedStyle(document.documentElement).getPropertyValue('--primary-terracotta') || '#D4754E');
                        grad.addColorStop(1, getComputedStyle(document.documentElement).getPropertyValue('--accent-amber') || '#E8A87C');
                        ctx.fillStyle = grad;
                        ctx.fillRect(x, y, barWidth, height);
                    }
                }
                // ÁªòÂà∂ÂΩìÂâçËøõÂ∫¶ÁªÜÁ∫ø
                const audioElement = document.getElementById('audioElement');
                if (audioElement && audioElement.duration) {
                    const ratio = audioElement.currentTime / audioElement.duration;
                    const x = Math.max(0, Math.min(canvas.width, ratio * canvas.width));
                    ctx.save();
                    const waveLineVar = getComputedStyle(document.documentElement).getPropertyValue('--wave-line-color') || 'rgba(255,255,255,0.9)';
                    ctx.strokeStyle = waveLineVar.trim() || 'rgba(255,255,255,0.9)';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(x + 0.5, 0);
                    ctx.lineTo(x + 0.5, canvas.height);
                    ctx.stroke();
                    ctx.restore();
                }
                rafId = requestAnimationFrame(render);
            };
            rafId = requestAnimationFrame(render);
        }

        function stopWaveformDraw() {
            if (rafId) cancelAnimationFrame(rafId);
        }
        
        // ========== ÂéÜÂè≤ËÆ∞ÂΩï ==========
        function addToHistory(text, voice, isMulti = false, voices = []) {
            const item = {
                id: Date.now(),
                text: text,  // ‰øùÂ≠òÂÆåÊï¥ÊñáÊú¨
                voice,
                timestamp: new Date().toLocaleString('zh-CN'),
                type: isMulti ? 'multi' : 'single',
                voices: isMulti ? voices : []
            };
            
            state.history.unshift(item);
            state.history = state.history.slice(0, 100);
            localStorage.setItem('history', JSON.stringify(state.history));
            renderHistory();
        }
        
        function renderHistory() {
            const container = document.getElementById('historyContent');
            
            if (!state.history || state.history.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">ÊöÇÊó†ÂéÜÂè≤ËÆ∞ÂΩï</p>';
                return;
            }
            
            container.innerHTML = state.history.map(item => {
                const isMulti = item.type === 'multi';
                let voiceInfo = '';
                
                if (isMulti) {
                    const voicesList = item.voices && item.voices.length > 0 
                        ? item.voices.join(', ') 
                        : 'Â§ö‰∏™Èü≥Ëâ≤';
                    voiceInfo = `üé≠ Â§öÈü≥Ëâ≤ÂØπÊØî (${item.voices?.length || 0}‰∏™)<br><span style="font-size: 0.7rem; opacity: 0.8;">Èü≥Ëâ≤: ${voicesList}</span>`;
                } else {
                    voiceInfo = `Èü≥Ëâ≤: ${item.voice}`;
                }
                const applyBtnText = isMulti ? 'ÈáçÊñ∞ÁîüÊàêÂØπÊØî' : 'Â∫îÁî®';
                
                return `
                    <div class="history-item">
                        <div class="item-text">${item.text.substring(0, 100)}${item.text.length > 100 ? '...' : ''}</div>
                        <div class="item-meta">${voiceInfo} ¬∑ ${item.timestamp}</div>
                        <div class="item-actions">
                            <button class="btn-small" onclick="applyHistory(${item.id})">${applyBtnText}</button>
                            <button class="btn-small" onclick="deleteHistory(${item.id})">Âà†Èô§</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderDeleted() {
            const container = document.getElementById('historyContent');
            if (!state.deletedHistory || state.deletedHistory.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">ÊöÇÊó†Â∑≤Âà†Èô§ËÆ∞ÂΩï</p>';
                return;
            }
            container.innerHTML = state.deletedHistory.map(item => {
                const isMulti = item.type === 'multi';
                let voiceInfo = '';
                
                if (isMulti) {
                    const voicesList = item.voices && item.voices.length > 0 
                        ? item.voices.join(', ') 
                        : 'Â§ö‰∏™Èü≥Ëâ≤';
                    voiceInfo = `üé≠ Â§öÈü≥Ëâ≤ÂØπÊØî (${item.voices?.length || 0}‰∏™)<br><span style="font-size: 0.7rem; opacity: 0.8;">Èü≥Ëâ≤: ${voicesList}</span>`;
                } else {
                    voiceInfo = `Èü≥Ëâ≤: ${item.voice}`;
                }
                
                return `
                    <div class="history-item">
                        <div class="item-text">${item.text.substring(0, 100)}${item.text.length > 100 ? '...' : ''}</div>
                        <div class="item-meta">${voiceInfo} ¬∑ ${item.timestamp}</div>
                        <div class="item-actions">
                            <button class="btn-small" onclick="restoreDeleted(${item.id})">ÊÅ¢Â§ç</button>
                            <button class="btn-small" onclick="purgeDeleted(${item.id})">ÂΩªÂ∫ïÂà†Èô§</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function applyHistory(id) {
            const item = state.history.find(h => h.id === id);
            if (!item) return;
            
            document.getElementById('textInput').value = item.text;
            
            if (item.type === 'multi' && item.voices && item.voices.length > 0) {
                // Â§öÈü≥Ëâ≤ÂØπÊØîËÆ∞ÂΩï
                if (!state.apiKey) {
                    showToast('ËØ∑ÂÖàÂú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆ API Key', 'error');
                    document.getElementById('settingsModal').classList.add('active');
                    return;
                }
                
                // ËøõÂÖ•Â§öÈÄâÊ®°Âºè
                if (!state.multiSelectMode) {
                    toggleMultiVoiceMode();
                }
                
                // Ê∏ÖÁ©∫Áé∞ÊúâÈÄâÊã©
                state.selectedVoices.clear();
                document.querySelectorAll('.voice-checkbox').forEach(cb => cb.checked = false);
                
                // ÂãæÈÄâÂéÜÂè≤ËÆ∞ÂΩï‰∏≠ÁöÑÈü≥Ëâ≤
                item.voices.forEach(voice => {
                    const checkbox = document.querySelector(`.voice-checkbox[data-voice="${voice}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                        state.selectedVoices.add(voice);
                    }
                });
                updateMultiCount();
                
                showToast(`Â∑≤Âä†ËΩΩ ${item.voices.length} ‰∏™Èü≥Ëâ≤ÔºåÊ≠£Âú®ÁîüÊàê...`, 'success');
                
                // Âª∂Ëøü‰∏Ä‰∏ãËÆ©Áî®Êà∑ÁúãÂà∞ÂãæÈÄâÊïàÊûúÔºåÁÑ∂ÂêéÁõ¥Êé•Ë∞ÉÁî®Â§öÈü≥Ëâ≤ÁîüÊàêÂáΩÊï∞
                setTimeout(() => {
                    generateMultiVoiceCompare();
                }, 800);
            } else {
                // ÂçïÈü≥Ëâ≤ËÆ∞ÂΩï
                selectVoice(item.voice);
                showToast('Â∑≤Â∫îÁî®ÂéÜÂè≤ËÆ∞ÂΩï', 'success');
            }
        }
        
        function deleteHistory(id) {
            const idx = state.history.findIndex(h => h.id === id);
            if (idx !== -1) {
                lastDeletedHistoryItem = state.history[idx];
                state.history.splice(idx, 1);
                // Êé®ÂÖ•Â∑≤Âà†Èô§
                state.deletedHistory.unshift(lastDeletedHistoryItem);
                localStorage.setItem('history', JSON.stringify(state.history));
                localStorage.setItem('deletedHistory', JSON.stringify(state.deletedHistory));
                renderHistory();
                showToastAction('Â∑≤Âà†Èô§', 'Êí§ÈîÄ', () => {
                    if (lastDeletedHistoryItem) {
                        // ‰ªéÂ∑≤Âà†Èô§ÁßªÈô§ÔºåÂõûÂà∞ÂéÜÂè≤
                        state.deletedHistory = state.deletedHistory.filter(i => i.id !== lastDeletedHistoryItem.id);
                        state.history.unshift(lastDeletedHistoryItem);
                        localStorage.setItem('history', JSON.stringify(state.history));
                        localStorage.setItem('deletedHistory', JSON.stringify(state.deletedHistory));
                        renderHistory();
                        lastDeletedHistoryItem = null;
                    }
                }, 'success');
            }
        }

        function restoreDeleted(id) {
            const idx = state.deletedHistory.findIndex(h => h.id === id);
            if (idx !== -1) {
                const item = state.deletedHistory[idx];
                state.deletedHistory.splice(idx, 1);
                state.history.unshift(item);
                localStorage.setItem('history', JSON.stringify(state.history));
                localStorage.setItem('deletedHistory', JSON.stringify(state.deletedHistory));
                renderDeleted();
            }
        }

        function purgeDeleted(id) {
            state.deletedHistory = state.deletedHistory.filter(h => h.id !== id);
            localStorage.setItem('deletedHistory', JSON.stringify(state.deletedHistory));
            renderDeleted();
        }
        
        // ========== Êî∂ËóèÂäüËÉΩ ==========
        function openSaveFavoriteModal() {
            const text = document.getElementById('textInput').value.trim();
            if (!text) {
                showToast('ËØ∑ÂÖàËæìÂÖ•ÊñáÊú¨', 'error');
                return;
            }
            
            document.getElementById('saveFavoriteModal').classList.add('active');
            document.getElementById('favoriteName').value = '';
            document.getElementById('favoriteName').focus();
        }
        
        function saveFavorite() {
            const name = document.getElementById('favoriteName').value.trim();
            const text = document.getElementById('textInput').value.trim();
            
            if (!name) {
                showToast('ËØ∑ËæìÂÖ•Êî∂ËóèÂêçÁß∞', 'error');
                return;
            }
            
            const item = {
                id: Date.now(),
                name,
                text,
                voice: state.selectedVoice,
                timestamp: new Date().toLocaleString('zh-CN')
            };
            
            state.favorites.unshift(item);
            localStorage.setItem('favorites', JSON.stringify(state.favorites));
            renderFavorites();
            
            document.getElementById('saveFavoriteModal').classList.remove('active');
            showToast('‰øùÂ≠òÊàêÂäüÔºÅ', 'success');
        }
        
        function renderFavorites() {
            const container = document.getElementById('favoritesContent');
            
            if (state.favorites.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">ÊöÇÊó†Êî∂Ëóè</p>';
                return;
            }
            
            container.innerHTML = state.favorites.map(item => `
                <div class="favorite-item">
                    <div style="font-weight: 600; margin-bottom: 0.5rem;">${item.name}</div>
                    <div class="item-text">${item.text}</div>
                    <div class="item-meta">Èü≥Ëâ≤: ${item.voice}</div>
                    <div class="item-actions">
                        <button class="btn-small" onclick="applyFavorite(${item.id})">Â∫îÁî®</button>
                        <button class="btn-small" onclick="deleteFavorite(${item.id})">Âà†Èô§</button>
                    </div>
                </div>
            `).join('');
        }
        
        function applyFavorite(id) {
            const item = state.favorites.find(f => f.id === id);
            if (item) {
                document.getElementById('textInput').value = item.text;
                selectVoice(item.voice);
                showToast('Â∑≤Â∫îÁî®Êî∂ËóèÈÖçÁΩÆ', 'success');
            }
        }
        
        function deleteFavorite(id) {
            state.favorites = state.favorites.filter(f => f.id !== id);
            localStorage.setItem('favorites', JSON.stringify(state.favorites));
            renderFavorites();
            showToast('Â∑≤Âà†Èô§', 'success');
        }
        
        // ========== ËÆæÁΩÆ ==========
        function loadSettings() {
            document.getElementById('apiKey').value = state.apiKey;
            document.getElementById('apiBaseUrl').value = state.apiBaseUrl;
            document.getElementById('modelSelect').value = state.model;
        }
        
        function saveSettings() {
            state.apiKey = document.getElementById('apiKey').value.trim();
            state.apiBaseUrl = document.getElementById('apiBaseUrl').value.trim();
            state.model = document.getElementById('modelSelect').value;
            
            localStorage.setItem('apiKey', state.apiKey);
            localStorage.setItem('apiBaseUrl', state.apiBaseUrl);
            localStorage.setItem('model', state.model);
            
            document.getElementById('settingsModal').classList.remove('active');
            showToast('ËÆæÁΩÆÂ∑≤‰øùÂ≠ò', 'success');
        }
        
        // ========== Â∑•ÂÖ∑ÂáΩÊï∞ ==========
        function updateCharCount() {
            const text = document.getElementById('textInput').value;
            const count = text.length;
            document.getElementById('charCount').textContent = `${count} Â≠óÁ¨¶`;
            
            if (count > 0) {
                const estimatedSeconds = Math.ceil(count / 10);
                document.getElementById('estimatedTime').textContent = `È¢ÑËÆ° ${estimatedSeconds} Áßí`;
            } else {
                document.getElementById('estimatedTime').textContent = '';
            }
        }
        
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const content = document.createElement('span');
            content.textContent = message;
            const close = document.createElement('button');
            close.className = 'close';
            close.textContent = '‚úï';
            close.addEventListener('click', () => toast.remove());
            toast.appendChild(content);
            toast.appendChild(close);
            container.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.style.animation = 'slideIn 0.3s reverse';
                    setTimeout(() => toast.remove(), 300);
                }
            }, 3000);
        }

        function showToastAction(message, actionText, actionFn, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const content = document.createElement('span');
            content.textContent = message;
            const actionBtn = document.createElement('button');
            actionBtn.className = 'close';
            actionBtn.textContent = actionText;
            actionBtn.style.fontWeight = '600';
            actionBtn.style.color = 'var(--primary-terracotta)';
            actionBtn.addEventListener('click', () => { actionFn(); toast.remove(); });
            const close = document.createElement('button');
            close.className = 'close';
            close.textContent = '‚úï';
            close.addEventListener('click', () => toast.remove());
            toast.appendChild(content);
            toast.appendChild(actionBtn);
            toast.appendChild(close);
            container.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.style.animation = 'slideIn 0.3s reverse';
                    setTimeout(() => toast.remove(), 300);
                }
            }, 4000);
        }
        
        // Êõ¥Êñ∞ÁºìÂ≠òÁä∂ÊÄÅÊòæÁ§∫
        function updateCacheStatus() {
            const cacheEl = document.getElementById('cacheStatus');
            if (!cacheEl) return;
            
            const audioCount = (state.currentAudio ? 1 : 0) + 
                               (state.compareResults?.length || 0) + 
                               (previewAudioUrl ? 1 : 0);
            
            cacheEl.textContent = `${audioCount} ‰∏™Èü≥È¢ë`;
            
            // Êõ¥Êñ∞Ê∏ÖÁêÜÊåâÈíÆÁä∂ÊÄÅ
            const clearBtn = document.getElementById('clearCacheBtn');
            if (clearBtn) {
                clearBtn.disabled = audioCount === 0;
                clearBtn.textContent = audioCount > 0 ? `üóëÔ∏è Ê∏ÖÁêÜÈü≥È¢ëÁºìÂ≠ò (${audioCount})` : 'üóëÔ∏è Ê∏ÖÁêÜÈü≥È¢ëÁºìÂ≠ò';
            }
        }
        
        // Ê∏ÖÁêÜÊâÄÊúâÈü≥È¢ëËµÑÊ∫ê
        function cleanupAudioResources() {
            // Ê∏ÖÁêÜ‰∏ªÈü≥È¢ë
            if (state.currentAudio) {
                URL.revokeObjectURL(state.currentAudio);
                state.currentAudio = null;
            }
            
            // Ê∏ÖÁêÜÂØπÊØîÈü≥È¢ë
            if (state.compareResults && state.compareResults.length > 0) {
                state.compareResults.forEach(item => {
                    if (item.audioUrl) {
                        URL.revokeObjectURL(item.audioUrl);
                    }
                });
                state.compareResults = [];
                state.currentCompareIndex = -1;
                updateCompareToggleBtn();
                updateComparePosition();
            }
            
            // Ê∏ÖÁêÜËØïÂê¨Èü≥È¢ë
            if (previewAudioUrl) {
                URL.revokeObjectURL(previewAudioUrl);
                previewAudioUrl = null;
            }
            
            // ÊÅ¢Â§çÁ©∫Áä∂ÊÄÅ
            const player = document.getElementById('audioPlayer');
            if (player) {
                player.classList.remove('has-content');
            }
            
            updateCacheStatus();
        }
        
        // È°µÈù¢ÂÖ≥Èó≠ÂâçÊ∏ÖÁêÜ
        window.addEventListener('beforeunload', cleanupAudioResources);
    </script>
</body>
</html>
