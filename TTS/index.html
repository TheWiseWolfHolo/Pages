<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini TTS 专业版</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23D4754E;stop-opacity:1' /%3E%3Cstop offset='50%25' style='stop-color:%23C86240;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%239B5D42;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='50' cy='50' r='48' fill='url(%23grad)'/%3E%3Cpath d='M35 38 Q50 28 65 38 L65 62 Q50 72 35 62 Z' fill='%23FFF9F0' opacity='0.95'/%3E%3Cellipse cx='50' cy='43' rx='9' ry='7' fill='url(%23grad)'/%3E%3C/svg%3E">
    <style>
        /* ========== CSS 变量系统 - 优雅暖调配色 ========== */
        :root {
            /* 主色调 - Terracotta & Sienna 陶土色系 */
            --primary-terracotta: #D4754E;
            --primary-sienna: #C86240;
            --accent-amber: #E8A87C;
            --accent-bronze: #9B5D42;
            
            /* 辅助色 - 温暖米色系（更有设计感） */
            --bg-primary: #F8F6F4;
            --bg-secondary: #EDE8E4;
            --bg-card: rgba(248, 246, 244, 0.88);
            --text-primary: #2D2424;
            --text-secondary: #6B5E5E;
            --border-color: rgba(212, 117, 78, 0.14);
            --shadow-sm: rgba(155, 93, 66, 0.09);
            --shadow-md: rgba(155, 93, 66, 0.14);
            --shadow-lg: rgba(155, 93, 66, 0.20);
            
            /* 点缀色 */
            --sage-green: #8A9A8E;
            --cream: #FFF9F0;
            --charcoal: #3D3434;
            
            /* 表面色层级（统一空白与卡片的视觉系统） */
            --surface-1: rgba(248, 246, 244, 0.90);
            --surface-2: #F0EBE7;
            --surface-3: #E6DED8;
            --grid-line-color: rgba(61, 52, 52, 0.06);
            --wave-line-color: rgba(45, 36, 36, 0.9);
            
            /* 布局 */
            --sidebar-width: 280px;
            --history-width: 280px;
            --header-height: 60px;
            --player-height: 84px;
            --player-height-collapsed: 56px;
            --border-radius: 20px;
            --border-radius-sm: 14px;
            
            /* 动画 */
            --transition-smooth: cubic-bezier(0.4, 0, 0.2, 1);
            --transition-bounce: cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        [data-theme="dark"] {
            --bg-primary: #1A1514;
            --bg-secondary: #2A2220;
            --bg-card: rgba(42, 34, 32, 0.85);
            --text-primary: #F5EDE8;
            --text-secondary: #B8ADA8;
            --border-color: rgba(212, 117, 78, 0.15);
            --shadow-sm: rgba(0, 0, 0, 0.25);
            --shadow-md: rgba(0, 0, 0, 0.35);
            --shadow-lg: rgba(0, 0, 0, 0.45);
            --cream: #2A2220;
            --charcoal: #F5EDE8;
            --surface-1: rgba(42, 34, 32, 0.88);
            --surface-2: #251E1C;
            --surface-3: #2E2624;
            --grid-line-color: rgba(245, 237, 232, 0.06);
            --wave-line-color: rgba(255, 255, 255, 0.9);
        }
        
        /* ========== 基础样式 ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans SC', sans-serif;
            background: 
                radial-gradient(ellipse at top left, var(--cream) 0%, transparent 50%),
                radial-gradient(ellipse at bottom right, var(--bg-secondary) 0%, transparent 50%),
                linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            overflow: hidden;
            transition: background 0.5s var(--transition-smooth);
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 15% 25%, rgba(232, 168, 124, 0.04) 0%, transparent 40%),
                radial-gradient(circle at 85% 75%, rgba(138, 154, 142, 0.03) 0%, transparent 40%),
                radial-gradient(circle at 50% 50%, rgba(212, 117, 78, 0.02) 0%, transparent 60%);
            pointer-events: none;
            z-index: 0;
        }
        /* 细腻网格纹理，提升空白区域的设计感 */
        body::after {
            content: '';
            position: fixed;
            inset: 0;
            pointer-events: none;
            background-image:
                repeating-linear-gradient(0deg, var(--grid-line-color) 0 1px, transparent 1px 24px),
                repeating-linear-gradient(90deg, var(--grid-line-color) 0 1px, transparent 1px 24px);
            z-index: 0;
        }
        
        /* ========== 布局容器 ========== */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            position: relative;
            z-index: 1;
        }
        
        .app-header {
            height: var(--header-height);
            background: var(--bg-card);
            backdrop-filter: blur(12px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            box-shadow: 0 1px 3px var(--shadow-sm);
            z-index: 100;
        }
        
.header-left { display: flex; align-items: center; gap: 0.75rem; }

.logo {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-terracotta) 0%, var(--primary-sienna) 50%, var(--accent-bronze) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.5px;
        }
        
        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        .header-actions .chip-btn { margin: 0; }
        
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        /* ========== 侧边栏 - 音色选择器 ========== */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--surface-1);
            backdrop-filter: blur(12px);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 2px 0 12px var(--shadow-sm);
        }
        .sidebar.collapsed { display: none; }
        
        .sidebar-header {
            padding: 1.5rem;
            background: linear-gradient(to bottom, transparent, var(--border-color) 100%);
            background-size: 100% 1px;
            background-position: bottom;
            background-repeat: no-repeat;
        }
        
        .sidebar-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }
        
        .voice-search {
            width: 100%;
            padding: 0.875rem 1.125rem;
            border: 2px solid transparent;
            border-radius: var(--border-radius-sm);
            font-size: 0.9rem;
            background: linear-gradient(to right, rgba(255, 255, 255, 0.5), rgba(255, 244, 230, 0.3));
            color: var(--text-primary);
            transition: all 0.3s var(--transition-smooth);
            box-shadow: inset 0 1px 2px var(--shadow-sm);
        }
        
        .voice-search:focus {
            outline: none;
            border-color: var(--primary-terracotta);
            box-shadow: 0 0 0 4px rgba(212, 117, 78, 0.12), inset 0 1px 2px var(--shadow-sm);
            background: rgba(255, 255, 255, 0.9);
        }

        /* 暗黑模式输入类修复 */
        [data-theme="dark"] .text-input,
        [data-theme="dark"] .form-input,
        [data-theme="dark"] .voice-search {
            background: linear-gradient(to bottom, rgba(245, 237, 232, 0.06), rgba(245, 237, 232, 0.04));
            border-color: rgba(245, 237, 232, 0.14);
            color: var(--text-primary);
            caret-color: var(--accent-amber);
        }
        [data-theme="dark"] .text-input:focus,
        [data-theme="dark"] .form-input:focus,
        [data-theme="dark"] .voice-search:focus {
            background: rgba(245, 237, 232, 0.12);
            border-color: var(--primary-terracotta);
            box-shadow: 0 0 0 4px rgba(212, 117, 78, 0.16), inset 0 1px 2px rgba(0,0,0,0.2);
        }
        [data-theme="dark"] .text-input::placeholder,
        [data-theme="dark"] .form-input::placeholder,
        [data-theme="dark"] .voice-search::placeholder {
            color: rgba(245, 237, 232, 0.6);
        }
        
        .voice-list {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .voice-category {
            margin-bottom: 1.5rem;
        }
        
        .category-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.25rem;
            background: linear-gradient(135deg, var(--primary-terracotta) 0%, var(--primary-sienna) 100%);
            color: var(--cream);
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 0.875rem;
            transition: all 0.3s var(--transition-smooth);
            box-shadow: 0 3px 12px var(--shadow-md);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .category-header:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 24px var(--shadow-lg);
            background: linear-gradient(135deg, var(--primary-sienna) 0%, var(--accent-bronze) 100%);
        }
        
        .category-header:active {
            transform: translateY(0);
        }
        
        .category-arrow {
            transition: transform 0.3s var(--transition-smooth);
            display: inline-block;
        }
        
        .category-header.collapsed .category-arrow {
            transform: rotate(-90deg);
        }
        
        .category-content {
            display: none;
            padding-left: 0.5rem;
            overflow: hidden;
            transition: max-height 0.3s var(--transition-smooth);
        }
        
        .category-content.active {
            display: block;
        }

        .voice-item {
            padding: 0.875rem 1.125rem;
            margin: 0.375rem 0;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.3s var(--transition-smooth);
            position: relative;
            background: transparent;
        }
        
        .voice-item:hover {
            background: linear-gradient(to right, rgba(232, 168, 124, 0.15), transparent);
            border-color: rgba(212, 117, 78, 0.25);
            transform: translateX(3px);
        }
        
        .voice-item.selected {
            background: linear-gradient(135deg, rgba(232, 168, 124, 0.2) 0%, rgba(212, 117, 78, 0.1) 100%);
            border-color: var(--primary-terracotta);
            box-shadow: 0 4px 16px var(--shadow-md);
            transform: scale(1.02);
            border-width: 1.5px;
        }
        
        .voice-item-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .voice-icon {
            font-size: 1.1rem;
        }
        
        .voice-item-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 0.5rem;
        }
        .voice-item-meta .meta-left { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        
        .voice-tag {
            font-size: 0.75rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            background: var(--bg-primary);
            color: var(--text-secondary);
        }
        
        .favorite-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .voice-item:hover .favorite-btn,
        .favorite-btn.active {
            opacity: 1;
        }

        .preview-btn {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            background: rgba(0,0,0,0.04);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 6px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s, background 0.2s;
        }
        .voice-item:hover .preview-btn { opacity: 1; }
        .preview-btn:hover { background: rgba(0,0,0,0.06); }

        .preview-inline {
            background: rgba(0,0,0,0.04);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 999px;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            white-space: nowrap;
        }
        .preview-inline:hover { background: rgba(0,0,0,0.06); transform: translateY(-1px); }
        
        /* 多选模式 */
        .multi-select-mode .sidebar-header {
            background: linear-gradient(135deg, rgba(212, 117, 78, 0.1), rgba(232, 168, 124, 0.08));
        }
        
        .voice-checkbox {
            position: absolute;
            top: 0.75rem;
            left: 0.75rem;
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary-terracotta);
            display: none;
        }
        
        .multi-select-mode .voice-checkbox {
            display: block;
        }
        
        .multi-select-mode .voice-item {
            padding-left: 2.5rem;
        }
        
        .multi-count {
            display: none;
            background: linear-gradient(135deg, var(--primary-terracotta), var(--primary-sienna));
            color: var(--cream);
            padding: 0.4rem 0.8rem;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }
        
        .multi-select-mode .multi-count {
            display: inline-block;
        }
        
        .quick-select-buttons {
            display: none;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }
        
        .multi-select-mode .quick-select-buttons {
            display: flex;
        }
        
        .quick-select-btn {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-primary);
            border-radius: 8px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .quick-select-btn:hover {
            background: linear-gradient(135deg, rgba(212, 117, 78, 0.15), rgba(232, 168, 124, 0.1));
            border-color: var(--primary-terracotta);
            transform: translateY(-1px);
        }
        
        .quick-select-btn:active {
            transform: translateY(0);
        }
        
        /* 对比列表 - 集成到播放器内 */
        .compare-playlist {
            display: none;
            padding: 0.75rem 1.25rem 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        }
        
        [data-theme="dark"] .compare-playlist {
            border-bottom-color: rgba(255, 255, 255, 0.1);
        }
        
        .compare-playlist.active {
            display: block;
        }
        
        .compare-playlist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        
        .compare-playlist-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .compare-playlist-controls {
            display: flex;
            gap: 0.4rem;
            align-items: center;
        }
        
        
        .compare-list {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 0.5rem;
            scroll-behavior: smooth;
        }
        
        .compare-list::-webkit-scrollbar {
            height: 4px;
        }
        
        .compare-list::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 2px;
        }
        
        .compare-list::-webkit-scrollbar-thumb {
            background: linear-gradient(90deg, var(--primary-terracotta), var(--primary-sienna));
            border-radius: 2px;
        }
        
        .compare-item {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 244, 230, 0.7));
            border-radius: 10px;
            padding: 0.6rem 0.8rem;
            min-width: 140px;
            max-width: 160px;
            flex-shrink: 0;
            border: 1.5px solid transparent;
            transition: all 0.25s var(--transition-smooth);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        [data-theme="dark"] .compare-item {
            background: linear-gradient(135deg, rgba(42, 34, 32, 0.9), rgba(37, 30, 28, 0.8));
        }
        
        .compare-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--primary-terracotta), var(--accent-amber));
            opacity: 0;
            transition: opacity 0.25s;
        }
        
        .compare-item:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 4px 12px var(--shadow-md);
            border-color: rgba(212, 117, 78, 0.4);
        }
        
        .compare-item:hover::before {
            opacity: 1;
        }
        
        .compare-item.playing {
            border-color: var(--primary-terracotta);
            box-shadow: 0 4px 16px var(--shadow-lg);
            background: linear-gradient(135deg, rgba(232, 168, 124, 0.25), rgba(212, 117, 78, 0.15));
        }
        
        .compare-item.playing::before {
            opacity: 1;
            height: 3px;
        }
        
        .compare-item.playing::after {
            content: '▶';
            position: absolute;
            bottom: 0.4rem;
            right: 0.5rem;
            font-size: 0.7rem;
            color: var(--primary-terracotta);
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        .compare-item-download {
            position: absolute;
            top: 0.4rem;
            right: 0.4rem;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: none;
            background: rgba(0, 0, 0, 0.1);
            color: var(--text-secondary);
            font-size: 0.7rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.2s;
            z-index: 10;
        }
        
        .compare-item:hover .compare-item-download {
            opacity: 1;
        }
        
        .compare-item-download:hover {
            background: linear-gradient(135deg, var(--primary-terracotta), var(--primary-sienna));
            color: var(--cream);
            transform: scale(1.1);
        }
        
        [data-theme="dark"] .compare-item-download {
            background: rgba(255, 255, 255, 0.15);
            color: var(--text-primary);
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .compare-voice-name {
            font-weight: 700;
            font-size: 0.9rem;
            color: var(--text-primary);
            margin-bottom: 0.3rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .compare-voice-meta {
            font-size: 0.7rem;
            color: var(--text-secondary);
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
        }
        
        .compare-voice-trait {
            display: inline-block;
            padding: 0.15rem 0.4rem;
            background: rgba(212, 117, 78, 0.15);
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 500;
            color: var(--primary-sienna);
            width: fit-content;
        }
        
        .audio-player.has-playlist {
            height: auto;
            min-height: 200px;
            max-height: 320px;
        }
        
        .player-empty-state {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.85rem;
            padding: 0;
            opacity: 0.6;
            min-height: 0;
        }
        
        .player-empty-state.hidden {
            display: none;
        }
        
        /* 当显示空状态时，隐藏播放控制 */
        .audio-player:not(.has-content) .player-controls {
            display: none;
        }
        
        /* 有内容时显示播放控制 */
        .audio-player.has-content {
            min-height: var(--player-height);
        }
        
        .audio-player.has-content .player-controls {
            display: flex;
        }
        
        .audio-player.has-content .player-empty-state {
            display: none;
        }
        
        /* ========== 中央工作区 ========== */
        .workspace {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 2rem;
            overflow-y: auto;
        }
        
        .workspace-card {
            background: var(--surface-1);
            backdrop-filter: blur(12px);
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: 0 2px 20px var(--shadow-sm), 0 0 0 1px var(--border-color);
            margin-bottom: 1.5rem;
            transition: all 0.3s var(--transition-smooth);
        }
        
        .workspace-card:hover {
            box-shadow: 0 6px 36px var(--shadow-md), 0 0 0 1px rgba(212, 117, 78, 0.2);
            transform: translateY(-3px);
        }
        
        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
          margin-bottom: 1rem;
            color: var(--text-primary);
        }
        
        .textarea-container {
            position: relative;
        }
        
        .text-input {
            width: 100%;
            min-height: 200px;
            padding: 1.25rem;
            border: 2px solid transparent;
            border-radius: var(--border-radius-sm);
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0.5), rgba(255, 244, 230, 0.2));
            color: var(--text-primary);
            transition: background-color 0.25s var(--transition-smooth), border-color 0.25s var(--transition-smooth), box-shadow 0.25s var(--transition-smooth);
            box-shadow: inset 0 1px 3px var(--shadow-sm);
        }
        
        .text-input:focus {
            outline: none;
            border-color: var(--primary-terracotta);
            box-shadow: 0 0 0 4px rgba(212, 117, 78, 0.12), inset 0 1px 3px var(--shadow-sm);
            background: rgba(255, 255, 255, 0.95);
        }
        
        .text-meta {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .btn {
            padding: 0.875rem 2rem;
            border: none;
          border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s var(--transition-smooth);
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-terracotta) 0%, var(--primary-sienna) 100%);
            color: var(--cream);
            box-shadow: 0 4px 16px var(--shadow-md);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 28px var(--shadow-lg);
            background: linear-gradient(135deg, var(--primary-sienna) 0%, var(--accent-bronze) 100%);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1.5px solid var(--border-color);
            backdrop-filter: blur(8px);
        }
        
        .btn-secondary:hover {
            background: linear-gradient(135deg, rgba(232, 168, 124, 0.12), rgba(212, 117, 78, 0.08));
            border-color: var(--primary-terracotta);
            color: var(--primary-sienna);
        }
        
        /* ========== 右侧历史面板 ========== */
        .history-panel {
            width: var(--history-width);
            background: var(--surface-1);
            backdrop-filter: blur(12px);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: transform 0.3s var(--transition-smooth);
            box-shadow: -2px 0 12px var(--shadow-sm);
        }
        
        .history-panel.collapsed {
            transform: translateX(100%);
        }
        
        .panel-header {
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to bottom, transparent, var(--border-color) 100%);
            background-size: 100% 1px;
            background-position: bottom;
            background-repeat: no-repeat;
        }
        
        .panel-title {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .chip-btn {
            border: 1px solid var(--border-color);
            background: var(--surface-1);
            color: var(--text-primary);
            border-radius: 999px;
            padding: 0.35rem 0.65rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: auto;
            margin-right: 0.5rem;
        }
        .chip-btn:hover { transform: translateY(-1px); }
        .chip-btn.active { border-color: var(--primary-terracotta); color: var(--primary-sienna); }
        
        .panel-tabs {
            display: flex;
            padding: 0 1rem;
            background: linear-gradient(to bottom, transparent, var(--border-color) 100%);
            background-size: 100% 1px;
            background-position: bottom;
            background-repeat: no-repeat;
        }
        
        .tab {
            flex: 1;
            padding: 1rem;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.3s var(--transition-smooth);
        }
        
        .tab.active {
            color: var(--primary-terracotta);
            border-bottom-color: var(--primary-terracotta);
            font-weight: 600;
        }
        
        .tab:hover:not(.active) {
            color: var(--primary-sienna);
        }
        
        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .history-item, .favorite-item {
            padding: 1rem;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.5), rgba(255, 244, 230, 0.3));
            border-radius: var(--border-radius-sm);
            margin-bottom: 0.75rem;
            border: 1px solid transparent;
            transition: all 0.3s var(--transition-smooth);
            backdrop-filter: blur(8px);
        }
        
        .history-item:hover, .favorite-item:hover {
            border-color: rgba(212, 117, 78, 0.3);
            box-shadow: 0 6px 20px var(--shadow-md);
            transform: translateY(-2px);
        }
        
        .item-text {
            font-size: 0.9rem;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .item-meta {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }
        
        .item-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-small {
            padding: 0.4rem 0.8rem;
            font-size: 0.75rem;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            background: var(--bg-card);
            color: var(--text-primary);
            transition: all 0.3s;
        }
        
        .btn-small:hover {
            background: linear-gradient(135deg, var(--primary-terracotta), var(--primary-sienna));
            color: var(--cream);
            transform: translateY(-1px);
        }
        
        /* ========== 音频播放器 ========== */
        .audio-player {
            min-height: 60px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 246, 244, 0.95) 100%);
            -webkit-backdrop-filter: blur(14px);
            backdrop-filter: blur(14px);
            padding: 1rem 1.25rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 0.75rem;
            box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.12);
            border-top: 1px solid rgba(0, 0, 0, 0.06);
            border-radius: 12px;
            position: static;
            margin: 12px 12px 12px 12px;
            color: var(--text-primary);
        }

        [data-theme="dark"] .audio-player {
            background: linear-gradient(135deg, rgba(45, 36, 36, 0.98) 0%, rgba(61, 52, 52, 0.98) 100%);
            box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.3);
            border-top: 1px solid rgba(212, 117, 78, 0.2);
            color: #fff;
        }
        
        .waveform-wrapper {
            position: relative;
            width: 100%;
            height: 48px;
        }
        
        .player-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
            width: 100%;
        }
        
        .play-btn {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-terracotta) 0%, var(--primary-sienna) 100%);
            border: none;
            color: var(--cream);
            font-size: 1.3rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.25s var(--transition-smooth);
            box-shadow: 0 2px 12px rgba(212, 117, 78, 0.35);
            flex-shrink: 0;
        }
        
        .play-btn:hover {
            transform: scale(1.08);
            box-shadow: 0 4px 20px rgba(212, 117, 78, 0.45);
        }
        
        .play-btn:active {
            transform: scale(1.0);
        }
        
        .time-label {
            color: var(--text-primary);
            font-size: 0.8rem;
            font-weight: 500;
            min-width: 42px;
            text-align: center;
            flex-shrink: 0;
        }
        [data-theme="dark"] .audio-player .time-label { color: rgba(255,255,255,0.85); }
        
        .progress-container {
            flex: 1;
            display: flex;
            align-items: center;
        }
        
        .progress-bar {
            height: 5px;
            width: 100%;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 3px;
            cursor: pointer;
            position: relative;
            transition: height 0.2s;
        }
        
        .progress-bar:hover {
            height: 6px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-terracotta) 0%, var(--accent-amber) 100%);
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s linear;
            box-shadow: 0 0 10px rgba(212, 117, 78, 0.6);
            position: relative;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            right: -1px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background: var(--cream);
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .progress-bar:hover .progress-fill::after {
            opacity: 1;
        }
        
        .wave-tooltip {
            position: absolute;
            top: -32px;
            left: 0;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.75);
            color: #fff;
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 6px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s ease;
            white-space: nowrap;
        }
        
        .player-extra {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-shrink: 0;
        }

        .speed-group { position: relative; }
        .speed-menu {
            position: absolute;
            bottom: 120%;
            right: 0;
            display: none;
            min-width: 120px;
            background: rgba(255, 255, 255, 0.92);
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(0,0,0,0.08);
            border-radius: 12px;
            padding: 6px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            z-index: 50;
            color: var(--text-primary);
        }
        [data-theme="dark"] .speed-menu {
            background: rgba(20, 16, 15, 0.94);
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 10px 30px rgba(0,0,0,0.45);
            color: #fff;
        }
        .speed-menu.visible { display: block; }
        .speed-item {
            width: 100%;
            text-align: left;
            padding: 6px 10px;
            color: inherit;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        .speed-item:hover { background: rgba(0,0,0,0.06); }
        .speed-item.active { background: rgba(0,0,0,0.08); font-weight: 600; }
        [data-theme="dark"] .speed-item:hover { background: rgba(255,255,255,0.12); }
        [data-theme="dark"] .speed-item.active { background: rgba(255,255,255,0.16); }
        
        .icon-control {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: rgba(0, 0, 0, 0.06);
            color: var(--text-primary);
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .icon-control:hover {
            background: rgba(0, 0, 0, 0.1);
            transform: scale(1.05);
        }
        
        .icon-control.active {
            background: linear-gradient(135deg, var(--primary-terracotta), var(--primary-sienna));
            color: var(--cream);
        }
        
        [data-theme="dark"] .audio-player .icon-control { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.85); }
        [data-theme="dark"] .audio-player .icon-control:hover { background: rgba(255,255,255,0.18); }
        [data-theme="dark"] .audio-player .icon-control.active {
            background: linear-gradient(135deg, var(--primary-terracotta), var(--primary-sienna));
            color: var(--cream);
        }
        
        .slider {
            width: 70px;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 2px;
            outline: none;
            cursor: pointer;
        }
        
        [data-theme="dark"] .audio-player .slider {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-terracotta), var(--primary-sienna));
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s;
        }
        
        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.25);
            box-shadow: 0 3px 12px rgba(212, 117, 78, 0.5);
        }
        
        .speed-select {
            background: rgba(255, 255, 255, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.25);
            color: var(--cream);
            padding: 0.35rem 0.6rem;
            border-radius: 10px;
            font-size: 0.8rem;
            cursor: pointer;
            outline: none;
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
        }
        .speed-select:hover { background: rgba(255, 255, 255, 0.18); }
        
        /* ========== 图标按钮 ========== */
        .icon-btn {
            width: 42px;
            height: 42px;
            border-radius: 11px;
            border: 1px solid transparent;
            background: rgba(212, 117, 78, 0.1);
            color: var(--text-primary);
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s var(--transition-smooth);
            backdrop-filter: blur(4px);
        }
        
        .icon-btn:hover {
            background: linear-gradient(135deg, var(--primary-terracotta) 0%, var(--primary-sienna) 100%);
            color: var(--cream);
            border-color: transparent;
            transform: scale(1.08);
            box-shadow: 0 6px 20px var(--shadow-md);
        }
        
        .icon-btn:active {
            transform: scale(0.96);
        }
        
        .icon-btn.active {
            background: linear-gradient(135deg, var(--primary-terracotta) 0%, var(--primary-sienna) 100%);
            color: var(--cream);
            border-color: transparent;
        }
        
        /* ========== Toast 通知 ========== */
        .toast-container {
            position: fixed;
            top: calc(var(--header-height) + 0.5rem);
            right: 1rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .toast {
            background: var(--surface-1);
            backdrop-filter: blur(12px);
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius-sm);
            box-shadow: 0 8px 32px var(--shadow-lg);
            border-left: 4px solid var(--primary-terracotta);
            animation: slideIn 0.3s var(--transition-smooth);
            min-width: 320px;
            border: 1px solid var(--border-color);
            border-left-width: 4px;
        }

        .toast .close {
            margin-left: 0.75rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1rem;
        }
        
        .toast.success {
            border-left-color: var(--sage-green);
        }
        
        .toast.error {
            border-left-color: #D64545;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* ========== Modal ========== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1600;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: var(--surface-1);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius);
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px var(--shadow-lg), 0 0 0 1px var(--border-color);
        }
        
        .modal-header {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-right: 0.5rem;
        }
        
        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: rgba(212, 117, 78, 0.1);
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s var(--transition-smooth);
            line-height: 1;
        }
        
        .modal-close:hover {
            background: var(--primary-terracotta);
            color: var(--cream);
            transform: scale(1.1) rotate(90deg);
        }
        
        [data-theme="dark"] .modal-close {
            background: rgba(245, 237, 232, 0.15);
            color: var(--text-primary);
        }
        
        [data-theme="dark"] .modal-close:hover {
            background: var(--primary-terracotta);
            color: var(--cream);
        }
        
        .modal-body {
            margin-bottom: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .form-input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid transparent;
            border-radius: var(--border-radius-sm);
            font-size: 1rem;
            background: linear-gradient(to right, rgba(255, 255, 255, 0.5), rgba(255, 244, 230, 0.3));
            color: var(--text-primary);
            transition: all 0.3s var(--transition-smooth);
            box-shadow: inset 0 1px 2px var(--shadow-sm);
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-terracotta);
            box-shadow: 0 0 0 4px rgba(212, 117, 78, 0.12), inset 0 1px 2px var(--shadow-sm);
            background: rgba(255, 255, 255, 0.95);
        }
        
        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }
        
        /* ========== 加载动画 ========== */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ========== 波形可视化 ========== */
        .waveform-canvas {
            width: 100%;
            height: 100%;
            cursor: pointer;
            border-radius: 6px;
            transition: opacity 0.2s;
        }
        
        .waveform-canvas:hover {
            opacity: 0.9;
        }
        
        /* ========== 响应式设计 ========== */
        @media (max-width: 1024px) {
            .sidebar {
                position: absolute;
                left: 0;
                top: var(--header-height);
                height: calc(100vh - var(--header-height));
                z-index: 50;
                transform: translateX(-100%);
                transition: transform 0.3s var(--transition-smooth);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .history-panel {
                display: none;
            }
            
            .compare-panel {
                width: 100%;
            }
        }

        @media (max-width: 768px) {
            .app-header {
                padding: 0 0.75rem;
            }
            
            .logo {
                font-size: 1.2rem;
            }
            
            .header-actions {
                gap: 0.5rem;
            }
            
            .icon-btn {
                width: 36px;
                height: 36px;
                font-size: 1rem;
            }
            
            .workspace {
                padding: 0.75rem;
            }
            
            .workspace-card {
                padding: 1.25rem;
                margin-bottom: 1rem;
            }
            
            .audio-player {
                padding: 0.75rem;
                min-height: 50px;
                margin: 8px;
            }
            
            .audio-player.has-content {
                min-height: 70px;
            }
            
            .audio-player.has-playlist {
                max-height: 280px;
            }
            
            .compare-playlist-header {
                padding: 0.5rem 0;
                margin-bottom: 0.5rem;
            }
            
            .compare-playlist-title {
                font-size: 0.75rem;
            }
            
            .compare-playlist-controls {
                gap: 0.3rem;
            }
            
            .compare-playlist-controls .icon-control {
                width: 26px !important;
                height: 26px !important;
                font-size: 0.75rem !important;
            }
            
            .compare-playlist-controls .btn-small {
                font-size: 0.65rem !important;
                padding: 0.25rem 0.5rem !important;
            }
            
            .waveform-wrapper {
                height: 28px;
            }
            
            .player-controls {
                gap: 0.4rem;
            }
            
            .play-btn {
                width: 36px;
                height: 36px;
                font-size: 1rem;
            }
            
            .time-label {
                font-size: 0.7rem;
                min-width: 32px;
            }
            
            .player-extra {
                gap: 0.4rem;
            }
            
            .slider {
                width: 40px;
            }
            
            .icon-control {
                width: 26px;
                height: 26px;
                font-size: 0.85rem;
            }
            
            .chip-btn {
                font-size: 0.7rem;
                padding: 0.3rem 0.5rem;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .btn {
                width: 100%;
                padding: 0.75rem 1.5rem;
                font-size: 0.95rem;
            }
            
            .compare-item {
                min-width: 100px;
                max-width: 120px;
                padding: 0.5rem 0.6rem;
            }
            
            .compare-voice-name {
                font-size: 0.8rem;
            }
            
            .compare-voice-meta {
                font-size: 0.65rem;
            }
            
            .quick-select-buttons {
                gap: 0.4rem;
            }
            
            .quick-select-btn {
                font-size: 0.7rem;
                padding: 0.4rem;
            }
            
            .sidebar-header {
                padding: 1rem;
            }
            
            .voice-search {
                padding: 0.75rem;
                font-size: 0.85rem;
            }
            
            .text-input {
                min-height: 150px;
                font-size: 0.95rem;
                padding: 1rem;
            }
            
            .player-empty-state {
                font-size: 0.75rem;
                padding: 0.5rem;
            }
            
            /* 移动端隐藏部分不常用的播放控制 */
            .speed-group {
                display: none;
            }
            
            #loopBtn {
                display: none;
            }
            
            .compare-list {
                gap: 0.4rem;
            }
            
            .sidebar {
                width: 85%;
                max-width: 300px;
            }
            
            .history-panel {
                width: 85%;
                max-width: 300px;
            }
        }
        
        /* 极小屏幕优化 */
        @media (max-width: 480px) {
            .logo {
                font-size: 1rem;
            }
            
            .chip-btn {
                font-size: 0.65rem;
                padding: 0.25rem 0.4rem;
            }
            
            .audio-player {
                padding: 0.5rem;
                margin: 6px;
            }
            
            .player-controls {
                gap: 0.3rem;
            }
            
            .play-btn {
                width: 32px;
                height: 32px;
                font-size: 0.95rem;
            }
            
            .time-label {
                font-size: 0.65rem;
                min-width: 28px;
            }
            
            .icon-control {
                width: 24px;
                height: 24px;
                font-size: 0.8rem;
            }
            
            #volumeBtn,
            #volumeSlider {
                display: none;
            }
            
            .compare-item {
                min-width: 90px;
                max-width: 110px;
                padding: 0.4rem 0.5rem;
            }
            
            .compare-voice-name {
                font-size: 0.75rem;
            }
            
            .compare-voice-trait {
                font-size: 0.6rem;
                padding: 0.1rem 0.3rem;
            }
        }
        
        /* ========== 滚动条样式 ========== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary-terracotta), var(--primary-sienna));
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, var(--primary-sienna), var(--accent-bronze));
        }
        
        /* ========== 隐藏类 ========== */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- 顶部导航 -->
        <header class="app-header">
            <div class="header-left">
                <button class="icon-btn" id="toggleSidebar" title="音色选择器">☰</button>
                <div class="logo">🎙️ Gemini TTS Pro</div>
            </div>
            <div class="header-actions">
                <button class="chip-btn" id="compareToggleGlobal" title="多音色播放列表" style="display: none;">🎭 多音色列表</button>
                <button class="chip-btn" id="historyToggleGlobal" title="打开历史记录">📜 历史</button>
                <button class="icon-btn" id="themeToggle" title="切换主题">🌓</button>
                <button class="icon-btn" id="settingsBtn" title="设置">⚙️</button>
                <button class="icon-btn" id="helpBtn" title="快捷键帮助">💡</button>
            </div>
        </header>
        
        <!-- 主内容区 -->
        <main class="main-content">
            <!-- 左侧音色选择器 -->
            <aside class="sidebar" id="voiceSidebar">
                <div class="sidebar-header">
                    <h2 class="sidebar-title">音色选择</h2>
                    <span class="multi-count" id="multiCount">已选 0 个</span>
                    <input type="text" class="voice-search" id="voiceSearch" placeholder="搜索音色...">
                    <div class="quick-select-buttons">
                        <button class="quick-select-btn" onclick="quickSelectByGender('female')">👩‍🎤 全选女声</button>
                        <button class="quick-select-btn" onclick="quickSelectByGender('male')">👨‍🎤 全选男声</button>
                        <button class="quick-select-btn" onclick="quickSelectByGender('clear')">✕ 清空</button>
                    </div>
                </div>
                <div class="voice-list" id="voiceList">
                    <!-- 音色列表将通过 JS 动态生成 -->
                </div>
            </aside>
            
            <!-- 中央工作区 -->
            <section class="workspace">
                <div class="workspace-card">
                    <h2 class="card-title">文本输入</h2>
                    <div class="textarea-container">
                        <textarea 
                            class="text-input" 
                            id="textInput" 
                            placeholder="在此输入要转换的文本...&#10;&#10;💡 提示：可使用控制语句，如：&#10;Say slowly and dramatically: 这是一个戏剧性的句子。&#10;Say excitedly: 太棒了！"
                        ></textarea>
                        <div class="text-meta">
                            <span id="charCount">0 字符</span>
                            <span id="estimatedTime"></span>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-primary" id="generateBtn">
                            <span id="generateBtnText">生成语音</span>
                        </button>
                        <button class="btn btn-secondary" id="multiVoiceBtn">🎭 多音色对比</button>
                        <button class="btn btn-secondary hidden" id="cancelMultiVoiceBtn">✕ 退出多选</button>
                        <button class="btn btn-secondary" id="saveToFavorites">保存到收藏</button>
                    </div>
                </div>
                
                <div class="workspace-card">
                    <h2 class="card-title">💡 使用技巧</h2>
                    <ul style="list-style-position: inside; color: var(--text-secondary); line-height: 1.8;">
                        <li><strong>速度：</strong>使用 "Say quickly:" 或 "Say slowly:" 控制语速</li>
                        <li><strong>语气：</strong>如 "Say cheerfully:", "Say in a whisper:", "Say dramatically:"</li>
                        <li><strong>情感：</strong>如 "Say excitedly:", "Say calmly:", "Say mysteriously:"</li>
                        <li><strong>快捷键：</strong>Ctrl/Cmd + Enter 生成，Space 播放/暂停，← → 切换音色，💡 查看完整快捷键</li>
                        <li><strong>智能生成：</strong>未选择音色时，首次提醒，再次点击自动从女性音色中随机选择</li>
                        <li><strong>多音色对比：</strong>点击"🎭 多音色对比"进入多选模式，勾选2个以上音色批量生成对比</li>
                        <li><strong>快捷勾选：</strong>多选模式下可使用"👩‍🎤 全选女声"、"👨‍🎤 全选男声"、"✕ 清空"快速操作</li>
                        <li><strong>双系统并存：</strong>单音色和多音色独立管理，可自由切换，互不影响</li>
                        <li><strong>多音色列表：</strong>支持上/下切换、循环播放、随机播放，关闭后可随时通过顶部按钮重新打开</li>
                        <li><strong>播放器：</strong>页面底部播放器始终可见，单音色直接播放，多音色显示播放列表</li>
                        <li><strong>内存管理：</strong>关闭页面自动清理，或在设置中手动清理缓存</li>
                    </ul>
                </div>
            </section>
            
            <!-- 右侧历史面板 -->
            <aside class="history-panel" id="historyPanel">
                <div class="panel-header">
                    <h2 class="panel-title">历史与收藏</h2>
                    <button class="chip-btn" id="toggleDeletedBtn" title="显示/隐藏已删除">🗑 显示已删除</button>
                    <button class="icon-btn" id="toggleHistory" title="收起">✕</button>
            </div>
                <div class="panel-tabs">
                    <button class="tab active" data-tab="history">历史</button>
                    <button class="tab" data-tab="favorites">收藏</button>
        </div>
                <div class="panel-content" id="historyContent">
                    <!-- 历史记录将通过 JS 动态生成 -->
                </div>
                <div class="panel-content hidden" id="favoritesContent">
                    <!-- 收藏记录将通过 JS 动态生成 -->
                </div>
            </aside>
        </main>
        
        <!-- 音频播放器 -->
        <div class="audio-player" id="audioPlayer">
            <!-- 空状态提示 -->
            <div class="player-empty-state" id="playerEmptyState">
                <span>🎙️</span>
                <span>暂无音频，输入文本后点击"生成语音"开始使用</span>
            </div>
            
            <!-- 多音色播放列表 -->
            <div class="compare-playlist" id="comparePlaylist">
                <div class="compare-playlist-header">
                    <div class="compare-playlist-title">
                        <span id="playlistTitle">🎭 多音色播放列表</span>
                        <span id="comparePosition" style="font-size: 0.75rem; color: var(--text-secondary); font-weight: 400;"></span>
                    </div>
                    <div class="compare-playlist-controls">
                        <button class="icon-control" id="playModeBtnCompare" title="播放模式：顺序" onclick="togglePlayMode()" style="font-size: 0.85rem; width: 28px; height: 28px;">▶️</button>
                        <button class="icon-control" id="prevCompareBtn" title="上一个" onclick="playPrevCompare()" style="font-size: 0.85rem; width: 28px; height: 28px;">⏮</button>
                        <button class="icon-control" id="nextCompareBtn" title="下一个" onclick="playNextCompare()" style="font-size: 0.85rem; width: 28px; height: 28px;">⏭</button>
                        <button class="btn-small" id="downloadAllCompare" style="font-size: 0.7rem; padding: 0.3rem 0.6rem;">📦 全部</button>
                        <button class="icon-control" onclick="closeComparePlaylist()" style="font-size: 0.85rem; width: 28px; height: 28px;">✕</button>
                    </div>
                </div>
                <div class="compare-list" id="compareList">
                    <!-- 音色列表将动态生成 -->
                </div>
            </div>
            
            <div class="player-controls">
                <button class="play-btn" id="playBtn">▶</button>
                <div class="time-label" id="currentTime">0:00</div>
                <div class="progress-container">
                    <div class="waveform-wrapper">
                        <canvas class="waveform-canvas" id="waveformCanvas"></canvas>
                        <div class="wave-tooltip" id="waveTooltip"></div>
                    </div>
                </div>
                <div class="time-label" id="totalTime">0:00</div>
                <div class="player-extra">
                    <button class="icon-control" id="volumeBtn" title="音量">🔉</button>
                    <input type="range" class="slider" id="volumeSlider" min="0" max="100" value="100">
                    <div class="speed-group">
                        <button class="icon-control" id="speedBtn" title="倍速">⚡</button>
                        <div class="speed-menu" id="speedMenu">
                            <button class="speed-item" data-speed="0.5">0.5x</button>
                            <button class="speed-item" data-speed="0.75">0.75x</button>
                            <button class="speed-item" data-speed="1">1.0x</button>
                            <button class="speed-item" data-speed="1.25">1.25x</button>
                            <button class="speed-item" data-speed="1.5">1.5x</button>
                            <button class="speed-item" data-speed="2">2.0x</button>
                        </div>
                    </div>
                    <button class="icon-control" id="loopBtn" title="循环：关">🔁</button>
                    <button class="icon-control" id="downloadBtn" title="下载">⬇️</button>
                </div>
            </div>
            <audio id="audioElement" style="display: none;"></audio>
        </div>
    
    <!-- Toast 容器 -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- 设置 Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <span>设置</span>
                <button class="modal-close" onclick="document.getElementById('settingsModal').classList.remove('active')">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">API 基础地址</label>
                    <input type="text" class="form-input" id="apiBaseUrl" value="https://generativelanguage.googleapis.com/v1beta">
                </div>
                <div class="form-group">
                    <label class="form-label">API 密钥</label>
                    <input type="password" class="form-input" id="apiKey" placeholder="输入您的 Gemini API Key">
                </div>
                <div class="form-group">
                    <label class="form-label">模型选择</label>
                    <select class="form-input" id="modelSelect">
                        <option value="gemini-2.5-flash-preview-tts">Gemini 2.5 Flash TTS (快速)</option>
                        <option value="gemini-2.5-pro-preview-tts">Gemini 2.5 Pro TTS (高质量)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">内存管理</label>
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem; padding: 0.5rem; background: rgba(212, 117, 78, 0.1); border-radius: 8px;">
                        📊 当前缓存：<span id="cacheStatus">0 个音频</span>
                    </div>
                    <button class="btn btn-secondary" style="width: 100%;" id="clearCacheBtn">🗑️ 清理音频缓存</button>
                    <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.5rem;">
                        清理当前生成的所有音频，释放内存
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancelSettings">取消</button>
                <button class="btn btn-primary" id="saveSettings">保存</button>
            </div>
        </div>
    </div>
    
    <!-- 收藏保存 Modal -->
    <div class="modal-overlay" id="saveFavoriteModal">
        <div class="modal">
            <div class="modal-header">
                <span>保存到收藏</span>
                <button class="modal-close" onclick="document.getElementById('saveFavoriteModal').classList.remove('active')">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">收藏名称</label>
                    <input type="text" class="form-input" id="favoriteName" placeholder="为这个配置命名...">
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancelFavorite">取消</button>
                <button class="btn btn-primary" id="confirmFavorite">保存</button>
            </div>
        </div>
    </div>
    
    <!-- 帮助 Modal -->
    <div class="modal-overlay" id="helpModal">
        <div class="modal">
            <div class="modal-header">
                <span>⌨️ 快捷键</span>
                <button class="modal-close" onclick="document.getElementById('helpModal').classList.remove('active')">✕</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; gap: 0.75rem; line-height: 1.6;">
                    <div style="font-weight: 600; color: var(--primary-terracotta); margin-top: 0.5rem;">⌨️ 基础操作</div>
                    <div><strong>Ctrl/Cmd + Enter</strong> - 生成语音</div>
                    <div><strong>Space</strong> - 播放/暂停</div>
                    <div><strong>Ctrl/Cmd + S</strong> - 保存到收藏</div>
                    <div><strong>Ctrl/Cmd + K</strong> - 搜索音色</div>
                    
                    <div style="font-weight: 600; color: var(--primary-terracotta); margin-top: 0.5rem;">🎭 多音色对比</div>
                    <div><strong>快捷勾选</strong> - 多选模式下可一键全选女声/男声/清空</div>
                    <div><strong>👩‍🎤 全选女声</strong> - 勾选所有女性音色（14个）</div>
                    <div><strong>👨‍🎤 全选男声</strong> - 勾选所有男性音色（17个）</div>
                    <div><strong>✕ 清空</strong> - 取消所有勾选</div>
                    
                    <div style="font-weight: 600; color: var(--primary-terracotta); margin-top: 0.5rem;">🎵 播放列表控制</div>
                    <div><strong>← 左箭头</strong> - 播放上一个音色（自动循环）</div>
                    <div><strong>→ 右箭头</strong> - 播放下一个音色（自动循环）</div>
                    <div><strong>L</strong> - 切换播放模式（▶️顺序 / 🔁循环 / 🔀随机）</div>
                    <div><strong>点击卡片</strong> - 直接播放该音色</div>
                    <div><strong>hover卡片 → ⬇</strong> - 快速下载单个音色</div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.3rem;">
                        💡 播放模式：顺序模式播放完停止，循环模式自动重复，随机模式随机选择
                    </div>
                    
                    <div style="font-weight: 600; color: var(--primary-terracotta); margin-top: 0.5rem;">🎭 高级功能</div>
                    <div><strong>点击波形</strong> - 快速跳转播放位置</div>
                    <div><strong>拖动波形</strong> - 精确定位时间点</div>
                    <div><strong>点击"🎭 多音色对比"</strong> - 进入多选模式，勾选音色批量生成</div>
                    
                    <div style="font-weight: 600; color: var(--primary-terracotta); margin-top: 0.5rem;">⚙️ 界面控制</div>
                    <div><strong>Esc</strong> - 关闭弹窗/退出多选模式</div>
                    <div><strong>再次点击"🎭 多音色对比"</strong> - 退出多选模式</div>
                    <div><strong>左上角 ☰</strong> - 显示/隐藏音色面板</div>
                    <div><strong>右上角 📜 历史</strong> - 显示/隐藏历史面板</div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" id="closeHelp">知道了</button>
            </div>
        </div>
    </div>

    <script>
        /* ========================================
         * 🎙️ Gemini TTS 专业版
         * ========================================
         * 
         * 【重要规则】自动音色选择策略：
         * 
         * ⚠️ 除非用户主动手动选择，否则系统自动选择时：
         *    - 单音色：只从女性音色（VOICE_DATABASE.female）中随机选择 1 个
         *    - 多音色：只从女性音色（VOICE_DATABASE.female）中随机选择 3 个
         *    - 永远不会自动选择男性音色（VOICE_DATABASE.male）
         *    - 永远不会自动选择中性音色（VOICE_DATABASE.neutral）
         * 
         * ✅ 只有用户在左侧音色列表中主动点击男性/中性音色，才会使用
         * 
         * ======================================== */
        
        // ========== 音色数据库 ==========
        const VOICE_DATABASE = {
            female: [
                // 年轻女声 (20-30岁)
                { name: 'Leda', trait: 'Youthful', age: '20-30岁', desc: '活泼少女音' },
                { name: 'Aoede', trait: 'Breezy', age: '20-30岁', desc: '轻快女声' },
                { name: 'Despina', trait: 'Smooth', age: '20-30岁', desc: '温柔女声' },
                { name: 'Zephyr', trait: 'Bright', age: '20-30岁', desc: '明亮女声' },
                
                // 成熟女声 (30-45岁)
                { name: 'Kore', trait: 'Firm', age: '30-45岁', desc: '坚定女声' },
                { name: 'Callirrhoe', trait: 'Easy-going', age: '30-45岁', desc: '随和女声' },
                { name: 'Autonoe', trait: 'Bright', age: '30-45岁', desc: '明亮女声' },
                { name: 'Erinome', trait: 'Clear', age: '30-45岁', desc: '清晰女声' },
                { name: 'Vindemiatrix', trait: 'Gentle', age: '30-45岁', desc: '温柔成熟女声' },
                { name: 'Achernar', trait: 'Soft', age: '30-45岁', desc: '温柔女声' },
                { name: 'Sulafat', trait: 'Warm', age: '30-45岁', desc: '温暖女声' },
                
                // 知性女声 (35-50岁)
                { name: 'Laomedeia', trait: 'Upbeat', age: '35-50岁', desc: '积极女声' },
                { name: 'Gacrux', trait: 'Mature', age: '40-50岁', desc: '成熟女声' }
            ],
            male: [
                // 成熟稳重男声 (35-50岁)
                { name: 'Pulcherrima', trait: 'Forward', age: '35-50岁', desc: '自信男声' },
                
                // 年轻男声 (20-30岁)
                { name: 'Puck', trait: 'Upbeat', age: '20-30岁', desc: '活力男声' },
                { name: 'Fenrir', trait: 'Excitable', age: '20-30岁', desc: '激情男声' },
                
                // 成熟男声 (30-45岁)
                { name: 'Charon', trait: 'Informative', age: '30-45岁', desc: '知识型男声' },
                { name: 'Orus', trait: 'Firm', age: '30-45岁', desc: '坚定男声' },
                { name: 'Enceladus', trait: 'Breathy', age: '30-45岁', desc: '磁性男声' },
                { name: 'Iapetus', trait: 'Clear', age: '30-45岁', desc: '清晰男声' },
                { name: 'Umbriel', trait: 'Easy-going', age: '30-45岁', desc: '随和男声' },
                { name: 'Algieba', trait: 'Smooth', age: '30-45岁', desc: '柔和男声' },
                { name: 'Schedar', trait: 'Even', age: '30-45岁', desc: '平稳男声' },
                { name: 'Achird', trait: 'Friendly', age: '30-45岁', desc: '友好男声' },
                { name: 'Zubenelgenubi', trait: 'Casual', age: '30-45岁', desc: '休闲男声' },
                { name: 'Sadachbia', trait: 'Lively', age: '30-45岁', desc: '活泼男声' },
                { name: 'Sadaltager', trait: 'Knowledgeable', age: '30-45岁', desc: '知识型男声' },
                
                // 沉稳男声 (40-60岁)
                { name: 'Rasalgethi', trait: 'Informative', age: '40-60岁', desc: '播音员男声' },
                { name: 'Alnilam', trait: 'Firm', age: '40-60岁', desc: '威严男声' },
                { name: 'Algenib', trait: 'Gravelly', age: '40-60岁', desc: '沙哑男声' }
            ],
            neutral: [
                // 注意：目前Gemini TTS的音色都有明确性别倾向，暂无真正的中性音色
            ]
        };
        
        // ========== 状态管理 ==========
        const state = {
            selectedVoice: '', // 默认不选择，让用户手动选择或自动随机女性音色
            theme: localStorage.getItem('theme') || 'light',
            apiKey: localStorage.getItem('apiKey') || '',
            apiBaseUrl: localStorage.getItem('apiBaseUrl') || 'https://generativelanguage.googleapis.com/v1beta',
            model: localStorage.getItem('model') || 'gemini-2.5-flash-preview-tts',
            currentAudio: null,
            isPlaying: false,
            history: JSON.parse(localStorage.getItem('history') || '[]'),
            favorites: JSON.parse(localStorage.getItem('favorites') || '[]'),
            deletedHistory: JSON.parse(localStorage.getItem('deletedHistory') || '[]'),
            showDeleted: (localStorage.getItem('showDeleted') || 'false') === 'true',
            favoriteVoices: JSON.parse(localStorage.getItem('favoriteVoices') || '[]'), // 收藏的音色列表
            waveformBins: null,
            multiSelectMode: false,
            selectedVoices: new Set(),
            compareResults: [], // 多音色对比列表
            // 播放列表状态
            currentCompareIndex: -1,
            playMode: 'order', // 'order', 'loop', 'random'
            comparePanelCollapsed: true,
            // 提醒状态
            singleVoiceWarned: false,
            multiVoiceWarned: false,
            // 当前单音色播放
            singleVoiceAudio: null
        };

        // 撤销删除所需
        let lastDeletedHistoryItem = null;
        
        // 试听音色所需
        let previewAudioUrl = null;
        let previewAudioEl = null;
        
        // ========== 音色类型验证工具 ==========
        function getVoiceGender(voiceName) {
            if (VOICE_DATABASE.female.some(v => v.name === voiceName)) return 'female';
            if (VOICE_DATABASE.male.some(v => v.name === voiceName)) return 'male';
            if (VOICE_DATABASE.neutral.some(v => v.name === voiceName)) return 'neutral';
            return 'unknown';
        }
        
        // 验证音色是否为女性
        function isFemaleVoice(voiceName) {
            return VOICE_DATABASE.female.some(v => v.name === voiceName);
        }
        
        // ========== 音频可视化全局 ==========
        let audioCtx = null;
        let analyser = null;
        let sourceNode = null;
        let dataArray = null;
        let rafId = null;
        let isScrubbing = false;
        let wasPlayingBeforeScrub = false;

        // ========== 初始化 ==========
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            initVoiceList();
            initEventListeners();
            initKeyboardShortcuts();
            loadSettings();
            renderHistory();
            renderFavorites();
            
            // 初始化播放模式按钮
            const playModeBtn = document.getElementById('playModeBtnCompare');
            if (playModeBtn) {
                playModeBtn.textContent = '▶️';
                playModeBtn.title = '播放模式：顺序播放（播放完停止）';
            }
            
            // 首次访问提示
            if (!localStorage.getItem('visited')) {
                setTimeout(() => showToast('👋 欢迎使用！按 Ctrl+Enter 快速生成，点击 💡 查看更多快捷键', 'success'), 500);
                localStorage.setItem('visited', 'true');
            }
            updateDeletedToggleBtn();
            // 恢复历史面板折叠状态
            const savedCollapsed = (localStorage.getItem('historyPanelCollapsed') || 'false') === 'true';
            setHistoryCollapsed(savedCollapsed);
            // 恢复侧边栏折叠状态
            const sidebarCollapsed = (localStorage.getItem('sidebarCollapsed') || 'false') === 'true';
            setSidebarCollapsed(sidebarCollapsed);
            if (state.showDeleted) renderDeleted();
            updateHistoryToggleBtnVisual();
            updateSidebarToggleBtnVisual();
            updateCompareToggleBtn();
            
            // 输出收藏的音色列表（调试用）
            console.log('已收藏的音色:', state.favoriteVoices);
        });
        
        // ========== 主题切换 ==========
        function initTheme() {
            document.documentElement.setAttribute('data-theme', state.theme);
        }
        
        function toggleTheme() {
            state.theme = state.theme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', state.theme);
            localStorage.setItem('theme', state.theme);
        }
        
        // ========== 音色列表初始化 ==========
        function initVoiceList() {
            const voiceList = document.getElementById('voiceList');
            const categories = {
                female: { title: '女性音色', icon: '👩‍🎤' },
                male: { title: '男性音色', icon: '👨‍🎤' },
                neutral: { title: '中性音色', icon: '🧑‍🎤' }
            };
            
            Object.entries(categories).forEach(([key, {title, icon}]) => {
                // 跳过空的分类
                if (VOICE_DATABASE[key].length === 0) return;
                
                const category = document.createElement('div');
                category.className = 'voice-category';
                category.innerHTML = `
                    <div class="category-header" data-category="${key}">
                        <span>${icon} ${title}</span>
                        <span class="category-arrow">▼</span>
                    </div>
                    <div class="category-content active">
                        ${VOICE_DATABASE[key].map(voice => `
                            <div class="voice-item ${voice.name === state.selectedVoice ? 'selected' : ''}" data-voice="${voice.name}">
                                <input type="checkbox" class="voice-checkbox" data-voice="${voice.name}">
                                <div class="voice-item-name">
                                    <span class="voice-icon">${icon}</span>
                                    <span>${getVoiceEmoji(voice.trait)} ${voice.name}</span>
                                </div>
                                <div class="voice-item-meta">
                                    <div class="meta-left">
                                        <span class="voice-tag">${voice.age}</span>
                                        <span class="voice-tag">${voice.trait}</span>
                                        <span class="voice-tag">${voice.desc}</span>
                                    </div>
                                    <button class="preview-inline" data-voice="${voice.name}">🔊 试听</button>
                                </div>
                                <button class="favorite-btn ${isFavoriteVoice(voice.name) ? 'active' : ''}" data-voice="${voice.name}">
                                    ${isFavoriteVoice(voice.name) ? '★' : '☆'}
                                </button>
                            </div>
                        `).join('')}
                    </div>
                `;
                voiceList.appendChild(category);
            });
            
            // 分类折叠功能
            document.querySelectorAll('.category-header').forEach(header => {
                header.addEventListener('click', () => {
                    const content = header.nextElementSibling;
                    const isActive = content.classList.contains('active');
                    
                    // 切换内容显示
                    content.classList.toggle('active');
                    
                    // 切换箭头方向
                    header.classList.toggle('collapsed', isActive);
                });
            });
            
            // 音色选择
            document.querySelectorAll('.voice-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    // 如果点击的是按钮，不处理
                    if (e.target.classList.contains('favorite-btn') || 
                        e.target.classList.contains('preview-inline') ||
                        e.target.classList.contains('voice-checkbox')) {
                        return;
                    }
                    
                    // 多选模式：切换复选框
                    if (state.multiSelectMode) {
                        const checkbox = item.querySelector('.voice-checkbox');
                        if (checkbox) {
                            checkbox.checked = !checkbox.checked;
                            checkbox.dispatchEvent(new Event('change'));
                        }
                    } else {
                        // 单选模式：选择音色
                        selectVoice(item.dataset.voice);
                    }
                });
            });
            
            // 收藏音色
            document.querySelectorAll('.favorite-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleFavoriteVoice(btn.dataset.voice);
                });
            });

            // 试听音色（内联按钮）
            document.querySelectorAll('.preview-inline').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    previewVoice(btn.dataset.voice);
                });
            });
            
            // 复选框处理
            document.querySelectorAll('.voice-checkbox').forEach(cb => {
                cb.addEventListener('change', (e) => {
                    e.stopPropagation();
                    const voice = cb.dataset.voice;
                    if (cb.checked) {
                        state.selectedVoices.add(voice);
                    } else {
                        state.selectedVoices.delete(voice);
                    }
                    state.multiVoiceWarned = false; // 重置警告状态
                    updateMultiCount();
                });
            });
        }
        
        function updateMultiCount() {
            const count = state.selectedVoices.size;
            const el = document.getElementById('multiCount');
            if (el) el.textContent = `已选 ${count} 个`;
        }
        
        // 一键勾选指定性别的所有音色
        function quickSelectByGender(gender) {
            if (gender === 'clear') {
                // 清空所有选择
                state.selectedVoices.clear();
                document.querySelectorAll('.voice-checkbox').forEach(cb => {
                    cb.checked = false;
                });
                updateMultiCount();
                showToast('已清空所有选择', 'success');
                state.multiVoiceWarned = false; // 重置警告状态
                return;
            }
            
            // 获取指定性别的所有音色
            const voices = VOICE_DATABASE[gender] || [];
            if (voices.length === 0) {
                showToast('该分类暂无音色', 'error');
                return;
            }
            
            // 勾选所有该性别的音色
            voices.forEach(voice => {
                const checkbox = document.querySelector(`.voice-checkbox[data-voice="${voice.name}"]`);
                if (checkbox) {
                    checkbox.checked = true;
                    state.selectedVoices.add(voice.name);
                }
            });
            
            updateMultiCount();
            state.multiVoiceWarned = false; // 重置警告状态
            
            const genderName = gender === 'female' ? '女性' : '男性';
            showToast(`已勾选所有${genderName}音色 (${voices.length}个)`, 'success');
        }
        
        function selectVoice(voiceName) {
            document.querySelectorAll('.voice-item').forEach(item => {
                item.classList.remove('selected');
            });
            document.querySelector(`[data-voice="${voiceName}"]`).classList.add('selected');
            state.selectedVoice = voiceName;
            state.singleVoiceWarned = false; // 重置警告状态
            showToast(`已选择音色：${voiceName}`, 'success');
        }

        function getVoiceEmoji(trait) {
            const map = {
                'Bright': '✨',
                'Upbeat': '🎵',
                'Informative': '🧠',
                'Firm': '🧱',
                'Excitable': '🔥',
                'Youthful': '🐣',
                'Breezy': '🌬️',
                'Easy-going': '😌',
                'Breathy': '😮\u200d💨',
                'Clear': '🔊',
                'Smooth': '🎷',
                'Gravelly': '🪨',
                'Mature': '🎩',
                'Soft': '☁️',
                'Even': '📏',
                'Friendly': '🤗',
                'Casual': '🧢',
                'Gentle': '🍃',
                'Lively': '⚡',
                'Knowledgeable': '📚',
                'Warm': '🔆'
            };
            return map[trait] || '🎙️';
        }
        
        function isFavoriteVoice(voiceName) {
            return state.favoriteVoices.includes(voiceName);
        }
        
        function toggleFavoriteVoice(voiceName) {
            const btn = document.querySelector(`.favorite-btn[data-voice="${voiceName}"]`);
            if (!btn) return;
            
            const isFav = state.favoriteVoices.includes(voiceName);
            
            if (isFav) {
                // 取消收藏
                state.favoriteVoices = state.favoriteVoices.filter(v => v !== voiceName);
                btn.classList.remove('active');
                btn.textContent = '☆';
                showToast(`已取消收藏音色：${voiceName}`, 'success');
            } else {
                // 添加收藏
                state.favoriteVoices.push(voiceName);
                btn.classList.add('active');
                btn.textContent = '★';
                showToast(`已收藏音色：${voiceName}`, 'success');
            }
            
            // 保存到 localStorage
            localStorage.setItem('favoriteVoices', JSON.stringify(state.favoriteVoices));
            console.log('收藏音色已更新:', state.favoriteVoices);
        }
        
        // ========== 搜索功能 ==========
        document.getElementById('voiceSearch').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            document.querySelectorAll('.voice-item').forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(query) ? 'block' : 'none';
            });
        });
        
        // ========== 事件监听 ==========
        function initEventListeners() {
            // 主题切换
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            
            // 侧边栏切换（全局按钮）
            document.getElementById('toggleSidebar').addEventListener('click', () => {
                const sidebar = document.querySelector('.sidebar');
                const collapsed = sidebar.classList.contains('collapsed');
                setSidebarCollapsed(!collapsed);
            });
            
            // 历史面板切换（面板内关闭按钮 -> 折叠）
            document.getElementById('toggleHistory').addEventListener('click', () => {
                setHistoryCollapsed(true);
            });

            // 顶部历史按钮（显示/隐藏）
            document.getElementById('historyToggleGlobal').addEventListener('click', () => {
                const panel = document.getElementById('historyPanel');
                const next = panel.classList.contains('collapsed') ? false : true;
                setHistoryCollapsed(next);
            });
            
            // 顶部对比列表按钮
            document.getElementById('compareToggleGlobal').addEventListener('click', () => {
                toggleComparePlaylist();
            });
            
            // 显示/隐藏已删除
            document.getElementById('toggleDeletedBtn').addEventListener('click', () => {
                state.showDeleted = !state.showDeleted;
                localStorage.setItem('showDeleted', state.showDeleted);
                updateDeletedToggleBtn();
                const activeTab = document.querySelector('.tab.active')?.dataset.tab;
                if (activeTab === 'history') {
                    if (state.showDeleted) renderDeleted(); else renderHistory();
                }
            });
            
            // 生成语音
            document.getElementById('generateBtn').addEventListener('click', generateSpeech);
            
            // 多音色对比
            document.getElementById('multiVoiceBtn').addEventListener('click', () => {
                if (state.multiSelectMode) {
                    generateMultiVoiceCompare();
                } else {
                    toggleMultiVoiceMode();
                }
            });
            
            // 退出多选模式
            document.getElementById('cancelMultiVoiceBtn').addEventListener('click', () => {
                if (state.multiSelectMode) {
                    toggleMultiVoiceMode();
                }
            });
            
            // 保存到收藏
            document.getElementById('saveToFavorites').addEventListener('click', openSaveFavoriteModal);
            
            // 设置
            document.getElementById('settingsBtn').addEventListener('click', () => {
                document.getElementById('settingsModal').classList.add('active');
                updateCacheStatus();
            });
            
            document.getElementById('cancelSettings').addEventListener('click', () => {
                document.getElementById('settingsModal').classList.remove('active');
            });
            
            document.getElementById('saveSettings').addEventListener('click', saveSettings);
            
            // 清理缓存
            document.getElementById('clearCacheBtn').addEventListener('click', () => {
                const audioCount = (state.singleVoiceAudio ? 1 : 0) + 
                                   (state.compareResults?.length || 0) + 
                                   (previewAudioUrl ? 1 : 0);
                
                if (audioCount === 0) {
                    showToast('当前没有音频缓存', 'success');
                    return;
                }
                
                if (confirm(`将清理 ${audioCount} 个音频缓存，是否继续？`)) {
                    cleanupAudioResources();
                    showToast(`已清理 ${audioCount} 个音频缓存`, 'success');
                }
            });
            
            // 帮助
            document.getElementById('helpBtn').addEventListener('click', () => {
                document.getElementById('helpModal').classList.add('active');
            });
            
            document.getElementById('closeHelp').addEventListener('click', () => {
                document.getElementById('helpModal').classList.remove('active');
            });
            
            // Tab 切换
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    const tabName = tab.dataset.tab;
                    document.getElementById('historyContent').classList.toggle('hidden', tabName !== 'history');
                    document.getElementById('favoritesContent').classList.toggle('hidden', tabName !== 'favorites');
                });
            });
            
            // 播放控制
            const playBtn = document.getElementById('playBtn');
            const audioElement = document.getElementById('audioElement');
            
            playBtn.addEventListener('click', togglePlay);
            
            audioElement.addEventListener('timeupdate', updateProgress);
            audioElement.addEventListener('ended', () => {
                state.isPlaying = false;
                playBtn.textContent = '▶';
                // 自动播放下一个（如果在播放列表中）
                handleAudioEnded();
            });
            audioElement.addEventListener('play', () => { startWaveformDraw(); });
            audioElement.addEventListener('pause', () => { stopWaveformDraw(); });
            
            // 进度条已移除，使用波形进行寻址
            
            // 波形交互：点击/拖拽寻址 + tooltip
            const waveformCanvas = document.getElementById('waveformCanvas');
            const waveTooltip = document.getElementById('waveTooltip');
            const getTimeFromX = (x) => {
                const rect = waveformCanvas.getBoundingClientRect();
                const ratio = Math.min(Math.max((x - rect.left) / rect.width, 0), 1);
                return ratio * (audioElement.duration || 0);
            };
            const setTooltip = (x) => {
                const t = getTimeFromX(x);
                const rect = waveformCanvas.getBoundingClientRect();
                waveTooltip.style.left = `${x - rect.left}px`;
                waveTooltip.textContent = formatTime(t);
            };
            waveformCanvas.addEventListener('mouseenter', () => {
                waveTooltip.style.opacity = '1';
            });
            waveformCanvas.addEventListener('mouseleave', () => {
                waveTooltip.style.opacity = '0';
                if (isScrubbing) {
                    isScrubbing = false;
                    if (wasPlayingBeforeScrub) audioElement.play();
                }
            });
            waveformCanvas.addEventListener('mousemove', (e) => {
                setTooltip(e.clientX);
                if (isScrubbing) {
                    audioElement.currentTime = getTimeFromX(e.clientX);
                }
            });
            const startScrub = (clientX) => {
                wasPlayingBeforeScrub = !audioElement.paused;
                if (wasPlayingBeforeScrub) audioElement.pause();
                isScrubbing = true;
                audioElement.currentTime = getTimeFromX(clientX);
            };
            waveformCanvas.addEventListener('mousedown', (e) => startScrub(e.clientX));
            window.addEventListener('mouseup', () => {
                if (isScrubbing) {
                    isScrubbing = false;
                    if (wasPlayingBeforeScrub) audioElement.play();
                }
            });
            // 触控
            waveformCanvas.addEventListener('touchstart', (e) => {
                const touch = e.touches[0];
                startScrub(touch.clientX);
            }, { passive: true });
            waveformCanvas.addEventListener('touchmove', (e) => {
                const touch = e.touches[0];
                setTooltip(touch.clientX);
                if (isScrubbing) audioElement.currentTime = getTimeFromX(touch.clientX);
            }, { passive: true });
            window.addEventListener('touchend', () => {
                if (isScrubbing) {
                    isScrubbing = false;
                    if (wasPlayingBeforeScrub) audioElement.play();
                }
            });
            
            // 音量控制
            document.getElementById('volumeSlider').addEventListener('input', (e) => {
                audioElement.volume = e.target.value / 100;
            });
            
            // 速度控制（下拉 + 闪电按钮循环）
            const speedBtn = document.getElementById('speedBtn');
            const speedMenu = document.getElementById('speedMenu');
            const speedItems = () => Array.from(document.querySelectorAll('#speedMenu .speed-item'));
            const speeds = [0.5, 0.75, 1, 1.25, 1.5, 2];
            const applySpeed = (val) => {
                const v = parseFloat(val);
                audioElement.playbackRate = v;
                if (previewAudioEl) previewAudioEl.playbackRate = v;
                speedBtn.title = `倍速：${v.toFixed(2).replace(/\.00$/, '')}x`;
                // 高亮当前选项
                speedItems().forEach(it => {
                    const m = parseFloat(it.getAttribute('data-speed'));
                    it.classList.toggle('active', m === v);
                });
            };
            // 默认1x
            applySpeed(1);
            // 打开/关闭菜单
            speedBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                speedMenu.classList.toggle('visible');
            });
            // 菜单项
            speedItems().forEach(item => {
                item.addEventListener('click', (e) => {
                    const s = e.currentTarget.getAttribute('data-speed');
                    applySpeed(s);
                    speedMenu.classList.remove('visible');
                });
            });
            // 点击外部关闭
            document.addEventListener('click', (e) => {
                if (!speedMenu.contains(e.target) && e.target !== speedBtn) {
                    speedMenu.classList.remove('visible');
                }
            });
            // Esc关闭
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') speedMenu.classList.remove('visible');
            });

            // 循环控制
            const loopBtn = document.getElementById('loopBtn');
            loopBtn.addEventListener('click', () => {
                audioElement.loop = !audioElement.loop;
                loopBtn.classList.toggle('active', audioElement.loop);
                loopBtn.title = audioElement.loop ? '循环：开' : '循环：关';
            });
            
            // 下载
            document.getElementById('downloadBtn').addEventListener('click', downloadAudio);
            
            // 下载全部对比
            document.getElementById('downloadAllCompare').addEventListener('click', downloadAllCompare);
            
            // 字符计数
            document.getElementById('textInput').addEventListener('input', updateCharCount);
            
            // Modal 关闭
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        overlay.classList.remove('active');
                    }
                });
            });
            
            // 收藏 Modal
            document.getElementById('cancelFavorite').addEventListener('click', () => {
                document.getElementById('saveFavoriteModal').classList.remove('active');
            });
            
            document.getElementById('confirmFavorite').addEventListener('click', saveFavorite);
        }

        function setSidebarCollapsed(collapsed) {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('collapsed', collapsed);
            localStorage.setItem('sidebarCollapsed', collapsed);
            updateSidebarToggleBtnVisual();
        }
        function updateSidebarToggleBtnVisual() {
            const btn = document.getElementById('toggleSidebar');
            const sidebar = document.querySelector('.sidebar');
            if (!btn || !sidebar) return;
            const collapsed = sidebar.classList.contains('collapsed');
            if (collapsed) { btn.classList.remove('active'); btn.title = '打开音色选择器'; }
            else { btn.classList.add('active'); btn.title = '关闭音色选择器'; }
        }

        function setHistoryCollapsed(collapsed) {
            const panel = document.getElementById('historyPanel');
            panel.classList.toggle('collapsed', collapsed);
            localStorage.setItem('historyPanelCollapsed', collapsed);
            updateHistoryToggleBtnVisual();
        }

        function updateHistoryToggleBtnVisual() {
            const btn = document.getElementById('historyToggleGlobal');
            const panel = document.getElementById('historyPanel');
            if (!btn || !panel) return;
            const collapsed = panel.classList.contains('collapsed');
            if (collapsed) {
                btn.classList.remove('active');
                btn.title = '打开历史记录';
                btn.textContent = '📜 历史';
                } else {
                btn.classList.add('active');
                btn.title = '关闭历史记录';
                btn.textContent = '📁 收起';
            }
        }
        
        function updateDeletedToggleBtn() {
            const btn = document.getElementById('toggleDeletedBtn');
            if (!btn) return;
            if (state.showDeleted) {
                btn.classList.add('active');
                btn.textContent = '🗂 隐藏已删除';
                btn.title = '隐藏已删除记录';
            } else {
                btn.classList.remove('active');
                btn.textContent = '🗑 显示已删除';
                btn.title = '显示已删除记录';
            }
        }
        
        // ========== 快捷键 ==========
        function initKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ctrl/Cmd + Enter: 生成
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    generateSpeech();
                }
                
                // Space: 播放/暂停（排除输入框和搜索框）
                if (e.key === ' ' && !e.target.matches('input, textarea, [contenteditable="true"]')) {
                    e.preventDefault();
                    if (state.currentAudio || state.compareResults.length > 0) {
                        togglePlay();
                    }
                }
                
                // Ctrl/Cmd + S: 保存到收藏
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    openSaveFavoriteModal();
                }
                
                // Ctrl/Cmd + K: 搜索音色
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    document.getElementById('voiceSearch').focus();
                }
                
                // 左箭头: 上一个（播放列表）
                if (e.key === 'ArrowLeft' && !e.target.matches('input, textarea')) {
                    e.preventDefault();
                    if (state.compareResults.length > 0) {
                        playPrevCompare();
                    }
                }
                
                // 右箭头: 下一个（播放列表）
                if (e.key === 'ArrowRight' && !e.target.matches('input, textarea')) {
                    e.preventDefault();
                    if (state.compareResults.length > 0) {
                        playNextCompare();
                    }
                }
                
                // L: 切换循环模式
                if (e.key === 'l' && !e.target.matches('input, textarea')) {
                    if (state.compareResults.length > 0) {
                        togglePlayMode();
                    }
                }
                
                // Esc: 关闭弹窗或退出多选模式
                if (e.key === 'Escape') {
                    // 先检查是否有打开的弹窗
                    const hasOpenModal = Array.from(document.querySelectorAll('.modal-overlay')).some(m => m.classList.contains('active'));
                    
                    if (hasOpenModal) {
                        // 关闭弹窗
                        document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
                    } else if (state.multiSelectMode) {
                        // 退出多选模式
                        toggleMultiVoiceMode();
                    }
                }
            });
        }
        
        // ========== TTS 生成 ==========
        async function generateSpeech() {
            const text = document.getElementById('textInput').value.trim();
            
            if (!text) {
                showToast('请输入文本', 'error');
                return;
            }

            if (!state.apiKey) {
                showToast('请先在设置中配置 API Key', 'error');
                document.getElementById('settingsModal').classList.add('active');
                return;
            }
            
            // 检查是否选择了音色
            if (!state.selectedVoice) {
                if (!state.singleVoiceWarned) {
                    // 第一次点击：提醒用户
                    state.singleVoiceWarned = true;
                    showToast('💡 未选择音色，请先在左侧选择音色，或再次点击将随机选择一个女性音色', 'error');
                    return;
                } else {
                    // ⚠️ 重要：第二次点击只从女性音色中随机选择，永不选择男性或中性音色
                    const femaleVoices = VOICE_DATABASE.female; // 只从女性音色数据库
                    const randomVoice = femaleVoices[Math.floor(Math.random() * femaleVoices.length)];
                    
                    // 运行时验证：确保选择的是女性音色
                    if (!isFemaleVoice(randomVoice.name)) {
                        console.error('❌ 错误：自动选择了非女性音色！', randomVoice.name);
                        showToast('系统错误：音色选择异常', 'error');
                        return;
                    }
                    
                    selectVoice(randomVoice.name);
                    showToast(`已随机选择女性音色：${randomVoice.name} (${randomVoice.trait}, ${randomVoice.age})`, 'success');
                    state.singleVoiceWarned = false; // 重置状态
                    console.log('✅ 单音色自动选择验证通过：', randomVoice.name, '- 性别:', getVoiceGender(randomVoice.name));
                    // 不要return，继续执行生成
                }
            } else {
                // 有选择音色则重置警告状态
                state.singleVoiceWarned = false;
            }

            const btn = document.getElementById('generateBtn');
            const btnText = document.getElementById('generateBtnText');
            btn.disabled = true;
            btnText.innerHTML = '<span class="loading-spinner"></span> 生成中...';
            
            try {
                const { audioUrl, wavBlob } = await callTTSAPI(text, state.selectedVoice);
                
                // 清理旧的单音色音频
                if (state.singleVoiceAudio) {
                    URL.revokeObjectURL(state.singleVoiceAudio);
                }
                state.singleVoiceAudio = audioUrl;
                
                // 直接播放，不使用播放列表
                playAudio(audioUrl, wavBlob);
                addToHistory(text, state.selectedVoice);
                
                // 提示用户如果有多音色列表
                if (state.compareResults.length > 0) {
                    showToast(`生成成功！多音色列表仍保留(${state.compareResults.length}个)，可通过顶部"🎭 多音色列表"按钮访问`, 'success');
                } else {
                    showToast('生成成功！', 'success');
                }
                
                updateCacheStatus();
            } catch (error) {
                showToast(`生成失败：${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btnText.textContent = '生成语音';
            }
        }
        
        async function callTTSAPI(text, voice) {
            const url = `${state.apiBaseUrl}/models/${state.model}:generateContent?key=${state.apiKey}`;
            
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text }] }],
                    generationConfig: {
                        responseModalities: ['AUDIO'],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: {
                                    voiceName: voice
                                }
                            }
                        }
                    }
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || `HTTP ${response.status}`);
            }
            
            const data = await response.json();
            const audioData = data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
            
            if (!audioData) {
                throw new Error('未找到音频数据');
            }
            
            // 转换为 WAV
            const pcmData = base64ToBlob(audioData);
            const wavHeader = createWavHeader(pcmData.size);
            const wavBlob = new Blob([wavHeader, pcmData], { type: 'audio/wav' });
            
            return { audioUrl: URL.createObjectURL(wavBlob), wavBlob };
        }

        async function previewVoice(voice) {
            if (!state.apiKey) {
                showToast('请先在设置中配置 API Key', 'error');
                document.getElementById('settingsModal').classList.add('active');
                return;
            }
            
            // 停止之前的试听并清理
            if (previewAudioEl) {
                previewAudioEl.pause();
                previewAudioEl.currentTime = 0;
            }
            if (previewAudioUrl) {
                URL.revokeObjectURL(previewAudioUrl);
                previewAudioUrl = null;
            }
            
            try {
                const sample = '你好，这是一段音色试听。';
                const url = `${state.apiBaseUrl}/models/${state.model}:generateContent?key=${state.apiKey}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: sample }] }],
                        generationConfig: {
                            responseModalities: ['AUDIO'],
                            speechConfig: {
                                voiceConfig: { prebuiltVoiceConfig: { voiceName: voice } }
                            }
                        }
                    })
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error?.message || `HTTP ${response.status}`);
                }
                const data = await response.json();
                const audioData = data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                if (!audioData) throw new Error('未获得音频数据');
                const pcmData = base64ToBlob(audioData);
                const wavHeader = createWavHeader(pcmData.size);
                const wavBlob = new Blob([wavHeader, pcmData], { type: 'audio/wav' });
                previewAudioUrl = URL.createObjectURL(wavBlob);
                if (!previewAudioEl) previewAudioEl = new Audio();
                previewAudioEl.src = previewAudioUrl;
                previewAudioEl.play();
                showToast(`正在试听：${voice}`, 'success');
            } catch (e) {
                showToast(`试听失败：${e.message}`, 'error');
            }
        }
        
        function base64ToBlob(base64) {
            const byteCharacters = atob(base64);
                const byteNumbers = new Array(byteCharacters.length);
                
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                
            return new Blob([new Uint8Array(byteNumbers)]);
        }

        function createWavHeader(dataLength, sampleRate = 24000, numChannels = 1, bitsPerSample = 16) {
            const buffer = new ArrayBuffer(44);
            const view = new DataView(buffer);

            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };
            
            writeString(0, 'RIFF');
            view.setUint32(4, 36 + dataLength, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * numChannels * bitsPerSample / 8, true);
            view.setUint16(32, numChannels * bitsPerSample / 8, true);
            view.setUint16(34, bitsPerSample, true);
            writeString(36, 'data');
            view.setUint32(40, dataLength, true);

            return new Uint8Array(buffer);
        }

        // ========== 多音色对比 ==========
        function toggleMultiVoiceMode() {
            state.multiSelectMode = !state.multiSelectMode;
            const sidebar = document.getElementById('voiceSidebar');
            const btn = document.getElementById('multiVoiceBtn');
            const cancelBtn = document.getElementById('cancelMultiVoiceBtn');
            
            if (state.multiSelectMode) {
                sidebar.classList.add('multi-select-mode');
                btn.textContent = '✓ 开始对比生成';
                btn.classList.add('btn-primary');
                btn.classList.remove('btn-secondary');
                if (cancelBtn) {
                    cancelBtn.classList.remove('hidden');
                }
                showToast('💡 请勾选2个以上音色进行对比（按ESC或点击"✕ 退出多选"可退出）', 'success');
            } else {
                sidebar.classList.remove('multi-select-mode');
                btn.textContent = '🎭 多音色对比';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
                if (cancelBtn) {
                    cancelBtn.classList.add('hidden');
                }
                // 清空选择
                state.selectedVoices.clear();
                document.querySelectorAll('.voice-checkbox').forEach(cb => cb.checked = false);
                updateMultiCount();
                showToast('已退出多选模式', 'success');
            }
        }
        
        async function generateMultiVoiceCompare() {
            const text = document.getElementById('textInput').value.trim();
            
            if (!text) {
                showToast('请输入文本', 'error');
                return;
            }
            
            if (state.selectedVoices.size === 0) {
                if (!state.multiVoiceWarned) {
                    // 第一次点击：提醒用户
                    state.multiVoiceWarned = true;
                    showToast('💡 请先勾选2个以上音色进行对比，或再次点击将自动从女性音色中随机选择3个', 'error');
                    return;
                } else {
                    // ⚠️ 重要：第二次点击只从女性音色中随机选择，永不选择男性或中性音色
                    const femaleVoices = VOICE_DATABASE.female; // 只从女性音色数据库
                    
                    // 随机选择3个女性音色（确保不重复）
                    const shuffledFemale = [...femaleVoices].sort(() => Math.random() - 0.5);
                    const selectedFemale = shuffledFemale.slice(0, 3);
                    
                    const defaultVoices = selectedFemale.map(v => v.name);
                    
                    // 运行时验证：确保所有选择的都是女性音色
                    const allFemale = defaultVoices.every(v => isFemaleVoice(v));
                    if (!allFemale) {
                        console.error('❌ 错误：自动选择包含非女性音色！', defaultVoices);
                        showToast('系统错误：音色选择异常', 'error');
                        return;
                    }
                    
                    defaultVoices.forEach(voice => {
                        const checkbox = document.querySelector(`.voice-checkbox[data-voice="${voice}"]`);
                        if (checkbox) {
                            checkbox.checked = true;
                            state.selectedVoices.add(voice);
                        }
                    });
                    updateMultiCount();
                    
                    const voiceNames = defaultVoices.join(', ');
                    showToast(`已随机选择3个女性音色：${voiceNames}，可重新勾选后再次生成`, 'success');
                    console.log('✅ 多音色自动选择验证通过：', voiceNames, '- 全部为女性音色');
                    state.multiVoiceWarned = false; // 重置状态
                    // 不要return，继续执行生成
                }
            } else {
                // 有勾选音色则重置警告状态
                state.multiVoiceWarned = false;
            }
            
            if (!state.apiKey) {
                showToast('请先在设置中配置 API Key', 'error');
                document.getElementById('settingsModal').classList.add('active');
                return;
            }
            
            const voices = Array.from(state.selectedVoices);
            const btn = document.getElementById('multiVoiceBtn');
            btn.disabled = true;
            btn.textContent = `并发生成中 (${voices.length})...`;
            
            // 清理旧的对比音频
            if (state.compareResults && state.compareResults.length > 0) {
                state.compareResults.forEach(item => {
                    if (item.audioUrl) {
                        URL.revokeObjectURL(item.audioUrl);
                    }
                });
            }
            
            state.compareResults = [];
            state.currentCompareIndex = -1;
            
            // 并发生成所有音色
            showToast(`正在并发生成 ${voices.length} 个音色...`, 'success');
            
            const promises = voices.map(async (voice) => {
                try {
                    const { audioUrl, wavBlob } = await callTTSAPI(text, voice);
                    return {
                        voice,
                        audioUrl,
                        wavBlob,
                        text,
                        success: true
                    };
                } catch (error) {
                    console.error(`${voice} 生成失败:`, error);
                    return {
                        voice,
                        error: error.message,
                        success: false
                    };
                }
            });
            
            const results = await Promise.all(promises);
            
            // 只保留成功的结果
            state.compareResults = results.filter(r => r.success);
            const failed = results.filter(r => !r.success);
            
            btn.disabled = false;
            toggleMultiVoiceMode(); // 退出多选模式
            
            if (state.compareResults.length > 0) {
                // 添加到历史记录
                const successVoices = state.compareResults.map(r => r.voice);
                addToHistory(text, successVoices[0], true, successVoices);
                
                showComparePlaylist();
                updateCacheStatus();
                const msg = failed.length > 0 
                    ? `成功 ${state.compareResults.length} 个，失败 ${failed.length} 个`
                    : `成功生成 ${state.compareResults.length} 个音色版本`;
                showToast(msg, 'success');
            } else {
                showToast('所有音色生成失败', 'error');
            }
        }
        
        function showComparePlaylist() {
            const playlist = document.getElementById('comparePlaylist');
            const list = document.getElementById('compareList');
            const player = document.getElementById('audioPlayer');
            
            // 标记播放器有内容
            if (player) {
                player.classList.add('has-content');
            }
            
            // 获取音色详细信息
            const getVoiceDetails = (voiceName) => {
                for (const [category, voices] of Object.entries(VOICE_DATABASE)) {
                    const voice = voices.find(v => v.name === voiceName);
                    if (voice) return voice;
                }
                return null;
            };
            
            list.innerHTML = state.compareResults.map((item, idx) => {
                const voiceDetails = getVoiceDetails(item.voice);
                return `
                    <div class="compare-item" id="compare-${idx}" onclick="playCompareItem(${idx})">
                        <button class="compare-item-download" onclick="event.stopPropagation(); downloadCompareItem(${idx})" title="下载此音色">⬇</button>
                        <div class="compare-voice-name">
                            ${getVoiceIcon(item.voice)}
                            ${item.voice}
                        </div>
                        <div class="compare-voice-meta">
                            ${voiceDetails ? `
                                <span class="compare-voice-trait">${voiceDetails.trait}</span>
                                <span style="font-size: 0.65rem;">${voiceDetails.age}</span>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            playlist.classList.add('active');
            player.classList.add('has-playlist');
            
            // 标题始终为"多音色播放列表"
            const playlistTitle = document.getElementById('playlistTitle');
            if (playlistTitle) {
                playlistTitle.textContent = '🎭 多音色播放列表';
            }
            
            updateCompareToggleBtn();
            updateComparePosition();
            
            // 自动播放第一个音色
            if (state.compareResults.length > 0) {
                // 确保索引正确初始化
                state.currentCompareIndex = 0;
                setTimeout(() => {
                    playCompareItem(0);
                }, 300);
            }
        }
        
        function getVoiceIcon(voiceName) {
            for (const [category, voices] of Object.entries(VOICE_DATABASE)) {
                const voice = voices.find(v => v.name === voiceName);
                if (voice) {
                    if (category === 'female') return '👩‍🎤';
                    if (category === 'male') return '👨‍🎤';
                    return '🧑‍🎤';
                }
            }
            return '🎤';
        }
        
        function playCompareItem(idx) {
            const item = state.compareResults[idx];
            if (!item || !item.audioUrl) {
                console.error('无效的音频项', idx, item);
                showToast('音频加载失败，请重新生成', 'error');
                return;
            }
            
            console.log(`播放对比音频 ${idx}:`, item.voice, item.audioUrl.substring(0, 50));
            
            state.currentCompareIndex = idx;
            
            // 高亮当前播放
            document.querySelectorAll('.compare-item').forEach((el, i) => {
                el.classList.toggle('playing', i === idx);
            });
            
            // 滚动到当前播放项
            const compareList = document.getElementById('compareList');
            const currentItem = compareList.children[idx];
            if (currentItem) {
                currentItem.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
            
            playAudio(item.audioUrl, item.wavBlob, true); // 标记为从对比列表播放
            updateComparePosition();
        }
        
        function downloadCompareItem(idx) {
            const item = state.compareResults[idx];
            if (!item || !item.audioUrl) {
                showToast('音频文件不可用', 'error');
                return;
            }
            
            const a = document.createElement('a');
            a.href = item.audioUrl;
            a.download = `${item.voice}_${Date.now()}.wav`;
            a.click();
            showToast(`正在下载：${item.voice}`, 'success');
        }
        
        function downloadAllCompare() {
            if (state.compareResults.length === 0) {
                showToast('没有可下载的内容', 'error');
                return;
            }
            
            showToast(`开始下载 ${state.compareResults.length} 个文件...`, 'success');
            
            state.compareResults.forEach((item, i) => {
                setTimeout(() => {
                    const a = document.createElement('a');
                    a.href = item.audioUrl;
                    a.download = `${item.voice}_对比_${Date.now()}.wav`;
                    a.click();
                }, i * 300); // 延迟下载避免浏览器阻止
            });
        }
        
        function closeComparePlaylist() {
            const playlist = document.getElementById('comparePlaylist');
            const player = document.getElementById('audioPlayer');
            playlist.classList.remove('active');
            player.classList.remove('has-playlist');
            updateCompareToggleBtn();
            
            // 注意：不清理对比音频，保留以便用户重新打开继续播放
            // 音频会在以下时机清理：
            // 1. 生成新的对比列表时
            // 2. 用户手动清理缓存时
            // 3. 页面关闭时
        }
        
        // 切换对比播放列表显示/隐藏
        function toggleComparePlaylist() {
            const playlist = document.getElementById('comparePlaylist');
            const player = document.getElementById('audioPlayer');
            
            if (playlist.classList.contains('active')) {
                closeComparePlaylist();
            } else {
                if (state.compareResults.length > 0) {
                    // 重新显示已有的播放列表
                    playlist.classList.add('active');
                    player.classList.add('has-playlist');
                    
                    // 恢复标题
                    const playlistTitle = document.getElementById('playlistTitle');
                    if (playlistTitle) {
                        playlistTitle.textContent = '🎭 多音色播放列表';
                    }
                    
                    updateCompareToggleBtn();
                    updateComparePosition();
                } else {
                    showToast('暂无多音色播放列表', 'error');
                }
            }
        }
        
        // 播放上一个
        function playPrevCompare() {
            if (state.compareResults.length === 0) return;
            
            if (state.currentCompareIndex <= 0) {
                // 在第一个或无效索引时，循环到最后一个
                state.currentCompareIndex = state.compareResults.length - 1;
            } else {
                state.currentCompareIndex--;
            }
            
            playCompareItem(state.currentCompareIndex);
        }
        
        // 播放下一个
        function playNextCompare() {
            if (state.compareResults.length === 0) return;
            
            if (state.playMode === 'random') {
                // 随机模式
                const randomIndex = Math.floor(Math.random() * state.compareResults.length);
                state.currentCompareIndex = randomIndex;
            } else {
                // 顺序/循环模式
                if (state.currentCompareIndex >= state.compareResults.length - 1) {
                    // 到达最后一个，循环回第一个
                    state.currentCompareIndex = 0;
                } else {
                    state.currentCompareIndex++;
                }
            }
            
            playCompareItem(state.currentCompareIndex);
        }
        
        // 切换播放模式
        function togglePlayMode() {
            const modes = ['order', 'loop', 'random'];
            const currentIndex = modes.indexOf(state.playMode);
            const nextIndex = (currentIndex + 1) % modes.length;
            state.playMode = modes[nextIndex];
            
            const btn = document.getElementById('playModeBtnCompare');
            const modeIcons = {
                'order': '▶️',
                'loop': '🔁',
                'random': '🔀'
            };
            const modeNames = {
                'order': '顺序播放',
                'loop': '自动循环',
                'random': '随机播放'
            };
            const modeDesc = {
                'order': '播放完最后一个后停止，可手动继续',
                'loop': '播放完最后一个后自动循环',
                'random': '随机选择下一个音色播放'
            };
            
            btn.textContent = modeIcons[state.playMode];
            btn.title = `播放模式：${modeNames[state.playMode]}`;
            btn.classList.toggle('active', state.playMode !== 'order');
            
            showToast(`${modeNames[state.playMode]}：${modeDesc[state.playMode]}`, 'success');
        }
        
        // 音频播放结束时的处理
        function handleAudioEnded() {
            // 如果当前在播放对比列表中的某一项
            if (state.currentCompareIndex >= 0 && state.compareResults.length > 0) {
                const isLastItem = state.currentCompareIndex >= state.compareResults.length - 1;
                
                // 循环模式或随机模式：始终自动播放下一个
                // 顺序模式：只有不是最后一个时才自动播放
                if (state.playMode === 'loop' || state.playMode === 'random' || !isLastItem) {
                    setTimeout(() => {
                        playNextCompare();
                    }, 500);
                } else {
                    // 顺序模式播放完最后一个：停止，但保持可操作
                    showToast('✅ 已播放完所有音色，点击卡片、"上一个"或"下一个"继续播放', 'success');
                }
            }
        }
        
        // 更新多音色列表切换按钮状态
        function updateCompareToggleBtn() {
            const btn = document.getElementById('compareToggleGlobal');
            if (!btn) return;
            
            if (state.compareResults.length > 0) {
                btn.style.display = 'inline-block';
                btn.textContent = `🎭 多音色列表 (${state.compareResults.length})`;
                
                const playlist = document.getElementById('comparePlaylist');
                btn.classList.toggle('active', playlist && playlist.classList.contains('active'));
            } else {
                btn.style.display = 'none';
            }
        }
        
        // 更新播放位置显示
        function updateComparePosition() {
            const el = document.getElementById('comparePosition');
            if (!el) return;
            
            if (state.currentCompareIndex >= 0 && state.compareResults.length > 0) {
                el.textContent = `正在播放：${state.currentCompareIndex + 1}/${state.compareResults.length}`;
            } else {
                el.textContent = state.compareResults.length > 0 ? `共 ${state.compareResults.length} 个音色` : '';
            }
        }
        
        // ========== 音频播放 ==========
        async function playAudio(audioUrl, wavBlob, isFromCompare = false) {
            const audioElement = document.getElementById('audioElement');
            const player = document.getElementById('audioPlayer');
            
            // 标记播放器有内容
            if (player) {
                player.classList.add('has-content');
            }
            
            // 如果不是从对比列表播放，且当前在对比列表模式，则退出对比列表模式
            if (!isFromCompare && state.compareResults.length > 0) {
                // 单音色播放时，隐藏播放列表但不清理数据
                const playlist = document.getElementById('comparePlaylist');
                if (playlist) {
                    playlist.classList.remove('active');
                }
                player.classList.remove('has-playlist');
                state.currentCompareIndex = -1; // 标记为不在播放列表中
            }
            
            state.currentAudio = audioUrl;
            audioElement.src = audioUrl;
            
            console.log('播放音频:', audioUrl.substring(0, 50), '...'); // 调试信息
            
            // 预计算整轨波形
            state.waveformBins = null;
            if (wavBlob) {
                try { await computeWaveformFromBlob(wavBlob); } catch(e) { console.warn('waveform 预计算失败', e); }
            }
            
            // 确保音频加载完成后再播放
            try {
                await audioElement.play();
                state.isPlaying = true;
                document.getElementById('playBtn').textContent = '⏸';
                startWaveformDraw();
            } catch (e) {
                console.error('播放失败:', e);
                showToast('播放失败，请重试', 'error');
                state.isPlaying = false;
                document.getElementById('playBtn').textContent = '▶';
            }
        }
        
        function togglePlay() {
            const audioElement = document.getElementById('audioElement');
            const playBtn = document.getElementById('playBtn');
            
            if (state.isPlaying) {
                audioElement.pause();
                playBtn.textContent = '▶';
            } else {
                audioElement.play();
                playBtn.textContent = '⏸';
            }
            
            state.isPlaying = !state.isPlaying;
        }
        
        function updateProgress() {
            const audioElement = document.getElementById('audioElement');
            if (!audioElement.duration) return;
            document.getElementById('currentTime').textContent = formatTime(audioElement.currentTime);
            document.getElementById('totalTime').textContent = formatTime(audioElement.duration);
        }
        
        function seekAudio(e) {
            const audioElement = document.getElementById('audioElement');
            const progressBar = document.getElementById('progressBar');
            const percent = e.offsetX / progressBar.offsetWidth;
            audioElement.currentTime = percent * audioElement.duration;
        }
        
        function formatTime(seconds) {
            if (!seconds || isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        function downloadAudio() {
            if (!state.currentAudio) return;
            
            const a = document.createElement('a');
            a.href = state.currentAudio;
            a.download = `tts_${Date.now()}.wav`;
            a.click();
            
            showToast('开始下载', 'success');
        }
        
        // ========== 波形可视化 ==========
        function ensureAnalyser() {
            if (audioCtx) return;
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const audioElement = document.getElementById('audioElement');
                sourceNode = audioCtx.createMediaElementSource(audioElement);
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 1024;
                const bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);
                sourceNode.connect(analyser);
                analyser.connect(audioCtx.destination);
            } catch (e) {
                console.warn('AudioContext 初始化失败，使用降级波形', e);
            }
        }

        async function computeWaveformFromBlob(wavBlob) {
            try {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const arr = await wavBlob.arrayBuffer();
                const buffer = await audioCtx.decodeAudioData(arr.slice(0));
                const channelData = buffer.numberOfChannels > 1
                  ? mixDownChannels(buffer)
                  : buffer.getChannelData(0);
                const canvas = document.getElementById('waveformCanvas');
                const targetBins = Math.max(200, Math.min(1200, Math.floor(canvas.offsetWidth)));
                state.waveformBins = computeBins(channelData, targetBins);
            } catch (e) {
                console.warn('decodeAudioData 失败', e);
            }
        }

        function mixDownChannels(buffer) {
            const len = buffer.length;
            const mixed = new Float32Array(len);
            for (let ch = 0; ch < buffer.numberOfChannels; ch++) {
                const data = buffer.getChannelData(ch);
                for (let i = 0; i < len; i++) mixed[i] += data[i];
            }
            for (let i = 0; i < len; i++) mixed[i] /= buffer.numberOfChannels;
            return mixed;
        }

        function computeBins(data, bins) {
            const len = data.length;
            const step = Math.floor(len / bins);
            const out = new Float32Array(bins);
            for (let i = 0; i < bins; i++) {
                const start = i * step;
                const end = i === bins - 1 ? len : start + step;
                let min = 1.0, max = -1.0;
                for (let j = start; j < end; j++) {
                    const v = data[j];
                    if (v < min) min = v;
                    if (v > max) max = v;
                }
                const amp = Math.max(Math.abs(min), Math.abs(max));
                out[i] = amp;
            }
            return out;
        }

        function startWaveformDraw() {
            ensureAnalyser();
            const canvas = document.getElementById('waveformCanvas');
            const ctx = canvas.getContext('2d');
            cancelAnimationFrame(rafId);

            const render = () => {
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                if (state.waveformBins && state.waveformBins.length) {
                    const bins = state.waveformBins;
                    const bw = canvas.width / bins.length;
                    for (let i = 0; i < bins.length; i++) {
                        const h = Math.max(2, bins[i] * canvas.height * 0.9);
                        const x = i * bw;
                        const y = (canvas.height - h) / 2;
                        const grad = ctx.createLinearGradient(0, y, 0, y + h);
                        grad.addColorStop(0, getComputedStyle(document.documentElement).getPropertyValue('--primary-terracotta') || '#D4754E');
                        grad.addColorStop(1, getComputedStyle(document.documentElement).getPropertyValue('--accent-amber') || '#E8A87C');
                        ctx.fillStyle = grad;
                        ctx.fillRect(x, y, Math.max(1, bw - 0.5), h);
                    }
                } else if (analyser && dataArray) {
                    // 降级：简单条形动画
                    const barWidth = 2;
                    const gap = 2;
                    const barCount = Math.floor(canvas.width / (barWidth + gap));
                    for (let i = 0; i < barCount; i++) {
                        const height = Math.random() * canvas.height * 0.8 + 2;
                        const x = i * (barWidth + gap);
                        const y = (canvas.height - height) / 2;
                        const grad = ctx.createLinearGradient(0, y, 0, y + height);
                        grad.addColorStop(0, getComputedStyle(document.documentElement).getPropertyValue('--primary-terracotta') || '#D4754E');
                        grad.addColorStop(1, getComputedStyle(document.documentElement).getPropertyValue('--accent-amber') || '#E8A87C');
                        ctx.fillStyle = grad;
                        ctx.fillRect(x, y, barWidth, height);
                    }
                }
                // 绘制当前进度细线
                const audioElement = document.getElementById('audioElement');
                if (audioElement && audioElement.duration) {
                    const ratio = audioElement.currentTime / audioElement.duration;
                    const x = Math.max(0, Math.min(canvas.width, ratio * canvas.width));
                    ctx.save();
                    const waveLineVar = getComputedStyle(document.documentElement).getPropertyValue('--wave-line-color') || 'rgba(255,255,255,0.9)';
                    ctx.strokeStyle = waveLineVar.trim() || 'rgba(255,255,255,0.9)';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(x + 0.5, 0);
                    ctx.lineTo(x + 0.5, canvas.height);
                    ctx.stroke();
                    ctx.restore();
                }
                rafId = requestAnimationFrame(render);
            };
            rafId = requestAnimationFrame(render);
        }

        function stopWaveformDraw() {
            if (rafId) cancelAnimationFrame(rafId);
        }
        
        // ========== 历史记录 ==========
        function addToHistory(text, voice, isMulti = false, voices = []) {
            const item = {
                id: Date.now(),
                text: text,  // 保存完整文本
                voice,
                timestamp: new Date().toLocaleString('zh-CN'),
                type: isMulti ? 'multi' : 'single',
                voices: isMulti ? voices : []
            };
            
            state.history.unshift(item);
            state.history = state.history.slice(0, 100);
            localStorage.setItem('history', JSON.stringify(state.history));
            renderHistory();
        }
        
        function renderHistory() {
            const container = document.getElementById('historyContent');
            
            if (!state.history || state.history.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">暂无历史记录</p>';
                return;
            }
            
            container.innerHTML = state.history.map(item => {
                const isMulti = item.type === 'multi';
                let voiceInfo = '';
                
                if (isMulti) {
                    const voicesList = item.voices && item.voices.length > 0 
                        ? item.voices.join(', ') 
                        : '多个音色';
                    voiceInfo = `🎭 多音色对比 (${item.voices?.length || 0}个)<br><span style="font-size: 0.7rem; opacity: 0.8;">音色: ${voicesList}</span>`;
                } else {
                    voiceInfo = `音色: ${item.voice}`;
                }
                
                return `
                    <div class="history-item">
                        <div class="item-text">${item.text.substring(0, 100)}${item.text.length > 100 ? '...' : ''}</div>
                        <div class="item-meta">${voiceInfo} · ${item.timestamp}</div>
                        <div class="item-actions">
                            <button class="btn-small" onclick="applyHistory(${item.id})">应用</button>
                            <button class="btn-small" onclick="deleteHistory(${item.id})">删除</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderDeleted() {
            const container = document.getElementById('historyContent');
            if (!state.deletedHistory || state.deletedHistory.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">暂无已删除记录</p>';
                return;
            }
            container.innerHTML = state.deletedHistory.map(item => {
                const isMulti = item.type === 'multi';
                let voiceInfo = '';
                
                if (isMulti) {
                    const voicesList = item.voices && item.voices.length > 0 
                        ? item.voices.join(', ') 
                        : '多个音色';
                    voiceInfo = `🎭 多音色对比 (${item.voices?.length || 0}个)<br><span style="font-size: 0.7rem; opacity: 0.8;">音色: ${voicesList}</span>`;
                } else {
                    voiceInfo = `音色: ${item.voice}`;
                }
                
                return `
                    <div class="history-item">
                        <div class="item-text">${item.text.substring(0, 100)}${item.text.length > 100 ? '...' : ''}</div>
                        <div class="item-meta">${voiceInfo} · ${item.timestamp}</div>
                        <div class="item-actions">
                            <button class="btn-small" onclick="restoreDeleted(${item.id})">恢复</button>
                            <button class="btn-small" onclick="purgeDeleted(${item.id})">彻底删除</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function applyHistory(id) {
            const item = state.history.find(h => h.id === id);
            if (!item) return;
            
            document.getElementById('textInput').value = item.text;
            
            if (item.type === 'multi' && item.voices && item.voices.length > 0) {
                // 多音色对比记录 - 只应用状态，不自动生成
                // 进入多选模式
                if (!state.multiSelectMode) {
                    toggleMultiVoiceMode();
                }
                
                // 清空现有选择
                state.selectedVoices.clear();
                document.querySelectorAll('.voice-checkbox').forEach(cb => cb.checked = false);
                
                // 勾选历史记录中的音色
                item.voices.forEach(voice => {
                    const checkbox = document.querySelector(`.voice-checkbox[data-voice="${voice}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                        state.selectedVoices.add(voice);
                    }
                });
                updateMultiCount();
                
                showToast(`已应用：${item.voices.length} 个音色已勾选，点击"✓ 开始对比生成"按钮即可生成`, 'success');
            } else {
                // 单音色记录
                selectVoice(item.voice);
                showToast('已应用历史记录', 'success');
            }
        }
        
        function deleteHistory(id) {
            const idx = state.history.findIndex(h => h.id === id);
            if (idx !== -1) {
                lastDeletedHistoryItem = state.history[idx];
                state.history.splice(idx, 1);
                // 推入已删除
                state.deletedHistory.unshift(lastDeletedHistoryItem);
                localStorage.setItem('history', JSON.stringify(state.history));
                localStorage.setItem('deletedHistory', JSON.stringify(state.deletedHistory));
                renderHistory();
                showToastAction('已删除', '撤销', () => {
                    if (lastDeletedHistoryItem) {
                        // 从已删除移除，回到历史
                        state.deletedHistory = state.deletedHistory.filter(i => i.id !== lastDeletedHistoryItem.id);
                        state.history.unshift(lastDeletedHistoryItem);
                        localStorage.setItem('history', JSON.stringify(state.history));
                        localStorage.setItem('deletedHistory', JSON.stringify(state.deletedHistory));
                        renderHistory();
                        lastDeletedHistoryItem = null;
                    }
                }, 'success');
            }
        }

        function restoreDeleted(id) {
            const idx = state.deletedHistory.findIndex(h => h.id === id);
            if (idx !== -1) {
                const item = state.deletedHistory[idx];
                state.deletedHistory.splice(idx, 1);
                state.history.unshift(item);
                localStorage.setItem('history', JSON.stringify(state.history));
                localStorage.setItem('deletedHistory', JSON.stringify(state.deletedHistory));
                renderDeleted();
            }
        }

        function purgeDeleted(id) {
            state.deletedHistory = state.deletedHistory.filter(h => h.id !== id);
            localStorage.setItem('deletedHistory', JSON.stringify(state.deletedHistory));
            renderDeleted();
        }
        
        // ========== 收藏功能 ==========
        function openSaveFavoriteModal() {
            const text = document.getElementById('textInput').value.trim();
            if (!text) {
                showToast('请先输入文本', 'error');
                return;
            }
            
            document.getElementById('saveFavoriteModal').classList.add('active');
            document.getElementById('favoriteName').value = '';
            document.getElementById('favoriteName').focus();
        }
        
        function saveFavorite() {
            const name = document.getElementById('favoriteName').value.trim();
            const text = document.getElementById('textInput').value.trim();
            
            if (!name) {
                showToast('请输入收藏名称', 'error');
                return;
            }
            
            const item = {
                id: Date.now(),
                name,
                text,
                voice: state.selectedVoice,
                timestamp: new Date().toLocaleString('zh-CN')
            };
            
            state.favorites.unshift(item);
            localStorage.setItem('favorites', JSON.stringify(state.favorites));
            renderFavorites();
            
            document.getElementById('saveFavoriteModal').classList.remove('active');
            showToast('保存成功！', 'success');
        }
        
        function renderFavorites() {
            const container = document.getElementById('favoritesContent');
            
            if (state.favorites.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">暂无收藏</p>';
                return;
            }
            
            container.innerHTML = state.favorites.map(item => `
                <div class="favorite-item">
                    <div style="font-weight: 600; margin-bottom: 0.5rem;">${item.name}</div>
                    <div class="item-text">${item.text}</div>
                    <div class="item-meta">音色: ${item.voice}</div>
                    <div class="item-actions">
                        <button class="btn-small" onclick="applyFavorite(${item.id})">应用</button>
                        <button class="btn-small" onclick="deleteFavorite(${item.id})">删除</button>
                    </div>
                </div>
            `).join('');
        }
        
        function applyFavorite(id) {
            const item = state.favorites.find(f => f.id === id);
            if (item) {
                document.getElementById('textInput').value = item.text;
                selectVoice(item.voice);
                showToast('已应用收藏配置', 'success');
            }
        }
        
        function deleteFavorite(id) {
            state.favorites = state.favorites.filter(f => f.id !== id);
            localStorage.setItem('favorites', JSON.stringify(state.favorites));
            renderFavorites();
            showToast('已删除', 'success');
        }
        
        // ========== 设置 ==========
        function loadSettings() {
            document.getElementById('apiKey').value = state.apiKey;
            document.getElementById('apiBaseUrl').value = state.apiBaseUrl;
            document.getElementById('modelSelect').value = state.model;
        }
        
        function saveSettings() {
            state.apiKey = document.getElementById('apiKey').value.trim();
            state.apiBaseUrl = document.getElementById('apiBaseUrl').value.trim();
            state.model = document.getElementById('modelSelect').value;
            
            localStorage.setItem('apiKey', state.apiKey);
            localStorage.setItem('apiBaseUrl', state.apiBaseUrl);
            localStorage.setItem('model', state.model);
            
            document.getElementById('settingsModal').classList.remove('active');
            showToast('设置已保存', 'success');
        }
        
        // ========== 工具函数 ==========
        function updateCharCount() {
            const text = document.getElementById('textInput').value;
            const count = text.length;
            document.getElementById('charCount').textContent = `${count} 字符`;
            
            if (count > 0) {
                const estimatedSeconds = Math.ceil(count / 10);
                document.getElementById('estimatedTime').textContent = `预计 ${estimatedSeconds} 秒`;
            } else {
                document.getElementById('estimatedTime').textContent = '';
            }
        }
        
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const content = document.createElement('span');
            content.textContent = message;
            const close = document.createElement('button');
            close.className = 'close';
            close.textContent = '✕';
            close.addEventListener('click', () => toast.remove());
            toast.appendChild(content);
            toast.appendChild(close);
            container.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.style.animation = 'slideIn 0.3s reverse';
                    setTimeout(() => toast.remove(), 300);
                }
            }, 3000);
        }

        function showToastAction(message, actionText, actionFn, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const content = document.createElement('span');
            content.textContent = message;
            const actionBtn = document.createElement('button');
            actionBtn.className = 'close';
            actionBtn.textContent = actionText;
            actionBtn.style.fontWeight = '600';
            actionBtn.style.color = 'var(--primary-terracotta)';
            actionBtn.addEventListener('click', () => { actionFn(); toast.remove(); });
            const close = document.createElement('button');
            close.className = 'close';
            close.textContent = '✕';
            close.addEventListener('click', () => toast.remove());
            toast.appendChild(content);
            toast.appendChild(actionBtn);
            toast.appendChild(close);
            container.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.style.animation = 'slideIn 0.3s reverse';
                    setTimeout(() => toast.remove(), 300);
                }
            }, 4000);
        }
        
        // 更新缓存状态显示
        function updateCacheStatus() {
            const cacheEl = document.getElementById('cacheStatus');
            if (!cacheEl) return;
            
            const audioCount = (state.singleVoiceAudio ? 1 : 0) + 
                               (state.compareResults?.length || 0) + 
                               (previewAudioUrl ? 1 : 0);
            
            cacheEl.textContent = `${audioCount} 个音频`;
            
            // 更新清理按钮状态
            const clearBtn = document.getElementById('clearCacheBtn');
            if (clearBtn) {
                clearBtn.disabled = audioCount === 0;
                clearBtn.textContent = audioCount > 0 ? `🗑️ 清理音频缓存 (${audioCount})` : '🗑️ 清理音频缓存';
            }
        }
        
        // 清理所有音频资源
        function cleanupAudioResources() {
            // 清理当前播放的音频引用
            if (state.currentAudio) {
                state.currentAudio = null;
            }
            
            // 清理单音色音频
            if (state.singleVoiceAudio) {
                URL.revokeObjectURL(state.singleVoiceAudio);
                state.singleVoiceAudio = null;
            }
            
            // 清理对比音频
            if (state.compareResults && state.compareResults.length > 0) {
                state.compareResults.forEach(item => {
                    if (item.audioUrl) {
                        URL.revokeObjectURL(item.audioUrl);
                    }
                });
                state.compareResults = [];
                state.currentCompareIndex = -1;
                updateCompareToggleBtn();
                updateComparePosition();
            }
            
            // 清理试听音频
            if (previewAudioUrl) {
                URL.revokeObjectURL(previewAudioUrl);
                previewAudioUrl = null;
            }
            
            // 恢复空状态
            const player = document.getElementById('audioPlayer');
            const playlist = document.getElementById('comparePlaylist');
            if (player) {
                player.classList.remove('has-content');
                player.classList.remove('has-playlist');
            }
            if (playlist) {
                playlist.classList.remove('active');
            }
            
            updateCacheStatus();
        }
        
        // 页面关闭前清理
        window.addEventListener('beforeunload', cleanupAudioResources);
    </script>
</body>
</html>
